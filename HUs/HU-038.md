# HU-038 — Modo oscuro global en la web

**Como** usuario de la web  
**Quiero** activar o desactivar el modo oscuro  
**Para** mejorar la comodidad visual en entornos de baja luz y personalizar la experiencia

---

## Dependencias

- HU-001 (Next.js App Router)
- HU-005 (MUI configurado)
- HU-007 (Tailwind configurado)
- HU-008 (Design System centralizado)
- HU-016 (Sistema de traducciones configurado)

---

## Contexto / Notas

- Los diseños HTML de referencia ya incluyen clases `dark:` y `darkMode: "class"` en Tailwind; se debe respetar ese enfoque.
- No existe un campo en `profiles` para persistir preferencia de tema; **no** se debe modificar BD ni Supabase para esta HU.
- La preferencia de tema debe persistir en cliente (Redux Persist/localStorage) y sobrevivir recargas.
- Si no hay preferencia guardada, se debe respetar `prefers-color-scheme`.
- No hay un diseño explícito del toggle de tema; usar un botón discreto (icono sol/luna) alineado al Design System y dejar esta decisión documentada aquí.

---

## Diseño (OBLIGATORIO si hay UI)

Referencias:
- Diseño: `docs/design/code_home_screen.html`
- Diseño: `docs/design/add_animals_code.html`
- Design System: `docs/design/system.md`

Reglas:
- Respetar jerarquía visual del diseño.
- Usar tokens definidos en el Design System (no inventar tamaños/colores).
- Si algo no es claro en el diseño, preguntar antes de asumir.

---
---

## Reglas técnicas

- Arquitectura: ver `docs/01_arquitectura.md`
- Reglas Codex: ver `docs/02_reglas_de_codex.md`

## Alcance

Incluye:
- Activación global de modo oscuro con clase `dark` en `<html>` o `<body>`.
- Configurar Tailwind para `darkMode: "class"` si aún no está definido.
- Extender el theme de MUI para soportar modo `dark` usando tokens del Design System.
- Toggle de tema visible en el navbar principal (desktop) y accesible en el menú móvil.
- Persistencia del modo elegido en cliente y restauración al recargar.
- Textos/labels accesibles del toggle traducidos ES/EN con `next-intl`.

No incluye:
- Persistencia en Supabase o cambios de esquema en BD.
- Nuevos tokens de color o rediseño de pantallas.
- Cambios funcionales fuera del cambio visual de tema.

---

## Criterios de aceptación (Given / When / Then)

### 1) Preferencia inicial por sistema
- **Dado** un usuario sin preferencia guardada
- **Cuando** visita la web
- **Entonces** el tema inicial respeta `prefers-color-scheme`
- **Y** se aplica correctamente el modo `dark` o `light` en UI

### 2) Toggle de tema y persistencia
- **Dado** el botón de cambio de tema visible
- **Cuando** el usuario alterna entre claro y oscuro
- **Entonces** la UI cambia inmediatamente de modo
- **Y** la preferencia se mantiene al recargar la página

### 3) Consistencia visual con tokens
- **Dado** pantallas construidas con MUI y Tailwind
- **Cuando** el modo oscuro está activo
- **Entonces** los fondos y textos usan tokens `neutral-*`, `brand-*`, `accent-*`
- **Y** no hay colores hardcodeados fuera del Design System

### 4) Traducciones del toggle
- **Dado** que el toggle tiene textos o labels accesibles
- **Cuando** reviso la UI
- **Entonces** los textos provienen de `useTranslations`
- **Y** existen keys en `src/messages/es/common.json` y `src/messages/en/common.json`

---

## Reglas técnicas

### Arquitectura
- Presentation maneja el estado de tema (hook/estado local o store), sin tocar Domain.
- No acceder a Supabase para esta preferencia.
- Evitar lógica de negocio en UI; esto es solo estado visual.

### UI (si aplica)
- UI con MUI.
- Tailwind se usa para layout/spacing/responsive utilities (si está habilitado).
- No agregar librerías de estilos adicionales.
- Aplicar modo oscuro con clase `dark` y tokens del Design System.

### Traducciones (OBLIGATORIO si hay UI con texto)
- **TODOS los textos visibles en la UI deben estar traducidos** (español e inglés).
- Usar el sistema de traducciones configurado en HU-016 (`next-intl`).
- Agregar traducciones en:
  - `src/messages/es/common.json` (español)
  - `src/messages/en/common.json` (inglés)
- Usar `useTranslations("common")` para labels del toggle.

### Dependencias / Paquetes
- No agregar dependencias nuevas.

---

## Implementación sugerida (opcional)

- `tailwind.config.ts`: agregar `darkMode: "class"` si no existe.
- `src/presentation/theme/theme.ts`: crear theme dinámico por modo (light/dark) usando tokens existentes.
- `src/presentation/providers/MuiProvider.tsx`: aceptar `mode` y pasar theme correspondiente a `ThemeProvider`.
- `src/presentation/components/molecules/ThemeToggle.tsx`: botón icono sol/luna con `aria-label` traducida.
- `src/presentation/components/organisms/NavBar/HomeNavBar.tsx`: incluir el toggle en la barra y en el drawer móvil.
- `src/app/layout.tsx`: aplicar clase `dark` en `<html>` según preferencia del usuario.

---

## Validación

Comandos mínimos:
- `npm run dev`
- `npm run build`

Verificaciones:
- El toggle cambia el tema en pantalla sin recargar.
- La preferencia persiste tras refresh.
- No hay colores hardcodeados fuera de tokens.
- Traducciones completas (ES/EN).

---

## Definición de Hecho

- [ ] Criterios de aceptación cumplidos
- [ ] `npm run dev` OK
- [ ] `npm run build` OK
- [ ] Sin violaciones de capas
- [ ] Sin cambios fuera del alcance
- [ ] **Traducciones incluidas** (si aplica UI con texto):
  - [ ] Textos agregados en `src/messages/es/common.json`
  - [ ] Textos agregados en `src/messages/en/common.json`
  - [ ] Componentes usan `useTranslations` (no textos hardcodeados)
  - [ ] Keys consistentes entre idiomas
- Commit sugerido:
  `feat: add dark mode support`
