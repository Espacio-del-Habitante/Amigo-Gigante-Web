# HU-038 — Modo dark en la web

**Como** usuario de la web  
**Quiero** activar y guardar un modo oscuro en toda la interfaz  
**Para** navegar con mayor comodidad visual en entornos de baja luz

---

## Dependencias

- HU-001 (Next.js App Router)
- HU-007 (Tailwind configurado)
- HU-010 (Atomic Design - componentes reutilizables)
- HU-016 (Sistema de traducciones configurado)

---

## Contexto / Notas

- Alcance global: aplica a rutas públicas y privadas de la web.
- Activación: toggle manual; en la primera carga, respetar `prefers-color-scheme` si no hay preferencia guardada.
- Persistencia: guardar preferencia en `localStorage` (clave sugerida: `ag.theme`).
- No hay diseños específicos de dark; usar tokens del Design System y mantener contraste adecuado.
- UI con MUI + Tailwind; no agregar dependencias nuevas.
- Sin cambios en base de datos.

---

## Diseño (OBLIGATORIO si hay UI)

Referencias:
- Diseño base de UI: `docs/design/add_animals_screen.png`
- Código de referencia: `docs/design/add_animals_code.html`
- Design System: `docs/design/system.md`

Reglas:
- Respetar jerarquía visual existente.
- Usar tokens definidos en el Design System (no inventar colores).
- Mantener contraste y legibilidad en modo dark.
- Si algo no es claro en el diseño, registrar la decisión en “Contexto / Notas”.

---
---

## Reglas técnicas

- Arquitectura: ver `docs/01_arquitectura.md`
- Reglas Codex: ver `docs/02_reglas_de_codex.md`

## Alcance

Incluye:
- Modo dark aplicado a toda la web (layout global y páginas internas).
- Toggle accesible desde el layout principal para alternar light/dark.
- Lectura de preferencia del sistema en la primera carga si no existe preferencia guardada.
- Persistencia en `localStorage` y rehidratación al cargar.
- Adaptación de tema MUI (`palette.mode`) y uso de clase `dark` en Tailwind.
- Estados de hover/focus/texto con contraste adecuado en dark.

No incluye:
- Tema automático por horario o geolocalización.
- Preferencia guardada en backend/perfil de usuario.
- Rediseño visual completo o nuevos tokens fuera del Design System.

---

## Criterios de aceptación (Given / When / Then)

### 1) Preferencia del sistema en primera carga

- **Dado** que no existe preferencia guardada en `localStorage`
- **Cuando** el usuario carga la web por primera vez
- **Entonces** el tema respeta `prefers-color-scheme` (light/dark)

### 2) Toggle manual

- **Dado** la web cargada
- **Cuando** el usuario acciona el toggle de tema
- **Entonces** la UI alterna entre light y dark en toda la web

### 3) Persistencia de preferencia

- **Dado** que el usuario eligió un tema
- **Cuando** recarga o vuelve a entrar al sitio
- **Entonces** el tema se mantiene según `localStorage`, sin sobreescribir por el sistema

### 4) Alcance global y contraste

- **Dado** cualquier ruta pública o privada
- **Cuando** el tema está en dark
- **Entonces** fondos, textos y componentes mantienen contraste y usan tokens del Design System

### 5) Traducciones

- **Dado** el toggle y sus textos visibles
- **Cuando** se revisa la UI
- **Entonces** no hay textos hardcodeados y existen keys en `src/messages/es/common.json` y `src/messages/en/common.json`

---

## Reglas técnicas

### Arquitectura
- Presentation maneja el estado del tema y el toggle.
- Si se crea un adapter de storage, debe vivir en Infrastructure (localStorage).
- Domain no depende de UI ni de infraestructura.

### UI (si aplica)
- UI con MUI + Tailwind (sin nuevas librerías).
- `ThemeProvider` debe derivar el theme desde el modo actual (light/dark).
- Tailwind usa modo `class` con la clase `dark` en `html` o `body`.
- Colores solo desde tokens `brand`, `accent`, `neutral`.
- Mantener contraste y legibilidad en light/dark.

### Traducciones (OBLIGATORIO si hay UI con texto)
- Usar `useTranslations('common')` para el toggle.
- Agregar keys en:
  - `src/messages/es/common.json`
  - `src/messages/en/common.json`
- Keys sugeridas: `theme.toggle`, `theme.light`, `theme.dark`.

### Dependencias / Paquetes
- No agregar dependencias nuevas.

---

## Implementación sugerida (opcional)

- Archivos/carpetas sugeridas:
  - `src/presentation/providers/MuiProvider.tsx` (modo dinámico)
  - `src/presentation/theme/theme.ts` (crear theme por modo)
  - `src/presentation/hooks/useThemeMode.ts` (preferencia + localStorage)
  - `src/presentation/components/atoms/ThemeToggle/ThemeToggle.tsx`
  - `src/app/layout.tsx` (aplicar clase `dark` global)

---

## Validación

Comandos mínimos:
- `npm run dev`
- `npm run build`

(Agregar tests si aplica)

---

## Definición de Hecho

- [ ] Criterios de aceptación cumplidos
- [ ] `npm run dev` OK
- [ ] `npm run build` OK
- [ ] Sin violaciones de capas
- [ ] Sin cambios fuera del alcance
- [ ] **Traducciones incluidas** (si aplica UI con texto):
  - [ ] Textos agregados en `src/messages/es/common.json`
  - [ ] Textos agregados en `src/messages/en/common.json`
  - [ ] Componentes usan `useTranslations` (no textos hardcodeados)
  - [ ] Keys consistentes entre idiomas
- Commit sugerido:
  `feat: add dark mode toggle`
