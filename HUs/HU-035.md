# HU-035 — Detalle de Producto + Carrito de Compras (UI + Supabase)

**Como** usuario externo  
**Quiero** ver el detalle de un producto y gestionar un carrito de compras  
**Para** comprar productos de fundaciones con una experiencia completa

---

## Dependencias

- HU-001 (Next.js App Router)
- HU-007 (Tailwind configurado)
- HU-010 (Atomic Design - componentes reutilizables)
- HU-011 (Conexión a Supabase configurada)
- HU-016 (Sistema de traducciones configurado)
- HU-028 (Tienda Solidaria implementada)

---

## Contexto / Notas

- Esta HU implementa el **detalle de producto** y el **carrito de compras**.
- La UI debe seguir los diseños:
  - `docs/design/info_shop_screen.png` + `docs/design/info_shop_code.html`
  - `docs/design/car_shop_screen.png` + `docs/design/car_shop_code.html`
- Las rutas sugeridas:
  - Detalle: `/shop/[id]` (o `app/[locale]/shop/[id]/page.tsx`)
  - Carrito: `/shop/cart` (o `app/[locale]/shop/cart/page.tsx`)
- La data proviene de Supabase según `docs/scripts/db.sql`:
  - `products` + `foundations`
- **No existen** categorías, stock, variantes, reseñas, descuentos ni tamaños en BD.
  - Esos elementos del diseño se **ocultan o muestran como UI estática sin datos** cuando corresponda.
  - **No se inventan datos**.
- El carrito **no tiene tabla en BD**:
  - Se implementa como estado persistente en cliente (ej. localStorage).
  - El **detalle y precios** siempre se consultan desde Supabase usando los `product_id` del carrito.

Modelo de datos disponible:
- `products`: `id`, `foundation_id`, `name`, `description`, `price`, `image_url`, `is_published`, `created_at`
- `foundations`: `id`, `name`, `logo_url`, `city`, `country`

---

## Diseño (OBLIGATORIO)

Referencias:
- Detalle: `docs/design/info_shop_code.html`
- Carrito: `docs/design/car_shop_code.html`
- Imágenes: `docs/design/info_shop_screen.png`, `docs/design/car_shop_screen.png`
- Design System: `docs/design/system.md`
- Esquema BD: `docs/scripts/db.sql`

Reglas de UI:
- Respetar jerarquía visual y estilos (sombras, bordes, badges).
- Layout responsive.
- Navbar con indicador de carrito (cantidad de ítems).
- No mostrar reseñas/ratings ni descuento si no existen en BD.

---

## Alcance

Incluye:
- Crear ruta de detalle `/shop/[id]`
- Crear ruta de carrito `/shop/cart`
- Obtener producto por `id` desde Supabase
- Obtener información de fundación del producto
- Mostrar imagen, nombre, descripción y precio formateado
- CTA “Agregar al carrito” funcional
- Carrito persistente en cliente con:
  - Lista de ítems (producto + cantidad)
  - Cambiar cantidad y eliminar ítems
  - Subtotal y total
  - Resumen de compra (diseño)
- Indicador de cantidad de items en navbar
- Productos relacionados (misma fundación, publicados)
- Estados de loading y error
- Traducciones completas (ES/EN)

No incluye:
- Pago real
- Stock / inventario
- Variantes (talla/color)
- Cupones/descuentos reales
- Favoritos reales
- Tests automatizados

---

## Criterios de aceptación (Given / When / Then)

### 1) Ruta de detalle creada
- **Dado** un producto publicado
- **Cuando** navego a `/shop/[id]`
- **Entonces** veo la página de detalle con diseño correcto

### 2) Datos del producto
- **Dado** un producto en Supabase
- **Cuando** carga el detalle
- **Entonces** se muestran nombre, descripción, precio e imagen
- **Y** solo si `is_published = true`

### 3) Fundación visible
- **Dado** el producto con `foundation_id`
- **Cuando** se renderiza el detalle
- **Entonces** se muestra nombre, logo y ubicación de la fundación

### 4) Agregar al carrito
- **Dado** un producto en detalle
- **Cuando** hago clic en “Agregar al carrito”
- **Entonces** se agrega al carrito con cantidad 1 o se incrementa

### 5) Carrito persistente
- **Dado** items en el carrito
- **Cuando** recargo la página
- **Entonces** el carrito mantiene los productos y cantidades

### 6) Cantidades y eliminación
- **Dado** el carrito con items
- **Cuando** incremento o decremento cantidades
- **Entonces** el subtotal y total se actualizan
- **Y** si la cantidad llega a 0, el item se elimina

### 7) Resumen de compra
- **Dado** items en el carrito
- **Cuando** se muestra el resumen
- **Entonces** el total corresponde a la suma de `price * quantity`
- **Y** el texto de envío muestra “Por acordar”

### 8) Productos relacionados
- **Dado** un producto de una fundación
- **Cuando** carga el detalle
- **Entonces** se muestran productos publicados de la misma fundación
- **Y** no se incluye el producto actual

### 9) Estado de loading
- **Dado** que se consulta Supabase
- **Cuando** carga detalle o carrito
- **Entonces** se muestra un estado de loading

### 10) Manejo de errores
- **Dado** un error de Supabase
- **Cuando** falla la consulta
- **Entonces** se muestra un mensaje traducido
- **Y** la UI no se rompe

### 11) Traducciones
- **Dado** la implementación
- **Cuando** se revisa la UI
- **Entonces** no hay textos hardcodeados
- **Y** existen traducciones en `src/messages/es/shop-detail.json` y `src/messages/en/shop-detail.json`

---

## Reglas técnicas

### Arquitectura
- Presentation solo consume UseCases vía IoC.
- Domain no importa React/Next/MUI/Tailwind/Inversify/Supabase.
- Infrastructure contiene implementaciones y wiring IoC.
- Supabase solo vive en Infrastructure.

### Supabase / Queries
- Detalle de producto:
  - `SELECT * FROM products WHERE id = :id AND is_published = true`
- Fundación:
  - `SELECT id, name, city, country, logo_url FROM foundations WHERE id = :foundation_id`
- Relacionados:
  - `SELECT * FROM products WHERE foundation_id = :foundation_id AND is_published = true AND id != :id LIMIT 4`

### Carrito
- Persistencia en cliente (localStorage).
- El render del carrito **siempre** consulta detalles en Supabase usando los `product_id`.

### Traducciones
- Usar `useTranslations('shopDetail')`.
- No hardcodear textos.

### Dependencias / Paquetes
- No agregar dependencias nuevas.

---

## Implementación sugerida

### Estructura de archivos sugerida:
```
src/app/[locale]/shop/[id]/page.tsx
src/app/[locale]/shop/cart/page.tsx

src/presentation/components/shop-detail/
├── ShopDetailPage.tsx
├── ShopBreadcrumbs.tsx
├── ShopGallery.tsx
├── ShopInfoPanel.tsx
├── ShopRelatedGrid.tsx

src/presentation/components/cart/
├── CartPage.tsx
├── CartItemRow.tsx
├── CartSummary.tsx

src/domain/
├── models/
│   ├── ShopProduct.ts
│   └── CartItem.ts
├── repositories/
│   ├── IProductRepository.ts (extender con getProductDetail y getRelatedProducts)
│   └── IFoundationRepository.ts (extender con getFoundationById)
└── usecases/
    └── shop/
        ├── GetProductDetailUseCase.ts
        └── GetRelatedProductsUseCase.ts

src/infrastructure/
├── repositories/
│   ├── ProductRepository.ts
│   └── FoundationRepository.ts
└── ioc/
    └── bindings actualizados

src/messages/
├── es/
│   └── shop-detail.json
└── en/
    └── shop-detail.json
```

---

## Validación

Comandos mínimos:
- `npm run dev`
- `npm run build`

Verificaciones:
- Detalle y carrito se ven como el diseño
- Datos reales desde Supabase
- Carrito mantiene items y cantidades
- Total calculado correctamente
- Traducciones completas

---

## Definición de Hecho

- [ ] Criterios de aceptación cumplidos
- [ ] `npm run dev` OK
- [ ] `npm run build` OK
- [ ] Detalle y carrito funcionales
- [ ] Datos reales desde Supabase
- [ ] Traducciones incluidas (ES/EN)
- [ ] Sin violaciones de capas
- [ ] Sin cambios fuera del alcance
- Commit sugerido:
  `feat: add shop product detail and cart`

