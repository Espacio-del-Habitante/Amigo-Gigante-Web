# HU-041 — Menú de cuenta para usuario externo

**Como** usuario externo autenticado  
**Quiero** ver un botón "Cuenta" en lugar de "Iniciar sesión" con un menú desplegable  
**Para** poder acceder a opciones de mi cuenta como cerrar sesión y editar perfil

---

## Dependencias

- HU-001 (Next.js App Router)
- HU-013 (Estrategia de roles y protección de rutas definida)
- HU-016 (Sistema de traducciones configurado)
- HU-020 (Login implementado)
- HU-040 (Registro de usuario externo implementado)
- Hook `useAuth` configurado y funcionando

---

## Contexto / Notas

- Esta HU modifica el `HomeNavBar` para mostrar un menú de cuenta cuando el usuario externo está autenticado.
- El botón "Iniciar sesión" debe cambiar a "Cuenta" cuando `isAuthenticated === true` y `role === 'external'`.
- El menú debe ser pequeño y discreto, mostrando opciones básicas:
  - Cerrar sesión
  - Editar cuenta (navegar a página de edición, será otra HU)
- El menú debe abrirse al hacer clic en el botón "Cuenta".
- El menú debe cerrarse al hacer clic fuera o al seleccionar una opción.
- Para usuarios `foundation_user` o `admin`, el comportamiento actual se mantiene (redirigir a dashboard).
- La opción "Editar cuenta" será implementada en otra HU, pero debe estar presente en el menú.

---

## Diseño (OBLIGATORIO si hay UI)

Referencias:
- Diseño: `docs/design/system.md`
- Componente existente: `src/presentation/components/organisms/NavBar/HomeNavBar.tsx`

Reglas:
- El botón "Cuenta" debe tener el mismo estilo que el botón "Iniciar sesión" actual.
- El menú desplegable debe ser discreto y pequeño (no ocupar mucho espacio).
- El menú debe usar componentes de MUI (Menu, MenuItem, Divider).
- El menú debe mostrar:
  - Email del usuario (opcional, como información)
  - Divider
  - "Editar cuenta" (navegar a página de edición)
  - "Cerrar sesión" (cerrar sesión y redirigir a home)
- El menú debe tener animación suave al abrir/cerrar.
- El menú debe ser responsive (funcionar en móvil y desktop).

---

## Reglas técnicas

- Arquitectura: ver `docs/01_arquitectura.md`
- Reglas Codex: ver `docs/02_reglas_de_codex.md`

## Alcance

Incluye:
- Modificar `HomeNavBar` para detectar usuario externo autenticado
- Cambiar texto del botón de "Iniciar sesión" a "Cuenta" cuando `role === 'external'` y `isAuthenticated === true`
- Crear componente de menú desplegable (usando MUI Menu)
- Implementar opción "Cerrar sesión" (llamar a UseCase de logout)
- Implementar opción "Editar cuenta" (navegar a página de edición, será otra HU)
- Mostrar email del usuario en el menú (opcional)
- Manejar estado de apertura/cierre del menú
- Integrar el menú en el drawer móvil también

No incluye:
- Implementación de la página de edición de cuenta (otra HU)
- Cambios en el comportamiento para usuarios `foundation_user` o `admin`
- Cambios en otros headers (FoundationHeader, LoginHeader, etc.)
- Notificaciones para usuarios externos
- Perfil completo de usuario externo

---

## Criterios de aceptación (Given / When / Then)

### 1) Detección de usuario externo autenticado

- **Dado** que el usuario externo está autenticado
- **Cuando** se carga el `HomeNavBar`
- **Entonces** el hook `useAuth` retorna `isAuthenticated === true` y `role === 'external'`
- **Y** el botón muestra "Cuenta" en lugar de "Iniciar sesión"
- **Y** el botón no redirige al dashboard (a diferencia de otros roles)

### 2) Menú desplegable implementado

- **Dado** que el usuario externo está autenticado
- **Cuando** hace clic en el botón "Cuenta"
- **Entonces** se abre un menú desplegable pequeño y discreto
- **Y** el menú muestra las opciones: "Editar cuenta" y "Cerrar sesión"
- **Y** el menú muestra el email del usuario (opcional, como información)
- **Y** el menú usa componentes de MUI (Menu, MenuItem)
- **Y** el menú tiene animación suave al abrir/cerrar

### 3) Cerrar menú

- **Dado** que el menú está abierto
- **Cuando** el usuario hace clic fuera del menú
- **Entonces** el menú se cierra
- **Y** cuando el usuario selecciona una opción del menú
- **Entonces** el menú se cierra automáticamente

### 4) Opción "Cerrar sesión"

- **Dado** que el menú está abierto
- **Cuando** el usuario hace clic en "Cerrar sesión"
- **Entonces** se llama al UseCase de logout (o método de `useAuth`)
- **Y** la sesión se cierra correctamente
- **Y** el usuario es redirigido a home (`/` o `/[locale]`)
- **Y** el botón vuelve a mostrar "Iniciar sesión"
- **Y** el menú ya no está disponible

### 5) Opción "Editar cuenta"

- **Dado** que el menú está abierto
- **Cuando** el usuario hace clic en "Editar cuenta"
- **Entonces** se navega a la página de edición de cuenta (ej: `/[locale]/account/edit`)
- **Y** el menú se cierra automáticamente
- **Nota**: La página de edición será implementada en otra HU, pero la navegación debe funcionar

### 6) Comportamiento para otros roles

- **Dado** que el usuario es `foundation_user` o `admin`
- **Cuando** se carga el `HomeNavBar`
- **Entonces** el botón muestra "Ir al Dashboard" (o texto similar)
- **Y** el botón redirige al dashboard correspondiente
- **Y** NO se muestra el menú de cuenta (comportamiento actual se mantiene)

### 7) Responsive (móvil y desktop)

- **Dado** que el usuario externo está autenticado
- **Cuando** se visualiza en desktop
- **Entonces** el botón "Cuenta" está visible en el header principal
- **Y** el menú funciona correctamente
- **Cuando** se visualiza en móvil
- **Entonces** el botón "Cuenta" está visible en el drawer móvil
- **Y** el menú funciona correctamente en el drawer
- **Y** el drawer se cierra al seleccionar una opción

### 8) Traducciones

- **Dado** que la aplicación soporta ES/EN
- **Cuando** se muestra el menú de cuenta
- **Entonces** todos los textos están traducidos:
  - "Cuenta" / "Account"
  - "Editar cuenta" / "Edit Account"
  - "Cerrar sesión" / "Logout"
- **Y** los textos están en `src/messages/es/common.json` y `src/messages/en/common.json`
- **Y** se usa `useTranslations` para acceder a traducciones

---

## Reglas técnicas

### Arquitectura
- Presentation solo consume UseCases vía IoC (no importa repositorios concretos).
- Domain no importa React/Next/MUI/Tailwind/Inversify.
- Infrastructure contiene implementaciones y wiring IoC.
- El menú debe estar en el componente `HomeNavBar` (Presentation).

### UI
- UI con MUI (Menu, MenuItem, Divider, Avatar opcional).
- Tailwind se usa para layout/spacing/responsive utilities.
- El menú debe usar `Menu` de MUI con `anchorEl` para posicionamiento.
- El botón debe mantener el mismo estilo que el botón "Iniciar sesión" actual.

### Lógica de logout
- Usar el UseCase de logout existente o crear uno si no existe.
- El logout debe limpiar la sesión en Supabase.
- El logout debe redirigir a home.
- El hook `useAuth` debe actualizarse después del logout.

### Navegación
- Usar `next/link` para navegación a "Editar cuenta".
- Preservar el locale en la navegación (ej: `/es/account/edit`).
- La ruta de edición puede ser `/[locale]/account/edit` o similar (definir según convención del proyecto).

### Traducciones (OBLIGATORIO si hay UI con texto)
- **TODOS los textos visibles en la UI deben estar traducidos** (español e inglés).
- Usar el sistema de traducciones configurado en HU-016 (`next-intl`).
- Agregar traducciones en:
  - `src/messages/es/common.json` (español)
  - `src/messages/en/common.json` (inglés)
- Keys sugeridas:
  - `account.menu.title` (opcional, para el email)
  - `account.menu.editAccount`
  - `account.menu.logout`
  - `buttons.account` (para el botón "Cuenta")
- Usar `useTranslations("common")` o `useTranslations("account")` para acceder a traducciones.

### Dependencias / Paquetes
- No agregar dependencias nuevas salvo que esta HU lo indique explícitamente.
- Usar MUI Menu que ya está disponible.
- Si aparece error 403/conectividad:
  1) Detenerse
  2) Pedir dominios requeridos
  3) Explicar por qué se requieren
  4) No continuar

---

## Implementación sugerida (opcional)

### Estructura de archivos sugerida:

```
src/presentation/
└── components/
    └── organisms/
        └── NavBar/
            └── HomeNavBar.tsx (modificar)
    └── molecules/
        └── AccountMenu.tsx (nuevo, opcional si se quiere separar)
```

### Flujo de implementación:

1. **Modificar HomeNavBar**:
   - Detectar si `isAuthenticated && role === 'external'`
   - Cambiar texto del botón a "Cuenta" cuando es usuario externo
   - Agregar estado para controlar apertura/cierre del menú
   - Agregar `Menu` de MUI con `anchorEl` apuntando al botón

2. **Crear menú desplegable**:
   - Usar `Menu` de MUI con `open`, `onClose`, `anchorEl`
   - Agregar `MenuItem` para "Editar cuenta" y "Cerrar sesión"
   - Agregar `Divider` si se muestra email
   - Mostrar email del usuario (opcional) usando `Typography`

3. **Implementar logout**:
   - Crear o usar UseCase de logout existente
   - Llamar al UseCase cuando se hace clic en "Cerrar sesión"
   - Redirigir a home después del logout
   - Actualizar estado de `useAuth`

4. **Implementar navegación a edición**:
   - Agregar `MenuItem` con `Link` de Next.js
   - Navegar a `/[locale]/account/edit` (o ruta definida)
   - La página de edición será implementada en otra HU

5. **Integrar en drawer móvil**:
   - Agregar el mismo menú en el drawer móvil
   - O mostrar botón "Cuenta" que abre el mismo menú

6. **Traducciones**:
   - Agregar traducciones en `common.json` o crear `account.json`
   - Usar `useTranslations` en el componente

### Ejemplo de código sugerido:

```typescript
// En HomeNavBar.tsx
const { isAuthenticated, role, user, logout } = useAuth();
const [accountMenuAnchor, setAccountMenuAnchor] = useState<null | HTMLElement>(null);

const isExternalUser = isAuthenticated && role === 'external';
const loginButtonText = isExternalUser ? t('buttons.account') : t('buttons.login');
const loginButtonHref = isExternalUser ? '#' : `/${locale}/login`;

const handleAccountMenuOpen = (event: React.MouseEvent<HTMLElement>) => {
  setAccountMenuAnchor(event.currentTarget);
};

const handleAccountMenuClose = () => {
  setAccountMenuAnchor(null);
};

const handleLogout = async () => {
  await logout();
  handleAccountMenuClose();
  router.push(`/${locale}`);
};

// En el JSX
{isExternalUser ? (
  <>
    <Button onClick={handleAccountMenuOpen}>
      {loginButtonText}
    </Button>
    <Menu
      anchorEl={accountMenuAnchor}
      open={Boolean(accountMenuAnchor)}
      onClose={handleAccountMenuClose}
    >
      <MenuItem onClick={handleAccountMenuClose} component={Link} href={`/${locale}/account/edit`}>
        {t('account.menu.editAccount')}
      </MenuItem>
      <MenuItem onClick={handleLogout}>
        {t('account.menu.logout')}
      </MenuItem>
    </Menu>
  </>
) : (
  <Link href={loginButtonHref}>
    <Button>{loginButtonText}</Button>
  </Link>
)}
```

### Notas importantes:
- El menú debe ser pequeño y discreto.
- El menú debe cerrarse automáticamente al seleccionar una opción.
- La opción "Editar cuenta" navegará a una página que será implementada en otra HU.
- El logout debe limpiar la sesión correctamente.
- Las traducciones deben estar completas (ES/EN).

---

## Validación

Comandos mínimos:
- `npm run dev` (verificar que el menú funciona)
- `npm run build` (verificar que no hay errores de compilación)

Verificaciones:
- El botón muestra "Cuenta" cuando el usuario externo está autenticado
- El menú se abre al hacer clic en "Cuenta"
- El menú se cierra al hacer clic fuera o al seleccionar una opción
- El logout funciona correctamente y redirige a home
- La navegación a "Editar cuenta" funciona (aunque la página no esté implementada)
- El menú funciona en desktop y móvil
- Las traducciones están completas (ES/EN)
- El comportamiento para otros roles se mantiene igual

---

## Definición de Hecho

- [ ] Criterios de aceptación cumplidos
- [ ] `npm run dev` OK
- [ ] `npm run build` OK
- [ ] Sin violaciones de capas
- [ ] Sin cambios fuera del alcance
- [ ] **Traducciones incluidas** (si aplica UI con texto):
  - [ ] Textos agregados en `src/messages/es/common.json` o `src/messages/es/account.json`
  - [ ] Textos agregados en `src/messages/en/common.json` o `src/messages/en/account.json`
  - [ ] Componentes usan `useTranslations` (no textos hardcodeados)
  - [ ] Keys consistentes entre idiomas
- [ ] Menú funciona en desktop y móvil
- [ ] Logout funciona correctamente
- [ ] Navegación a "Editar cuenta" funciona (aunque la página no esté implementada)
- [ ] Comportamiento para otros roles se mantiene igual
- Commit sugerido:
  `feat: add account menu for external users`
