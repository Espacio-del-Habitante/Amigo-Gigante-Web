# HU-058 — Redirección a Solicitudes desde Notificaciones

**Como** usuario foundation_user  
**Quiero** hacer clic en una notificación de solicitud de adopción  
**Para** ser redirigido directamente a la página de detalle de esa solicitud

---

## Dependencias

- HU-001 (Next.js App Router)
- HU-005 (MUI configurado)
- HU-007 (Tailwind configurado)
- HU-011 (Conexión a Supabase configurada)
- HU-013 (Estrategia de roles y protección de rutas definida)
- HU-016 (Sistema de traducciones configurado)
- HU-025 (Dashboard implementado)
- HU-027 (Gestión de solicitudes de adopción implementada)
- HU-039 (Notificaciones en tiempo real implementadas)

---

## Contexto / Notas

- Esta HU completa la funcionalidad de notificaciones implementada en HU-039.
- Ya existe un sistema de notificaciones con:
  - Componente `NotificationBell` que muestra notificaciones
  - Componente `NotificationItem` que renderiza cada notificación
  - Función `buildNotificationLink` que construye links de redirección
  - Página de detalle de solicitud en `/foundations/adoptions/[id]`
- Las notificaciones de tipo `adoption_request_created` y `adoption_status_changed` contienen en el campo `data`:
  - `request_id`: ID de la solicitud de adopción
  - `animal_id`: ID del animal
  - `foundation_id`: ID de la fundación
  - `status`: Estado de la solicitud
- El `request_id` en el JSONB puede ser número (`bigint`) o string, dependiendo de cómo se serialice.
- Al hacer clic en una notificación:
  1. Se debe marcar como leída (si no lo está)
  2. Se debe redirigir a la página de detalle de la solicitud
  3. El panel de notificaciones debe cerrarse
- La redirección debe funcionar tanto desde:
  - El panel de notificaciones en el header (campana)
  - La sección "Requiere Atención" en el dashboard (si aplica)

---

## Diseño (OBLIGATORIO si hay UI)

Referencias:
- Diseño: Panel de notificaciones ya implementado en HU-039
- Página de detalle: `docs/design/system.md` (página de detalle de solicitud)
- Design System: `docs/design/system.md`

Reglas:
- Las notificaciones de solicitudes deben ser claramente clicables (hover effect).
- Al hacer clic, debe haber feedback visual (transición suave).
- El panel de notificaciones debe cerrarse automáticamente después de la redirección.
- Si la notificación no tiene `request_id` válido, no debe redirigir (o mostrar error).
- La página de detalle debe mostrar la solicitud correcta según el ID.

---

## Alcance

Incluye:
- Asegurar que `buildNotificationLink` maneje correctamente `request_id` como número o string
- Verificar que las notificaciones de solicitudes redirijan correctamente a `/foundations/adoptions/[id]`
- Asegurar que la notificación se marque como leída al hacer clic
- Verificar que el panel de notificaciones se cierre después de la redirección
- Manejar casos edge (notificación sin `request_id`, solicitud eliminada, etc.)
- Asegurar que la redirección funcione desde el panel de notificaciones
- Asegurar que la redirección funcione desde la sección "Requiere Atención" del dashboard (si aplica)
- Traducciones para mensajes de error si es necesario

No incluye:
- Modificar la estructura de notificaciones en BD
- Cambiar la página de detalle de solicitud
- Agregar nuevos tipos de notificaciones
- Modificar el sistema de notificaciones en tiempo real
- Tests automatizados

---

## Criterios de aceptación (Given / When / Then)

### 1) Redirección desde panel de notificaciones
- **Dado** una notificación de tipo `adoption_request_created` o `adoption_status_changed` con `request_id` válido
- **Cuando** el usuario hace clic en la notificación en el panel
- **Entonces** se marca la notificación como leída
- **Y** se redirige a `/foundations/adoptions/[request_id]`
- **Y** el panel de notificaciones se cierra

### 2) Manejo de request_id como número
- **Dado** una notificación con `request_id` como número (bigint serializado)
- **Cuando** se construye el link de redirección
- **Entonces** el link se genera correctamente
- **Y** la redirección funciona

### 3) Manejo de request_id como string
- **Dado** una notificación con `request_id` como string
- **Cuando** se construye el link de redirección
- **Entonces** el link se genera correctamente
- **Y** la redirección funciona

### 4) Notificación sin request_id
- **Dado** una notificación de solicitud sin `request_id` en el campo `data`
- **Cuando** el usuario hace clic en la notificación
- **Entonces** no se redirige (o se muestra un mensaje de error apropiado)
- **Y** la notificación se marca como leída si se hace clic

### 5) Solicitud no encontrada
- **Dado** una notificación con `request_id` válido pero la solicitud fue eliminada
- **Cuando** se redirige a la página de detalle
- **Entonces** la página de detalle muestra el error apropiado (ya implementado)
- **Y** el usuario puede volver atrás

### 6) Redirección desde dashboard
- **Dado** una notificación mostrada en la sección "Requiere Atención" del dashboard
- **Cuando** el usuario hace clic en la notificación
- **Entonces** se redirige correctamente a la página de detalle
- **Y** la notificación se marca como leída

### 7) Notificaciones ya leídas
- **Dado** una notificación ya marcada como leída
- **Cuando** el usuario hace clic en la notificación
- **Entonces** se redirige correctamente
- **Y** no se intenta marcar como leída nuevamente (o se maneja correctamente)

### 8) Múltiples notificaciones
- **Dado** múltiples notificaciones de diferentes solicitudes
- **Cuando** el usuario hace clic en cada una
- **Entonces** cada una redirige a su solicitud correspondiente
- **Y** todas se marcan como leídas correctamente

---

## Reglas técnicas

### Arquitectura
- Presentation solo consume UseCases vía IoC (no importa repositorios concretos).
- Domain no importa React/Next/MUI/Tailwind/Inversify/Supabase.
- Infrastructure contiene implementaciones y wiring IoC.
- **Supabase solo vive en Infrastructure**: servicios y repositorios.

### Estructura de datos de notificaciones

Las notificaciones de solicitudes tienen esta estructura en el campo `data`:
```typescript
{
  request_id: number | string,  // Puede ser bigint (número) o string
  animal_id: number | string,
  foundation_id: string,
  status?: string,
  old_status?: string,  // Solo en adoption_status_changed
  new_status?: string   // Solo en adoption_status_changed
}
```

### Función buildNotificationLink

La función `buildNotificationLink` en `src/presentation/utils/notificationUtils.ts` debe:
- Manejar `request_id` como número o string
- Validar que existe antes de construir el link
- Retornar `null` si no puede construir el link
- Construir la ruta: `/${locale}/foundations/adoptions/${requestId}`

### Componente NotificationBell

El componente `NotificationBell` en `src/presentation/components/molecules/NotificationBell/NotificationBell.tsx`:
- Ya tiene la lógica de `handleSelect` que:
  1. Marca como leída si no lo está
  2. Construye el link con `buildNotificationLink`
  3. Redirige con `router.push(link)`
  4. Cierra el panel
- Debe asegurarse de manejar el caso cuando `link` es `null`

### Componente NotificationItem

El componente `NotificationItem` en `src/presentation/components/molecules/NotificationItem/NotificationItem.tsx`:
- Ya es clicable y llama a `onSelect`
- Debe mantener el estilo visual que indica que es clicable

### Sección "Requiere Atención" del Dashboard

Si la sección `NeedsAttentionSection` muestra notificaciones clicables:
- Debe usar la misma lógica de `buildNotificationLink`
- Debe marcar como leída al hacer clic
- Debe redirigir correctamente

### Traducciones (OBLIGATORIO si hay UI con texto)
- **TODOS los textos visibles en la UI deben estar traducidos** (español e inglés).
- Usar el sistema de traducciones configurado en HU-016 (`next-intl`).
- Si se agregan mensajes de error, agregarlos en:
  - `src/messages/es/notifications.json` (español)
  - `src/messages/en/notifications.json` (inglés)
- Keys sugeridas (si es necesario):
  - `errors.invalidRequestId` → "No se pudo redirigir: solicitud no válida"
  - `errors.requestNotFound` → "La solicitud no fue encontrada"

### Dependencias / Paquetes
- No agregar dependencias nuevas.
- Usar las dependencias existentes (`next/navigation`, `next-intl`, etc.).

---

## Implementación sugerida

### Archivos a modificar:

1. **`src/presentation/utils/notificationUtils.ts`**
   - Mejorar `buildNotificationLink` para manejar `request_id` como número o string
   - Agregar validación más robusta
   - Asegurar que el ID se convierte correctamente a string para la URL

2. **`src/presentation/components/molecules/NotificationBell/NotificationBell.tsx`**
   - Verificar que maneja correctamente cuando `link` es `null`
   - Asegurar que el flujo de marcado como leída y redirección funciona correctamente

3. **`src/presentation/components/dashboard/NeedsAttentionSection.tsx`** (si aplica)
   - Verificar que las notificaciones clicables usan `buildNotificationLink`
   - Asegurar que redirigen correctamente

### Código sugerido para `buildNotificationLink`:

```typescript
export const buildNotificationLink = (locale: string, notification: Notification): string | null => {
  const data = notification.data || {};
  const requestId = data.request_id;

  // Manejar request_id como número o string
  if (
    (notification.type === "adoption_request_created" || 
     notification.type === "adoption_status_changed") &&
    (typeof requestId === "number" || typeof requestId === "string")
  ) {
    // Convertir a string para la URL
    const id = String(requestId);
    // Validar que no esté vacío
    if (id && id !== "0" && id !== "") {
      return `/${locale}/foundations/adoptions/${id}`;
    }
  }

  return null;
};
```

### Verificaciones adicionales:

- Verificar que `NotificationBell.handleSelect` maneja el caso cuando `link` es `null`
- Verificar que la página de detalle maneja correctamente IDs inválidos o solicitudes no encontradas
- Probar con notificaciones que tienen `request_id` como número
- Probar con notificaciones que tienen `request_id` como string
- Probar con notificaciones sin `request_id`

---

## Validación

Comandos mínimos:
- `npm run dev`
- `npm run build`

Verificaciones:
- Hacer clic en notificación de solicitud redirige correctamente
- Notificación se marca como leída al hacer clic
- Panel de notificaciones se cierra después de la redirección
- Funciona con `request_id` como número
- Funciona con `request_id` como string
- Maneja correctamente notificaciones sin `request_id`
- Redirección funciona desde el panel de notificaciones
- Redirección funciona desde el dashboard (si aplica)

---

## Definición de Hecho

- [ ] Criterios de aceptación cumplidos
- [ ] `npm run dev` OK
- [ ] `npm run build` OK
- [ ] `buildNotificationLink` maneja correctamente número y string
- [ ] Redirección funciona desde panel de notificaciones
- [ ] Redirección funciona desde dashboard (si aplica)
- [ ] Notificaciones se marcan como leídas correctamente
- [ ] Panel se cierra después de redirección
- [ ] Casos edge manejados correctamente
- [ ] Sin violaciones de capas
- [ ] Sin cambios fuera del alcance
- [ ] **Traducciones incluidas** (si se agregaron mensajes de error):
  - [ ] Textos agregados en `src/messages/es/notifications.json`
  - [ ] Textos agregados en `src/messages/en/notifications.json`
  - [ ] Componentes usan `useTranslations` (no textos hardcodeados)
  - [ ] Keys consistentes entre idiomas
- Commit sugerido:
  `feat: ensure notification clicks redirect to adoption request details`
