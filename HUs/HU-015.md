# HU-015 — Lógica de negocio de registro con Supabase

**Como** usuario de una fundación  
**Quiero** completar el registro y que se cree mi cuenta y fundación  
**Para** acceder a la plataforma Amigo Gigante

---

## Dependencias

- HU-011 (Conexión a Supabase configurada)
- HU-012 (Formulario de registro UI implementado)
- HU-013 (Estrategia de roles y protección de rutas definida)
- HU-014 (Formulario con Formik y Yup implementado)

---

## Contexto / Notas

- Esta HU implementa la **lógica de negocio** del registro conectando con Supabase.
- El formulario ya está validado (HU-014), ahora se conecta con el backend.
- El flujo de registro debe crear:
  1. Usuario en Supabase Auth (con email y password)
  2. Perfil en `profiles` (con `role: 'foundation_user'`)
  3. Fundación en `foundations` (con nombre)
  4. Contacto en `foundation_contacts` (con email oficial)
  5. Miembro en `foundation_members` (usuario como `owner` de la fundación)
- Se debe manejar errores del servidor y mostrarlos al usuario.
- Después del registro exitoso, el usuario debe quedar autenticado y ser redirigido.

---

## Alcance

Incluye:
- Crear UseCase de registro de fundación
- Crear repositorios necesarios (Auth, Foundation, Profile)
- Implementar servicios de Supabase para registro
- Conectar el formulario con el UseCase
- Manejo de errores del servidor (mostrar mensajes al usuario)
- Redirección después del registro exitoso
- Crear perfil automáticamente con rol `foundation_user`

No incluye:
- Validación de formulario (ya está en HU-014)
- Protección de rutas completa (solo estrategia en HU-013)
- Logout funcional
- Validación de email por correo
- Recuperación de contraseña
- Edición de perfil o fundación

---

## Criterios de aceptación (Given / When / Then)

### 1) UseCase de registro implementado

- **Dado** que se necesita registrar una fundación
- **Cuando** se implementa la lógica de negocio
- **Entonces** existe un UseCase `RegisterFoundationUseCase` en `domain/usecases/auth/`
- **Y** el UseCase recibe los datos del formulario
- **Y** ejecuta el flujo completo de registro

---

### 2) Repositorios creados

- **Dado** que se necesita interactuar con Supabase
- **Cuando** se implementan los repositorios
- **Entonces** existen:
  - `IAuthRepository` (interfaz en Domain)
  - `AuthRepository` (implementación en Infrastructure)
  - `IFoundationRepository` (interfaz en Domain)
  - `FoundationRepository` (implementación en Infrastructure)
- **Y** los repositorios están registrados en el contenedor IoC

---

### 3) Registro completo funcional

- **Dado** que un usuario completa el formulario de registro
- **Cuando** envía el formulario con datos válidos
- **Entonces** se crea:
  - Usuario en Supabase Auth
  - Perfil con `role: 'foundation_user'`
  - Fundación con el nombre proporcionado
  - Contacto de fundación con el email oficial
  - Miembro de fundación con el usuario como `owner`
- **Y** el usuario queda autenticado en la sesión

---

### 4) Manejo de errores del servidor

- **Dado** que ocurre un error durante el registro
- **Cuando** se intenta registrar
- **Entonces** se muestra un mensaje de error al usuario
- **Y** los errores comunes se manejan:
  - Email ya registrado
  - Error de conexión
  - Error de validación de Supabase
- **Y** los mensajes de error son claros y en español

---

### 5) Redirección después del registro

- **Dado** que el registro es exitoso
- **Cuando** se completa el registro
- **Entonces** el usuario es redirigido a una ruta protegida (ej: `/dashboard`)
- **Y** la sesión queda activa
- **Y** el usuario puede acceder a áreas protegidas

---

### 6) Integración con formulario

- **Dado** que el formulario tiene validación (HU-014)
- **Cuando** se conecta con la lógica de negocio
- **Entonces** el `onSubmit` de Formik llama al UseCase
- **Y** se muestra estado de loading durante el registro
- **Y** se manejan errores y éxito correctamente

---

## Reglas técnicas

### Arquitectura
- Presentation solo consume UseCases vía IoC (no importa repositorios concretos).
- Domain no importa React/Next/MUI/Tailwind/Inversify/Supabase.
- Infrastructure contiene implementaciones y wiring IoC.
- **Supabase solo vive en Infrastructure**: servicios y repositorios.

### Flujo de registro
1. Usuario completa formulario (validado con Yup)
2. `onSubmit` de Formik llama a `RegisterFoundationUseCase` (Presentation)
3. UseCase llama a `AuthRepository.signUp()` (Domain → Infrastructure)
4. UseCase crea perfil con `role: 'foundation_user'` (Domain → Infrastructure)
5. UseCase llama a `FoundationRepository.createFoundation()` (Domain → Infrastructure)
6. UseCase crea contacto de fundación (Domain → Infrastructure)
7. UseCase crea miembro de fundación como `owner` (Domain → Infrastructure)
8. Retornar éxito y redirigir (Presentation)

### Transacciones
- Si es posible, usar transacciones de Supabase para asegurar atomicidad.
- Si falla algún paso, revertir los cambios anteriores.
- Si no es posible transacciones, manejar errores y limpiar datos creados.

### Dependencias / Paquetes
- No agregar dependencias nuevas salvo que esta HU lo indique explícitamente.
- Si aparece error 403/conectividad:
  1) Detenerse
  2) Pedir dominios requeridos
  3) Explicar por qué se requieren
  4) No continuar

---

## Implementación sugerida

### Estructura de archivos sugerida:

```
src/domain/
├── models/
│   ├── AuthUser.ts
│   └── Foundation.ts
├── repositories/
│   ├── IAuthRepository.ts
│   └── IFoundationRepository.ts
└── usecases/
    └── auth/
        └── RegisterFoundationUseCase.ts

src/infrastructure/
├── repositories/
│   ├── AuthRepository.ts
│   └── FoundationRepository.ts
└── services/
    └── SupabaseAuthService.ts (opcional, si se abstrae)

src/presentation/
└── components/
    └── register/
        └── RegisterForm.tsx (conectar onSubmit con UseCase)
```

### Flujo de implementación:

1. **Crear modelos Domain**:
   - `AuthUser` (id, email, role)
   - `Foundation` (id, name, etc.)

2. **Crear interfaces de repositorios**:
   - `IAuthRepository.signUp(email, password): Promise<AuthUser>`
   - `IAuthRepository.createProfile(userId, role): Promise<void>`
   - `IFoundationRepository.createFoundation(data): Promise<Foundation>`
   - `IFoundationRepository.createFoundationContact(foundationId, email): Promise<void>`
   - `IFoundationRepository.createFoundationMember(foundationId, userId, role): Promise<void>`

3. **Implementar repositorios en Infrastructure**:
   - `AuthRepository` usa Supabase Auth y DB
   - `FoundationRepository` usa Supabase DB

4. **Crear UseCase**:
   - `RegisterFoundationUseCase.execute(data)`:
     - Sign up en Auth
     - Crear perfil con `role: 'foundation_user'`
     - Crear fundación
     - Crear contacto
     - Crear miembro como `owner`

5. **Conectar formulario**:
   - En `RegisterForm.tsx`, en `onSubmit` de Formik:
     - Obtener UseCase del contenedor IoC
     - Llamar a `execute()` con los datos del formulario
     - Manejar éxito (redirigir) y errores (mostrar mensaje)

6. **Manejar errores**:
   - Traducir errores de Supabase a mensajes amigables
   - Mostrar mensajes de error en el formulario
   - Manejar casos: email duplicado, error de conexión, etc.

### Notas importantes:
- Usar transacciones si es posible (Supabase permite múltiples inserts).
- El Tax ID puede omitirse o guardarse en `foundation_contacts` como campo adicional.
- Los errores de Supabase deben traducirse a mensajes amigables en español.
- Después del registro, el usuario debe quedar autenticado automáticamente.

---

## Validación

Comandos mínimos:
- `npm run dev` (verificar que el registro funciona)
- `npm run build` (verificar que no hay errores de compilación)

Verificaciones:
- El registro crea todos los registros necesarios en Supabase
- Los errores se muestran correctamente al usuario
- La redirección después del registro funciona
- El usuario queda autenticado después del registro
- La sesión persiste correctamente

---

## Definición de Hecho

- [ ] Criterios de aceptación cumplidos
- [ ] `npm run dev` OK
- [ ] `npm run build` OK
- [ ] UseCase de registro implementado
- [ ] Repositorios creados y registrados en IoC
- [ ] Registro completo funcional (crea usuario, perfil, fundación, contacto, miembro)
- [ ] Manejo de errores del servidor implementado
- [ ] Redirección después del registro funciona
- [ ] Integración con formulario funciona correctamente
- [ ] Sin violaciones de capas
- [ ] Sin cambios fuera del alcance
- Commit sugerido:
  `feat: implement foundation registration business logic with supabase`

