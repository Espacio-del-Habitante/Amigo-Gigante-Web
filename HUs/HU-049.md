# HU-049 — Implementar funcionalidad real del dashboard y limpiar acciones no disponibles en MVP

**Como** miembro de fundación  
**Quiero** ver datos reales en el dashboard y solo acciones disponibles en el MVP  
**Para** tener información precisa de mi fundación y evitar confusión con funcionalidades no implementadas

---

## Dependencias

- HU-001 (Next.js App Router)
- HU-011 (Conexión a Supabase configurada)
- HU-016 (Sistema de traducciones configurado)
- HU-025 (Dashboard implementado)
- HU-037 (Gestión de solicitudes de adopción implementada)
- HU-039 (Sistema de notificaciones implementado)

---

## Contexto / Notas

- Actualmente, el dashboard muestra datos **hardcodeados** (quemados) en varios lugares:
  - KPIs: `activeSponsorships` (120), `pendingAdoptions` (3), `monthlyRevenue` (1250) están hardcodeados ❌
  - Adoption Funnel: Todos los valores están hardcodeados (24, 12, 5, 3) ❌
  - Trends: Los porcentajes de tendencia están hardcodeados ❌
- El componente `QuickActionsSection` muestra botones que no están implementados:
  - "Registrar gasto" ❌ (no existe en MVP)
  - "Crear campaña" ❌ (no existe en MVP)
- El componente `NeedsAttentionSection` ya muestra notificaciones, pero también muestra alerts hardcodeados
- Esta HU implementa:
  - Eliminación de botones no disponibles en MVP
  - Obtención de datos reales desde la base de datos para KPIs y Adoption Funnel
  - Cálculo de tendencias basado en datos históricos (o eliminación si no hay datos suficientes)
  - Mostrar solo notificaciones en "Requiere Atención" (eliminar alerts hardcodeados si no hay datos reales)

---

## Diseño (OBLIGATORIO si hay UI)

Referencias:
- Diseño: `docs/design/dashboard_code.html`
- Imagen: `docs/design/dashboard_screen.png`
- Componente existente: `src/presentation/components/dashboard/DashboardPage.tsx`

Reglas:
- El dashboard debe mostrar solo datos reales (no hardcodeados)
- La sección "Acciones Rápidas" debe mostrar solo el botón "Nuevo Animal" (eliminar "Registrar gasto" y "Crear campaña")
- La sección "Requiere Atención" debe mostrar solo notificaciones no leídas relevantes
- Los KPIs deben mostrar valores reales o 0 si no hay datos
- El Adoption Funnel debe mostrar valores reales basados en el status de las solicitudes
- Las tendencias deben calcularse o mostrarse como "neutral" si no hay datos históricos suficientes

---

## Reglas técnicas

- Arquitectura: ver `docs/01_arquitectura.md`
- Reglas Codex: ver `docs/02_reglas_de_codex.md`

## Alcance

Incluye:
- Modificar `QuickActionsSection` para eliminar botones no implementados
- Modificar `GetDashboardDataUseCase` para:
  - Obtener conteo real de solicitudes de adopción por status
  - Calcular `pendingAdoptions` desde `adoption_requests` con status `pending`
  - Calcular Adoption Funnel desde `adoption_requests`:
    - `applicationsReceived`: Total de solicitudes
    - `interviewsScheduled`: Solicitudes con status `preapproved`
    - `homeVisits`: Solicitudes con status `preapproved` (mismo que interviews por ahora, o 0 si no hay lógica específica)
    - `adoptionsCompleted`: Solicitudes con status `completed`
  - Eliminar o marcar como "no disponible" KPIs que no tienen datos reales:
    - `activeSponsorships`: Eliminar o mostrar 0 (no implementado en MVP)
    - `monthlyRevenue`: Eliminar o mostrar 0 (no implementado en MVP)
- Modificar `NeedsAttentionSection` para mostrar solo notificaciones (eliminar alerts hardcodeados)
- Agregar método al repositorio `IAdoptionRequestRepository` para obtener conteos por status
- Actualizar traducciones si es necesario

No incluye:
- Implementar funcionalidad de "Registrar gasto"
- Implementar funcionalidad de "Crear campaña"
- Implementar sistema de patrocinios
- Implementar sistema de ingresos/recaudación
- Cálculo de tendencias históricas complejas (solo mostrar datos actuales)

---

## Criterios de aceptación (Given / When / Then)

### 1) Botones no implementados eliminados

- **Dado** que un usuario está en el dashboard
- **Cuando** ve la sección "Acciones Rápidas"
- **Entonces** solo ve el botón "Nuevo Animal"
- **Y** NO ve los botones "Registrar gasto" y "Crear campaña"

### 2) KPIs muestran datos reales

- **Dado** que un usuario está en el dashboard
- **Cuando** ve las tarjetas de KPIs
- **Entonces** `animalsInCare` muestra el conteo real de animales de la fundación
- **Y** `pendingAdoptions` muestra el conteo real de solicitudes con status `pending`
- **Y** `activeSponsorships` y `monthlyRevenue` están eliminados o muestran 0 (no implementados en MVP)
- **Y** las tendencias se muestran como "neutral" si no hay datos históricos suficientes

### 3) Adoption Funnel muestra datos reales

- **Dado** que un usuario está en el dashboard
- **Cuando** ve la sección "Estado del Embudo de Adopción"
- **Entonces** `applicationsReceived` muestra el total real de solicitudes de la fundación
- **Y** `interviewsScheduled` muestra el conteo real de solicitudes con status `preapproved`
- **Y** `homeVisits` muestra 0 o el mismo valor que `interviewsScheduled` (no hay lógica específica)
- **Y** `adoptionsCompleted` muestra el conteo real de solicitudes con status `completed`
- **Y** los porcentajes se calculan correctamente basados en `applicationsReceived`

### 4) Requiere Atención muestra solo notificaciones

- **Dado** que un usuario está en el dashboard
- **Cuando** ve la sección "Requiere Atención"
- **Entonces** solo muestra notificaciones no leídas relevantes (tipo `adoption_request_created`, `adoption_status_changed`)
- **Y** NO muestra alerts hardcodeados (como `lowStock`, `volunteersNeeded`)
- **Y** el badge muestra el conteo real de notificaciones no leídas

### 5) Datos se actualizan correctamente

- **Dado** que un usuario está en el dashboard
- **Cuando** se crea una nueva solicitud de adopción o cambia el status
- **Entonces** los KPIs y el Adoption Funnel se actualizan automáticamente (al recargar)
- **Y** las notificaciones se actualizan en tiempo real (ya implementado)

---

## Reglas técnicas

### Arquitectura
- Presentation solo consume UseCases vía IoC (no importa repositorios concretos).
- Domain no importa React/Next/MUI/Tailwind/Inversify/Supabase.
- Infrastructure contiene implementaciones y wiring IoC.
- Los datos deben obtenerse desde la base de datos, no hardcodeados.

### Estructura del Repositorio

```typescript
// domain/repositories/IAdoptionRequestRepository.ts
// Agregar método:

export interface GetAdoptionRequestsCountsParams {
  foundationId: string;
}

export interface AdoptionRequestsCounts {
  total: number;
  byStatus: {
    pending: number;
    in_review: number;
    info_requested: number;
    preapproved: number;
    approved: number;
    rejected: number;
    cancelled: number;
    completed: number;
  };
}

export interface IAdoptionRequestRepository {
  // ... métodos existentes
  getAdoptionRequestsCounts(params: GetAdoptionRequestsCountsParams): Promise<AdoptionRequestsCounts>;
}
```

### Implementación en el Repositorio

```typescript
// infrastructure/repositories/AdoptionRequestRepository.ts
async getAdoptionRequestsCounts(params: GetAdoptionRequestsCountsParams): Promise<AdoptionRequestsCounts> {
  const { foundationId } = params;

  // Obtener total
  const { count: total, error: totalError } = await supabaseClient
    .from("adoption_requests")
    .select("*", { count: "exact", head: true })
    .eq("foundation_id", foundationId);

  if (totalError) {
    throw new Error(this.translateAdoptionError(totalError));
  }

  // Obtener conteos por status
  const { data, error } = await supabaseClient
    .from("adoption_requests")
    .select("status")
    .eq("foundation_id", foundationId);

  if (error) {
    throw new Error(this.translateAdoptionError(error));
  }

  const byStatus = {
    pending: 0,
    in_review: 0,
    info_requested: 0,
    preapproved: 0,
    approved: 0,
    rejected: 0,
    cancelled: 0,
    completed: 0,
  };

  (data ?? []).forEach((row) => {
    const status = row.status as keyof typeof byStatus;
    if (status in byStatus) {
      byStatus[status]++;
    }
  });

  return {
    total: total ?? 0,
    byStatus,
  };
}
```

### Actualización del Use Case

```typescript
// domain/usecases/dashboard/GetDashboardDataUseCase.ts
// Modificar execute():

async execute(): Promise<DashboardData> {
  const session = await this.authRepository.getSession();

  if (!session?.user?.id) {
    throw new Error("errors.unauthorized");
  }

  const foundationId = await this.foundationMembershipRepository.getFoundationIdForUser(session.user.id);

  const [
    foundation,
    animalsCount,
    recentAnimals,
    recentEvents,
    recentProducts,
    animalsInTreatment,
    adoptionCounts,
  ] = await Promise.all([
    this.foundationRepository.getFoundationById(foundationId),
    this.animalRepository.getAnimalsCount(foundationId),
    this.animalRepository.getRecentAnimals(foundationId, 10),
    this.eventRepository.getRecentEvents(foundationId, 5),
    this.productRepository.getRecentProducts(foundationId, 5),
    this.animalRepository.getAnimalsInTreatment(foundationId),
    this.adoptionRequestRepository.getAdoptionRequestsCounts({ foundationId }),
  ]);

  const kpis: DashboardKpiCard[] = [
    {
      key: "animalsInCare",
      value: animalsCount,
      trend: { percent: 0, variant: "neutral" }, // Sin datos históricos por ahora
    },
    {
      key: "pendingAdoptions",
      value: adoptionCounts.byStatus.pending,
      trend: { percent: 0, variant: "neutral" },
    },
    // Eliminar activeSponsorships y monthlyRevenue del MVP
  ];

  const adoptionFunnel = {
    applicationsReceived: adoptionCounts.total,
    interviewsScheduled: adoptionCounts.byStatus.preapproved,
    homeVisits: adoptionCounts.byStatus.preapproved, // Mismo que interviews por ahora
    adoptionsCompleted: adoptionCounts.byStatus.completed,
  };

  const activity = this.buildRecentActivity(recentAnimals, recentEvents, recentProducts);

  // Eliminar alerts hardcodeados, solo usar notificaciones
  const attentionAlerts: DashboardData["attentionAlerts"] = [];

  return {
    foundationId,
    foundationName: foundation.name,
    kpis,
    adoptionFunnel,
    recentActivity: activity,
    animalsInTreatment,
    attentionAlerts,
  };
}
```

### Actualización del Modelo

```typescript
// domain/models/DashboardData.ts
// Actualizar DashboardKpiCard para hacer opcionales algunos keys:

export interface DashboardKpiCard {
  key: "animalsInCare" | "pendingAdoptions"; // Eliminar "activeSponsorships" y "monthlyRevenue"
  value: number;
  trend: DashboardKpiTrend;
}
```

### Actualización de QuickActionsSection

```typescript
// src/presentation/components/dashboard/QuickActionsSection.tsx
// Eliminar botones no implementados:

export function QuickActionsSection() {
  const t = useTranslations("dashboard");
  const locale = useLocale();
  const router = useRouter();

  const onNewAnimal = () => {
    router.push(`/${locale}/foundations/animals/add`);
  };

  return (
    <section className="rounded-xl border border-brand-100 bg-brand-50/30 p-6">
      <h3 className="mb-4 text-lg font-extrabold text-neutral-800">{t("quickActions.title")}</h3>
      <div className="flex flex-col gap-3">
        <button
          type="button"
          onClick={onNewAnimal}
          className="flex h-12 w-full items-center justify-center gap-2 rounded-xl bg-brand-500 px-4 text-sm font-extrabold text-neutral-50 shadow-soft transition-colors hover:bg-brand-600 active:scale-[0.98]"
        >
          <AddCircleRoundedIcon fontSize="small" />
          <span>{t("quickActions.newAnimal")}</span>
        </button>
      </div>
    </section>
  );
}
```

### Actualización de NeedsAttentionSection

```typescript
// src/presentation/components/dashboard/NeedsAttentionSection.tsx
// Ya está implementado correctamente, solo asegurar que no muestre alerts hardcodeados:

export function NeedsAttentionSection({ alerts, locale }: NeedsAttentionSectionProps) {
  // ... código existente ...
  
  // Solo mostrar notificaciones, ignorar alerts si están vacíos
  const badge = String(relevantNotifications.length);
  
  // ... resto del código ...
  
  return (
    <section className="flex flex-1 flex-col overflow-hidden rounded-xl border border-neutral-100 bg-neutral-white shadow-soft">
      {/* ... header ... */}
      <div className="flex flex-col gap-3 p-4">
        {relevantNotifications.map((notification) => {
          // ... renderizar notificaciones ...
        })}
        {/* Eliminar o comentar la sección de alerts hardcodeados */}
        {alerts.length === 0 && relevantNotifications.length === 0 && (
          <p className="text-sm text-neutral-500 text-center py-4">
            {t("needsAttention.empty")}
          </p>
        )}
      </div>
      {/* ... footer ... */}
    </section>
  );
}
```

### Actualización de DashboardKPICards

```typescript
// src/presentation/components/dashboard/DashboardKPICards.tsx
// Actualizar para manejar solo los KPIs disponibles:

export function DashboardKPICards({ kpis, locale }: DashboardKPICardsProps) {
  const icons: Record<DashboardKpiCard["key"], { icon: ReactNode; iconClassName: string }> = {
    animalsInCare: {
      icon: <PetsRoundedIcon fontSize="small" />,
      iconClassName: "bg-brand-50 text-brand-700",
    },
    pendingAdoptions: {
      icon: <HomeRoundedIcon fontSize="small" />,
      iconClassName: "bg-neutral-100 text-neutral-700",
    },
    // Eliminar activeSponsorships y monthlyRevenue
  };

  return (
    <div className="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-2 lg:gap-6">
      {/* Cambiar de lg:grid-cols-4 a lg:grid-cols-2 */}
      {kpis.map((kpi) => (
        <DashboardKPICard
          key={kpi.key}
          kpi={kpi}
          locale={locale}
          icon={icons[kpi.key].icon}
          iconClassName={icons[kpi.key].iconClassName}
        />
      ))}
    </div>
  );
}
```

### Traducciones (OBLIGATORIO si hay UI)

```json
// src/messages/es/dashboard.json
{
  "needsAttention": {
    "title": "Requiere Atención",
    "empty": "No hay notificaciones pendientes",
    // ... resto de traducciones existentes ...
  }
}
```

---

## Implementación sugerida

### 1. Agregar método al repositorio

- Agregar `getAdoptionRequestsCounts` a `IAdoptionRequestRepository`
- Implementar en `AdoptionRequestRepository`

### 2. Actualizar el Use Case

- Modificar `GetDashboardDataUseCase` para usar datos reales
- Eliminar KPIs no implementados
- Calcular Adoption Funnel desde datos reales

### 3. Actualizar componentes

- Modificar `QuickActionsSection` para eliminar botones no implementados
- Modificar `DashboardKPICards` para mostrar solo 2 KPIs
- Asegurar que `NeedsAttentionSection` solo muestre notificaciones

### 4. Actualizar modelos

- Actualizar `DashboardKpiCard` para eliminar keys no implementados

### 5. Agregar traducciones

- Agregar mensaje para "No hay notificaciones pendientes"

---

## Validación

Comandos mínimos:
- `npm run dev` (verificar que el dashboard muestra datos reales)
- `npm run build` (verificar que no hay errores de compilación)

Pruebas manuales:
1. Ir al dashboard
2. Verificar que solo hay 2 KPIs (Animales en Cuidado y Adopciones Pendientes)
3. Verificar que los valores de KPIs son reales (no hardcodeados)
4. Verificar que el Adoption Funnel muestra valores reales
5. Verificar que "Acciones Rápidas" solo muestra "Nuevo Animal"
6. Verificar que "Requiere Atención" solo muestra notificaciones
7. Crear una nueva solicitud de adopción
8. Verificar que los conteos se actualizan (al recargar)
9. Cambiar el status de una solicitud
10. Verificar que el Adoption Funnel se actualiza

---

## Definición de Hecho

- [ ] Criterios de aceptación cumplidos
- [ ] `npm run dev` OK
- [ ] `npm run build` OK
- [ ] Sin violaciones de capas
- [ ] Sin cambios fuera del alcance
- [ ] **Traducciones incluidas**:
  - [ ] Textos agregados en `src/messages/es/dashboard.json` (si se agregaron nuevas keys)
  - [ ] Textos agregados en `src/messages/en/dashboard.json` (si se agregaron nuevas keys)
- [ ] Pruebas manuales realizadas:
  - [ ] Botones no implementados eliminados
  - [ ] KPIs muestran datos reales
  - [ ] Adoption Funnel muestra datos reales
  - [ ] Requiere Atención muestra solo notificaciones
  - [ ] Datos se actualizan correctamente
- [ ] Método del repositorio implementado y funcionando
- [ ] Use Case actualizado con datos reales
- Commit sugerido:
  `feat: implementar datos reales en dashboard y limpiar acciones no disponibles (HU-049)`
