# HU-011 — Configuración de conexión a Supabase

**Como** desarrollador  
**Quiero** configurar la conexión a Supabase en el proyecto  
**Para** tener acceso a autenticación, base de datos y storage desde la aplicación

---

## Dependencias

- HU-002 (Estructura de carpetas por capas)
- HU-003 (IoC configurado con Inversify)

---

## Contexto / Notas

- Supabase debe estar encapsulado **solo en Infrastructure** según la arquitectura.
- Presentation y Domain **nunca** deben importar `@supabase/supabase-js`.
- Las credenciales de Supabase deben manejarse mediante variables de entorno.
- El cliente de Supabase debe inicializarse una sola vez y reutilizarse.
- Se debe crear un archivo `.env.example` para documentar las variables requeridas.

---

## Alcance

Incluye:
- Instalación del paquete `@supabase/supabase-js`
- Creación de archivo de configuración de Supabase en `infrastructure/config/supabase.ts`
- Creación de archivo de manejo de variables de entorno
- Configuración de variables de entorno (`NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`)
- Creación de archivo `.env.example` con las variables requeridas
- Documentación de cómo obtener las credenciales de Supabase

No incluye:
- Implementación de repositorios o servicios que usen Supabase
- Configuración de autenticación (solo la conexión base)
- Configuración de políticas RLS o seguridad
- Migraciones de base de datos

---

## Criterios de aceptación (Given / When / Then)

### 1) Paquete de Supabase instalado

- **Dado** que se necesita conectar a Supabase
- **Cuando** se revisa `package.json`
- **Entonces** existe la dependencia `@supabase/supabase-js`
- **Y** está instalada correctamente (`npm install` funciona)

---

### 2) Cliente de Supabase configurado

- **Dado** que se necesita usar Supabase
- **Cuando** se revisa la estructura de archivos
- **Entonces** existe el archivo:
  ```
  src/infrastructure/config/supabase.ts
  ```
- **Y** exporta una instancia del cliente de Supabase
- **Y** el cliente se inicializa con las variables de entorno
- **Y** el cliente es un singleton (se crea una sola vez)

---

### 3) Variables de entorno configuradas

- **Dado** que se necesita configurar las credenciales
- **Cuando** se revisa la configuración
- **Entonces** existe el archivo:
  ```
  src/infrastructure/config/environment.ts
  ```
- **Y** exporta funciones para obtener:
  - `getSupabaseUrl()`: retorna `NEXT_PUBLIC_SUPABASE_URL`
  - `getSupabaseAnonKey()`: retorna `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- **Y** valida que las variables existan (lanza error si faltan)

---

### 4) Archivo .env.example creado

- **Dado** que otros desarrolladores necesitan configurar el proyecto
- **Cuando** se revisa la raíz del proyecto
- **Entonces** existe el archivo `.env.example`
- **Y** contiene las variables:
  ```
  NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
  NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
  ```
- **Y** incluye comentarios explicativos sobre cómo obtener estas credenciales

---

### 5) Encapsulación respetada

- **Dado** que se implementa la conexión a Supabase
- **Cuando** se revisa el código
- **Entonces** `@supabase/supabase-js` solo se importa en `infrastructure/config/supabase.ts`
- **Y** Presentation y Domain no importan Supabase
- **Y** el cliente se exporta desde `infrastructure/config/supabase.ts` para uso en servicios/repositorios

---

### 6) Documentación creada

- **Dado** que se configura Supabase
- **Cuando** se completa la implementación
- **Entonces** existe documentación en:
  - `src/infrastructure/config/README.md` (actualizado con instrucciones de Supabase)
  - `.env.example` (con comentarios sobre cómo obtener credenciales)
- **Y** se explica cómo obtener las credenciales desde el dashboard de Supabase

---

## Reglas técnicas

### Arquitectura
- Presentation solo consume UseCases vía IoC (no importa repositorios concretos).
- Domain no importa React/Next/MUI/Tailwind/Inversify/Supabase.
- Infrastructure contiene implementaciones y wiring IoC.
- **Supabase solo vive en Infrastructure**: `infrastructure/config/supabase.ts` y servicios/repositorios.

### Variables de entorno
- Usar prefijo `NEXT_PUBLIC_` para variables que deben estar disponibles en el cliente (Next.js).
- Validar que las variables existan al inicializar el cliente.
- No hardcodear credenciales en el código.

### Cliente de Supabase
- Crear una instancia singleton del cliente.
- Inicializar con `createClient()` de `@supabase/supabase-js`.
- Exportar el cliente para uso en servicios/repositorios de Infrastructure.

### Dependencias / Paquetes
- Instalar `@supabase/supabase-js` como dependencia (no devDependency).
- Si aparece error 403/conectividad:
  1) Detenerse
  2) Pedir dominios requeridos
  3) Explicar por qué se requieren
  4) No continuar

---

## Implementación sugerida

### Fase 1: Instalación
1. Instalar `@supabase/supabase-js`:
   ```bash
   npm install @supabase/supabase-js
   ```

### Fase 2: Crear configuración de entorno
1. Crear `src/infrastructure/config/environment.ts`:
   ```ts
   export function getSupabaseUrl(): string {
     const url = process.env.NEXT_PUBLIC_SUPABASE_URL;
     if (!url) {
       throw new Error('NEXT_PUBLIC_SUPABASE_URL is not defined');
     }
     return url;
   }

   export function getSupabaseAnonKey(): string {
     const key = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;
     if (!key) {
       throw new Error('NEXT_PUBLIC_SUPABASE_ANON_KEY is not defined');
     }
     return key;
   }
   ```

### Fase 3: Crear cliente de Supabase
1. Crear `src/infrastructure/config/supabase.ts`:
   ```ts
   import { createClient } from '@supabase/supabase-js';
   import { getSupabaseUrl, getSupabaseAnonKey } from './environment';

   const supabaseUrl = getSupabaseUrl();
   const supabaseAnonKey = getSupabaseAnonKey();

   export const supabaseClient = createClient(supabaseUrl, supabaseAnonKey);
   ```

### Fase 4: Crear .env.example
1. Crear `.env.example` en la raíz:
   ```
   # Supabase Configuration
   # Obtén estas credenciales desde: https://app.supabase.com/project/_/settings/api
   NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
   NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key-here
   ```

### Fase 5: Documentación
1. Actualizar `src/infrastructure/config/README.md` con:
   - Instrucciones de configuración
   - Cómo obtener credenciales de Supabase
   - Uso del cliente en servicios/repositorios

Archivos/carpetas sugeridas:
```
src/infrastructure/config/
├── environment.ts      # Manejo de variables de entorno
├── supabase.ts        # Cliente de Supabase
└── README.md          # Documentación

.env.example           # Template de variables de entorno (raíz)
```

---

## Validación

Comandos mínimos:
- `npm install` (verificar que se instala @supabase/supabase-js)
- `npm run dev` (verificar que no hay errores de compilación)
- `npm run build` (verificar que el build funciona)

Verificaciones:
- El cliente de Supabase se puede importar desde `infrastructure/config/supabase.ts`
- Las variables de entorno se validan correctamente
- No hay imports de Supabase en Presentation o Domain
- El archivo `.env.example` está presente y documentado

---

## Definición de Hecho

- [ ] Criterios de aceptación cumplidos
- [ ] `npm install` OK
- [ ] `npm run dev` OK
- [ ] `npm run build` OK
- [ ] Cliente de Supabase configurado y exportado
- [ ] Variables de entorno validadas
- [ ] `.env.example` creado y documentado
- [ ] Documentación actualizada
- [ ] Encapsulación respetada (Supabase solo en Infrastructure)
- [ ] Sin violaciones de capas
- [ ] Sin cambios fuera del alcance
- Commit sugerido:
  `feat: configure supabase connection and environment variables`

