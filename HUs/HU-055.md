# HU-055 — Formulario de Edición de Cuenta de Usuario Externo

**Como** usuario externo (adoptante)  
**Quiero** editar mi información personal y cambiar mi contraseña  
**Para** mantener actualizados mis datos y gestionar la seguridad de mi cuenta

---

## Dependencias

- HU-001 (Next.js App Router)
- HU-007 (Tailwind configurado)
- HU-010 (Atomic Design - componentes reutilizables)
- HU-011 (Conexión a Supabase configurada)
- HU-013 (Estrategia de roles y protección de rutas definida)
- HU-014 (Formik y Yup configurados)
- HU-016 (Sistema de traducciones configurado)
- HU-049 (Registro de usuarios externos implementado) - **REQUERIDO**

---

## Contexto / Notas

- Esta HU implementa el **formulario de edición de cuenta** para usuarios externos (adoptantes).
- La UI debe seguir `docs/design/account_code.html` y `docs/design/account_screen.png`.
- La ruta debe ser `/account` o `/[locale]/account`.
- Los datos provienen de:
  - `profiles`: `display_name`, `phone`
  - `auth.users`: `email` (solo lectura, no editable)
- El diseño muestra "Nombre Completo" pero en BD solo existe `display_name` → usar `display_name` como nombre completo.
- **Foto de perfil**: No existe campo `avatar_url` en `profiles` → se puede:
  - Agregar campo `avatar_url` a la tabla `profiles` (recomendado)
  - O usar Storage con path basado en `user_id`
- **Cambio de contraseña**: Se maneja a través de Supabase Auth (`auth.users`).
- **Eliminar cuenta**: Requiere confirmación y elimina usuario de `auth.users` (cascada a `profiles`).

Modelo de datos (según `docs/scripts/db.sql`):
- `profiles`:
  - `id` (uuid, FK a auth.users)
  - `role` (text, default 'external')
  - `display_name` (text, nullable)
  - `phone` (text, nullable)
  - `created_at` (timestamptz)
- `auth.users`:
  - `id` (uuid)
  - `email` (text, no editable desde UI)
  - `encrypted_password` (manejado por Supabase Auth)

---

## Diseño (OBLIGATORIO)

Referencias:
- Diseño: `docs/design/account_code.html`
- Imagen: `docs/design/account_screen.png`
- Design System: `docs/design/system.md`
- Esquema BD: `docs/scripts/db.sql`

Estructura de la página:
- **Sidebar de navegación** (opcional, puede ser layout separado):
  - Logo y nombre de usuario
  - Menú: Mi Perfil, Mis Adopciones, Mis Patrocinios, Notificaciones, Ajustes
- **Header**:
  - Título: "Configuración de la Cuenta"
  - Subtítulo descriptivo
- **Sección: Información Personal**:
  - Nombre Completo (mapea a `display_name`)
  - Nombre de Usuario / Display Name (mapea a `display_name` - puede ser el mismo campo o duplicado)
  - Teléfono (mapea a `phone`)
  - Correo Electrónico (mapea a `email` de auth.users, **solo lectura**)
- **Sección: Foto de Perfil**:
  - Preview de foto actual
  - Botón "Subir Nueva Foto"
  - Botón "Eliminar"
  - Hint: "Recomendado: JPG, PNG o GIF. Tamaño mínimo 400x400px."
- **Sección: Seguridad**:
  - Contraseña Actual
  - Nueva Contraseña
  - Confirmar Nueva Contraseña
  - Hint: "La contraseña debe tener al menos 8 caracteres e incluir una letra y un número."
- **Acciones**:
  - Botón "Cancelar"
  - Botón "Guardar Cambios"
- **Zona de Peligro**:
  - Sección destacada en rojo
  - Título: "Zona de Peligro"
  - Descripción: "Una vez que elimines tu cuenta, no hay vuelta atrás. Por favor, asegúrate."
  - Botón "Eliminar Mi Cuenta"

Reglas:
- Respetar jerarquía visual del diseño.
- Usar tokens del Design System.
- Formulario con validación (Formik/Yup).
- Responsive design.
- Estados de loading y error.

---

## Alcance

Incluye:
- Crear página `/account` (o `/[locale]/account`)
- Obtener perfil del usuario actual desde Supabase
- Formulario de edición con:
  - Información personal (display_name, phone)
  - Email (solo lectura)
  - Foto de perfil (subir/eliminar)
- Cambio de contraseña:
  - Validación de contraseña actual
  - Validación de nueva contraseña (mínimo 8 caracteres, letra y número)
  - Actualización en Supabase Auth
- Eliminar cuenta:
  - Modal de confirmación
  - Eliminación de usuario (cascada a profiles)
- Guardar cambios (actualizar `profiles`)
- Estados de loading y error
- Traducciones completas (ES/EN)

No incluye:
- Cambio de email (requiere verificación, fuera de alcance)
- Historial de cambios
- Sidebar completo de navegación (solo estructura básica si es necesario)
- Tests automatizados

---

## Criterios de aceptación (Given / When / Then)

### 1) Página de cuenta creada

- **Dado** que soy usuario externo autenticado
- **Cuando** navego a `/account`
- **Entonces** veo el formulario de edición de cuenta
- **Y** el layout respeta el diseño

---

### 2) Carga de datos del perfil

- **Dado** que tengo datos en mi perfil
- **Cuando** se carga la página
- **Entonces** los campos se prellenan con:
  - Display name
  - Teléfono
  - Email (solo lectura)
  - Foto de perfil (si existe)

---

### 3) Actualización de información personal

- **Dado** que cambio display_name o phone
- **Cuando** guardo los cambios
- **Entonces** se actualiza `profiles` en Supabase
- **Y** se muestra mensaje de éxito

---

### 4) Email solo lectura

- **Dado** el campo de email
- **Cuando** intento editarlo
- **Entonces** está deshabilitado o marcado como solo lectura
- **Y** muestra un hint explicando que no se puede cambiar

---

### 5) Subir foto de perfil

- **Dado** que selecciono una imagen
- **Cuando** hago clic en "Subir Nueva Foto"
- **Entonces** se sube a Storage (bucket `avatars` o similar)
- **Y** se actualiza `avatar_url` en `profiles`
- **Y** se muestra la nueva foto

---

### 6) Eliminar foto de perfil

- **Dado** que tengo una foto de perfil
- **Cuando** hago clic en "Eliminar"
- **Entonces** se elimina de Storage
- **Y** se actualiza `avatar_url` a `null` en `profiles`
- **Y** se muestra placeholder

---

### 7) Validación de foto

- **Dado** que intento subir una foto
- **Cuando** el archivo no cumple requisitos
- **Entonces** se muestra error:
  - Formato inválido (solo JPG, PNG, GIF)
  - Tamaño muy grande (máximo 5MB)
  - Tamaño mínimo no cumplido (400x400px recomendado)

---

### 8) Cambio de contraseña - Validación

- **Dado** que cambio la contraseña
- **Cuando** la nueva contraseña no cumple requisitos
- **Entonces** se muestra error:
  - Mínimo 8 caracteres
  - Debe incluir letra y número
  - Confirmación no coincide

---

### 9) Cambio de contraseña - Contraseña actual incorrecta

- **Dado** que ingreso contraseña actual incorrecta
- **Cuando** intento cambiar la contraseña
- **Entonces** se muestra error: "Contraseña actual incorrecta"

---

### 10) Cambio de contraseña exitoso

- **Dado** que ingreso contraseña actual correcta y nueva válida
- **Cuando** guardo los cambios
- **Entonces** se actualiza la contraseña en Supabase Auth
- **Y** se muestra mensaje de éxito
- **Y** los campos de contraseña se limpian

---

### 11) Eliminar cuenta - Modal de confirmación

- **Dado** que hago clic en "Eliminar Mi Cuenta"
- **Cuando** se abre el modal
- **Entonces** se muestra advertencia clara
- **Y** requiere confirmación explícita

---

### 12) Eliminar cuenta - Confirmación

- **Dado** que confirmo la eliminación
- **Cuando** se procesa
- **Entonces** se elimina el usuario de `auth.users`
- **Y** se elimina en cascada de `profiles`
- **Y** se redirige a la página principal
- **Y** se cierra la sesión

---

### 13) Estados de loading

- **Dado** que se cargan o guardan datos
- **Cuando** se procesa la solicitud
- **Entonces** se muestra estado de loading
- **Y** desaparece al finalizar

---

### 14) Manejo de errores

- **Dado** que ocurre un error
- **Cuando** falla la operación
- **Entonces** se muestra mensaje traducido
- **Y** la UI no se rompe

---

### 15) Traducciones

- **Dado** la implementación
- **Cuando** se revisa el código
- **Entonces** todos los textos usan `useTranslations`
- **Y** existen traducciones en `src/messages/es/account.json` y `src/messages/en/account.json`

---

## Reglas técnicas

### Arquitectura
- Presentation solo consume UseCases vía IoC.
- Domain no importa React/Next/MUI/Tailwind/Inversify/Supabase.
- Infrastructure contiene implementaciones y wiring IoC.
- Supabase solo vive en Infrastructure.

### Supabase / Queries
- Obtener perfil:
  - `SELECT * FROM profiles WHERE id = :userId`
  - Obtener email desde `auth.users` (vía Supabase Auth API)
- Actualizar perfil:
  - `UPDATE profiles SET display_name = :displayName, phone = :phone, avatar_url = :avatarUrl WHERE id = :userId`
- Cambio de contraseña:
  - Usar `supabase.auth.updateUser({ password: newPassword })` con `password` actual validado primero
- Eliminar cuenta:
  - `DELETE FROM auth.users WHERE id = :userId` (cascada elimina `profiles`)

### Foto de Perfil
- Si no existe campo `avatar_url` en `profiles`:
  - Agregar migración: `ALTER TABLE profiles ADD COLUMN avatar_url text;`
- Storage:
  - Bucket: `avatars` (o `user-avatars`)
  - Path: `{user_id}/{timestamp}-{filename}`
  - Política RLS: usuario solo puede subir/eliminar su propia foto
- Formatos permitidos: JPG, PNG, GIF
- Tamaño máximo: 5MB
- Tamaño recomendado: mínimo 400x400px

### Validaciones
- Display name: requerido, mínimo 2 caracteres
- Phone: opcional, formato válido si se proporciona
- Email: solo lectura, no validar
- Nueva contraseña: mínimo 8 caracteres, al menos una letra y un número
- Confirmación: debe coincidir con nueva contraseña

### Cambio de Contraseña
- Validar contraseña actual antes de cambiar:
  - Intentar login con email y contraseña actual
  - Si falla, mostrar error
  - Si funciona, proceder con cambio
- Usar `supabase.auth.updateUser({ password: newPassword })`

### Eliminar Cuenta
- Requiere confirmación explícita (modal)
- Eliminar usuario de `auth.users` (Supabase Auth)
- Cascada elimina `profiles`
- Cerrar sesión y redirigir a home

### Traducciones
- Usar `useTranslations('account')`.
- No hardcodear textos.

### Dependencias / Paquetes
- No agregar dependencias nuevas.
- Usar Formik/Yup existentes.

---

## Implementación sugerida

```
src/app/[locale]/account/page.tsx

src/presentation/components/account/
├── AccountSettingsPage.tsx
├── AccountPersonalInfo.tsx
├── AccountProfilePicture.tsx
├── AccountSecurity.tsx
├── AccountDeleteSection.tsx
└── accountValidation.ts

src/domain/
├── models/
│   └── UserProfile.ts
├── repositories/
│   └── IUserProfileRepository.ts (getUserProfile, updateUserProfile, deleteUserAccount)
└── usecases/
    └── account/
        ├── GetUserProfileUseCase.ts
        ├── UpdateUserProfileUseCase.ts
        ├── ChangePasswordUseCase.ts
        └── DeleteUserAccountUseCase.ts

src/infrastructure/
├── repositories/
│   └── UserProfileRepository.ts (implementación Supabase)
└── ioc/
    └── bindings actualizados

src/messages/
├── es/
│   └── account.json
└── en/
    └── account.json
```

### Migración SQL sugerida (si no existe avatar_url):
```sql
ALTER TABLE profiles ADD COLUMN avatar_url text;
```

---

## Validación

Comandos mínimos:
- `npm run dev`
- `npm run build`

Verificaciones:
- Formulario se ve igual al diseño
- Datos se cargan correctamente
- Actualización de perfil funciona
- Subida/eliminación de foto funciona
- Cambio de contraseña funciona
- Eliminación de cuenta funciona con confirmación
- Traducciones completas

---

## Definición de Hecho

- [ ] Criterios de aceptación cumplidos
- [ ] `npm run dev` OK
- [ ] `npm run build` OK
- [ ] Página de cuenta creada
- [ ] Formulario de edición funcional
- [ ] Actualización de perfil en Supabase
- [ ] Foto de perfil (subir/eliminar) funcional
- [ ] Cambio de contraseña funcional
- [ ] Eliminación de cuenta con confirmación funcional
- [ ] Traducciones incluidas (ES/EN)
- [ ] Sin violaciones de capas
- [ ] Sin cambios fuera del alcance
- Commit sugerido:
  `feat: add external user account settings page`

---

## Notas Adicionales

- **Campo avatar_url**: Si no existe en `profiles`, se debe agregar mediante migración SQL.
- **Nombre Completo vs Display Name**: El diseño muestra ambos campos, pero en BD solo existe `display_name`. Se puede:
  - Usar `display_name` para ambos (recomendado)
  - O agregar campo `full_name` a `profiles` si se requiere separación
- **Email no editable**: El cambio de email requiere verificación y está fuera del alcance de esta HU.
- **Sidebar**: El diseño muestra sidebar de navegación, pero puede implementarse como layout separado en HU futura.
