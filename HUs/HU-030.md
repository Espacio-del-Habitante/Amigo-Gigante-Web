# HU-030 — Crear Producto (Fundación) con Supabase

**Como** usuario de una fundación  
**Quiero** agregar un nuevo producto a mi Tienda Solidaria  
**Para** publicarlo y recaudar fondos

---

## Dependencias

- HU-014 (Formik y Yup configurados)
- HU-016 (Sistema de traducciones configurado)
- HU-018 (Layout del dashboard de fundaciones con sidebar) - **REQUERIDO**
- HU-029 (Gestión de productos) - **REQUERIDO**
- HU-011 (Conexión a Supabase configurada)

---

## Contexto / Notas

- Esta HU implementa la **pantalla de creación de producto** desde la gestión de tienda.
- La UI debe seguir `docs/design/add_product.png` y `docs/design/add_product_code.html`.
- La ruta debe ser `/foundations/products/new`.
- Los datos se guardan en `products`.
- **No existe categoría ni stock en BD** → no se incluyen campos de categoría/stock.
- El campo de imagen se mapea a `image_url`.

Modelo de datos (según `docs/scripts/db.sql`):
- `products`: `id`, `foundation_id`, `name`, `description`, `price`, `image_url`, `is_published`, `created_at`

---

## Diseño (OBLIGATORIO)

Referencias:
- Diseño: `docs/design/add_product_code.html`
- Imagen: `docs/design/add_product.png`
- Design System: `docs/design/system.md`
- Esquema BD: `docs/scripts/db.sql`

Estructura del formulario:
- Breadcrumbs
- Header (título + subtítulo)
- Form Card:
  - Product Name
  - Price (USD)
  - Description
  - Product Image (upload)
  - Visibility (toggle)
  - Botones: Cancel / Save Product
- Footer hint

Reglas:
- Respetar jerarquía visual del diseño.
- Usar tokens del Design System.
- Validaciones visibles con Formik/Yup.
- Responsive.

---

## Alcance

Incluye:
- Crear página `/foundations/products/new`
- Formulario completo con Formik y Yup
- Validación de campos
- Guardar producto en Supabase
- Asociar `foundation_id` automáticamente
- Guardar `image_url` (subida a Storage o URL directa)
- Manejar `is_published`
- Estados de loading y error
- Redirección a `/foundations/products` tras crear
- Traducciones completas (ES/EN)

No incluye:
- Edición de productos (HU futura)
- Upload avanzado (redimensionado, múltiples imágenes)
- Categorías o stock
- Tests automatizados

---

## Criterios de aceptación (Given / When / Then)

### 1) Página de creación accesible

- **Dado** la gestión de productos
- **Cuando** hago clic en “Add New Product”
- **Entonces** navego a `/foundations/products/new`
- **Y** veo el formulario completo

---

### 2) Validaciones del formulario

- **Dado** el formulario vacío
- **Cuando** intento guardar
- **Entonces** se muestran errores:
  - Product Name requerido
  - Price requerido y >= 0
  - Description requerida
  - Image requerida

---

### 3) Creación en Supabase

- **Dado** datos válidos
- **Cuando** envío el formulario
- **Entonces** se crea un registro en `products`
- **Y** `foundation_id` corresponde a la fundación del usuario
- **Y** `is_published` se guarda según toggle

---

### 4) Imagen del producto

- **Dado** que subo una imagen
- **Cuando** guardo el producto
- **Entonces** se guarda `image_url` en la BD
- **Y** se ve en la tabla de HU-029

---

### 5) Estados de loading y error

- **Dado** que se envía el formulario
- **Cuando** Supabase procesa la solicitud
- **Entonces** se muestra loading
- **Y** si hay error se muestra mensaje traducido

---

### 6) Redirección

- **Dado** creación exitosa
- **Cuando** finaliza el proceso
- **Entonces** se redirige a `/foundations/products`
- **Y** el producto aparece en la lista

---

### 7) Traducciones

- **Dado** la UI implementada
- **Cuando** se revisa el código
- **Entonces** todos los textos usan `useTranslations`
- **Y** existen traducciones en `src/messages/es/product-form.json` y `src/messages/en/product-form.json`

---

## Reglas técnicas

### Arquitectura
- Presentation solo consume UseCases vía IoC.
- Domain no importa React/Next/MUI/Tailwind/Inversify/Supabase.
- Infrastructure contiene implementaciones y wiring IoC.
- Supabase solo vive en Infrastructure.

### Supabase / Inserción
- Insert:
  - `INSERT INTO products (foundation_id, name, description, price, image_url, is_published)`
- Obtener `foundation_id` desde `foundation_members`.

### Imagen
- Si existe Storage configurado:
  - Subir archivo a bucket (ej: `products`)
  - Generar URL pública y guardar en `image_url`
- Si no hay Storage:
  - Permitir input de URL directa
- No inventar campos adicionales.

### Traducciones
- Usar `useTranslations('productForm')`.
- No hardcodear textos.

---

## Implementación sugerida

```
src/app/[locale]/foundations/products/new/page.tsx

src/presentation/components/products/
├── ProductFormPage.tsx
├── ProductForm.tsx
└── productFormValidation.ts

src/domain/
├── repositories/
│   └── IProductRepository.ts (createProduct)
└── usecases/
    └── products/
        └── CreateProductUseCase.ts

src/infrastructure/
├── repositories/
│   └── ProductRepository.ts (createProduct + upload)
└── ioc/
    └── bindings actualizados

src/messages/
├── es/
│   └── product-form.json
└── en/
    └── product-form.json
```

---

## Validación

Comandos mínimos:
- `npm run dev`
- `npm run build`

Verificaciones:
- Formulario funciona y valida
- Producto se crea en Supabase
- Redirección correcta
- Traducciones completas

---

## Definición de Hecho

- [ ] Criterios de aceptación cumplidos
- [ ] `npm run dev` OK
- [ ] `npm run build` OK
- [ ] Página de creación creada
- [ ] Producto creado en Supabase
- [ ] `foundation_id` asignado correctamente
- [ ] `image_url` guardado
- [ ] Redirección a lista
- [ ] Traducciones incluidas (ES/EN)
- [ ] Sin violaciones de capas
- [ ] Sin cambios fuera del alcance
- Commit sugerido:
  `feat: add product creation form with supabase`

