# HU-033 — Editar Producto (Fundación) con Supabase

**Como** usuario de una fundación  
**Quiero** editar los datos de un producto existente  
**Para** mantener actualizado mi catálogo en la Tienda Solidaria

---

## Dependencias

- HU-014 (Formik y Yup configurados)
- HU-016 (Sistema de traducciones configurado)
- HU-018 (Layout del dashboard de fundaciones con sidebar) - **REQUERIDO**
- HU-029 (Gestión de productos) - **REQUERIDO**
- HU-030 (Crear producto) - **REQUERIDO**
- HU-011 (Conexión a Supabase configurada)

---

## Contexto / Notas

- Esta HU implementa la **edición de productos** usando el mismo formulario de HU-030.
- La ruta debe ser `/foundations/products/[id]/edit`.
- Los datos se cargan desde `products`.
- El usuario solo puede editar productos de su propia fundación.
- El formulario debe estar prellenado con los valores actuales.
- El modelo de datos es el de `docs/scripts/db.sql`.

Modelo de datos:
- `products`: `id`, `foundation_id`, `name`, `description`, `price`, `image_url`, `is_published`, `created_at`

---

## Diseño (OBLIGATORIO)

Referencias:
- Diseño: `docs/design/add_product_code.html`
- Imagen: `docs/design/add_product.png`
- Design System: `docs/design/system.md`
- Esquema BD: `docs/scripts/db.sql`

Reglas:
- Reutilizar el diseño del formulario de HU-030.
- El título y breadcrumbs deben indicar **edición**.
- Campos prellenados con datos actuales.
- Mantener validaciones y estados visuales.

---

## Alcance

Incluye:
- Crear página `/foundations/products/[id]/edit`
- Cargar datos del producto desde Supabase
- Prellenar el formulario
- Actualizar `products` en Supabase
- Actualizar `image_url` si cambia la imagen
- Manejar `is_published`
- Estados de loading y error
- Redirección a `/foundations/products` al guardar
- Traducciones completas (ES/EN)

No incluye:
- Creación de productos (HU-030)
- Eliminación de productos (HU-034)
- Historial de cambios
- Tests automatizados

---

## Criterios de aceptación (Given / When / Then)

### 1) Ruta de edición creada

- **Dado** un producto existente
- **Cuando** navego a `/foundations/products/[id]/edit`
- **Entonces** veo el formulario de edición
- **Y** el layout usa el dashboard de fundaciones

---

### 2) Datos prellenados

- **Dado** un producto con datos en BD
- **Cuando** se carga la página
- **Entonces** los campos se prellenan con los valores actuales

---

### 3) Actualización de datos básicos

- **Dado** cambios en nombre, precio o descripción
- **Cuando** guardo
- **Entonces** se actualizan en `products`

---

### 4) Actualización de imagen

- **Dado** una nueva imagen seleccionada
- **Cuando** guardo
- **Entonces** se actualiza `image_url` en BD
- **Y** se muestra la nueva imagen en la lista

---

### 5) Publicación

- **Dado** el toggle de visibilidad
- **Cuando** guardo cambios
- **Entonces** `is_published` se actualiza según selección

---

### 6) Validaciones

- **Dado** campos requeridos vacíos
- **Cuando** intento guardar
- **Entonces** se muestran errores de validación (Formik/Yup)

---

### 7) Estados de loading y error

- **Dado** que se guarda el formulario
- **Cuando** Supabase procesa la solicitud
- **Entonces** se muestra loading
- **Y** se muestra error traducido si falla

---

### 8) Traducciones

- **Dado** la UI implementada
- **Cuando** se revisa el código
- **Entonces** todos los textos usan `useTranslations`
- **Y** existen traducciones en `src/messages/es/product-form.json` y `src/messages/en/product-form.json`

---

## Reglas técnicas

### Arquitectura
- Presentation solo consume UseCases vía IoC.
- Domain no importa React/Next/MUI/Tailwind/Inversify/Supabase.
- Infrastructure contiene implementaciones y wiring IoC.
- Supabase solo vive en Infrastructure.

### Supabase / Queries
- Obtener producto:
  - `SELECT * FROM products WHERE id = :id AND foundation_id = :foundationId`
- Actualizar:
  - `UPDATE products SET ... WHERE id = :id AND foundation_id = :foundationId`

### Imagen
- Si existe Storage:
  - Subir archivo y guardar URL pública
- Si no hay Storage:
  - Permitir URL directa

### Traducciones
- Usar `useTranslations('productForm')`.
- No hardcodear textos.

---

## Implementación sugerida

```
src/app/[locale]/foundations/products/[id]/edit/page.tsx

src/presentation/components/products/
├── ProductForm.tsx (reutilizable)
└── productFormValidation.ts

src/domain/
├── repositories/
│   └── IProductRepository.ts (getProductById, updateProduct)
└── usecases/
    └── products/
        └── UpdateProductUseCase.ts

src/infrastructure/
└── repositories/
    └── ProductRepository.ts (implementación Supabase)
```

---

## Validación

Comandos mínimos:
- `npm run dev`
- `npm run build`

Verificaciones:
- Formulario prellenado
- Actualización en Supabase
- Redirección correcta
- Traducciones completas

---

## Definición de Hecho

- [ ] Criterios de aceptación cumplidos
- [ ] `npm run dev` OK
- [ ] `npm run build` OK
- [ ] Página de edición creada
- [ ] Actualización en Supabase funcionando
- [ ] Imagen actualizada correctamente
- [ ] Traducciones incluidas (ES/EN)
- [ ] Sin violaciones de capas
- [ ] Sin cambios fuera del alcance
- Commit sugerido:
  `feat: add edit product form with supabase`

