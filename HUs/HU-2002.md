# HU-2002 ‚Äî Auditor√≠a de Seguridad Inform√°tica

**Como** desarrollador  
**Quiero** que Codex act√∫e como auditor de seguridad inform√°tica  
**Para** detectar posibles vulnerabilidades y extraer tareas de mejora sin modificar el c√≥digo existente

---

## Dependencias

- HU-011 (Conexi√≥n a Supabase configurada)
- HU-013 (Estrategia de roles y protecci√≥n de rutas)
- HU-2001 (RLS activado en base de datos)

---

## Contexto / Notas

- Esta HU es una **auditor√≠a de seguridad** que NO modifica c√≥digo.
- El objetivo es **identificar vulnerabilidades** y **extraer tareas de mejora**.
- Se analizan m√∫ltiples aspectos: autenticaci√≥n, autorizaci√≥n, validaci√≥n, exposici√≥n de datos, configuraci√≥n, etc.
- Los hallazgos se documentan como **tareas pendientes** para futuras HUs.
- Esta auditor√≠a se basa en el estado actual del c√≥digo (sin cambios).

---

## Alcance

Incluye:
- An√°lisis de vulnerabilidades de seguridad
- Identificaci√≥n de riesgos potenciales
- Extracci√≥n de tareas de mejora
- Documentaci√≥n de hallazgos por categor√≠a
- Priorizaci√≥n de tareas seg√∫n severidad

No incluye:
- Modificaci√≥n de c√≥digo existente
- Implementaci√≥n de correcciones
- Cambios en funcionalidad
- Actualizaci√≥n de dependencias

---

## Hallazgos de Seguridad

### üî¥ CR√çTICO - Requiere atenci√≥n inmediata

#### 1. Exposici√≥n de credenciales en el cliente
**Ubicaci√≥n**: `src/infrastructure/config/supabase.ts`, `src/infrastructure/config/environment.ts`

**Problema**: 
- Las variables `NEXT_PUBLIC_SUPABASE_URL` y `NEXT_PUBLIC_SUPABASE_ANON_KEY` est√°n expuestas en el cliente
- El prefijo `NEXT_PUBLIC_` hace que estas variables sean accesibles en el bundle del navegador
- Aunque la `ANON_KEY` est√° dise√±ada para ser p√∫blica, su exposici√≥n permite:
  - Ataques de rate limiting
  - Uso no autorizado de la API si no hay RLS adecuado
  - An√°lisis de la estructura de la base de datos

**Tareas**:
- [ ] **TAREA-2002-001**: Revisar si realmente necesitamos exponer `NEXT_PUBLIC_SUPABASE_ANON_KEY` en el cliente
- [ ] **TAREA-2002-002**: Considerar usar Supabase SSR para operaciones sensibles (solo en servidor)
- [ ] **TAREA-2002-003**: Implementar rate limiting en Supabase para prevenir abuso de la ANON_KEY
- [ ] **TAREA-2002-004**: Verificar que todas las tablas tengan RLS activado antes de producci√≥n
- [ ] **TAREA-2002-005**: Documentar qu√© operaciones deben ejecutarse solo en servidor vs cliente

#### 2. Sesi√≥n mock en desarrollo expuesta en producci√≥n
**Ubicaci√≥n**: `src/proxy.ts` l√≠neas 143-166

**Problema**:
- El c√≥digo de sesi√≥n mock usa `process.env.ENV === "development"` pero podr√≠a activarse accidentalmente en producci√≥n
- Si `ENV` no est√° definido o tiene un valor inesperado, podr√≠a permitir acceso no autorizado
- Los tokens mock son predecibles y podr√≠an ser explotados

**Tareas**:
- [ ] **TAREA-2002-006**: Cambiar la verificaci√≥n a `process.env.NODE_ENV === "development"` (m√°s est√°ndar)
- [ ] **TAREA-2002-007**: Agregar validaci√≥n adicional para asegurar que el mock solo funcione en localhost
- [ ] **TAREA-2002-008**: Eliminar completamente el c√≥digo mock antes de deploy a producci√≥n
- [ ] **TAREA-2002-009**: Crear script de validaci√≥n pre-deploy que detecte c√≥digo mock

#### 3. Logging de informaci√≥n sensible
**Ubicaci√≥n**: `src/proxy.ts` l√≠nea 163, `src/app/[locale]/layout.tsx` l√≠neas 83-85

**Problema**:
- Se registran paths, locales y otros datos en `console.log` que podr√≠an exponer informaci√≥n
- En producci√≥n, estos logs podr√≠an ser accesibles y revelar estructura de rutas
- Los logs de desarrollo no deber√≠an estar en c√≥digo de producci√≥n

**Tareas**:
- [ ] **TAREA-2002-010**: Eliminar todos los `console.log` de c√≥digo de producci√≥n
- [ ] **TAREA-2002-011**: Implementar sistema de logging estructurado (ej: winston, pino)
- [ ] **TAREA-2002-012**: Configurar niveles de log (debug, info, warn, error) por entorno
- [ ] **TAREA-2002-013**: Asegurar que logs no contengan informaci√≥n sensible (tokens, emails, IDs)

#### 4. Falta de validaci√≥n de rate limiting
**Ubicaci√≥n**: M√∫ltiples repositorios

**Problema**:
- No hay protecci√≥n contra ataques de fuerza bruta en login/registro
- No hay l√≠mites en creaci√≥n de recursos (animales, productos, solicitudes)
- Un atacante podr√≠a abusar de endpoints p√∫blicos

**Tareas**:
- [ ] **TAREA-2002-014**: Implementar rate limiting en Supabase para autenticaci√≥n
- [ ] **TAREA-2002-015**: Agregar rate limiting a nivel de aplicaci√≥n (middleware)
- [ ] **TAREA-2002-016**: Configurar l√≠mites por usuario/IP para creaci√≥n de recursos
- [ ] **TAREA-2002-017**: Implementar CAPTCHA en formularios cr√≠ticos (registro, adopci√≥n)

### üü° ALTO - Requiere atenci√≥n prioritaria

#### 5. Validaci√≥n de entrada insuficiente
**Ubicaci√≥n**: M√∫ltiples formularios y repositorios

**Problema**:
- La validaci√≥n se hace principalmente en el cliente (Yup)
- No hay validaci√≥n adicional en el servidor
- Los repositorios conf√≠an en que los datos ya est√°n validados
- Posible inyecci√≥n a trav√©s de par√°metros de b√∫squeda

**Tareas**:
- [ ] **TAREA-2002-018**: Agregar validaci√≥n de esquemas en repositorios (usando Zod o similar)
- [ ] **TAREA-2002-019**: Sanitizar todos los inputs de b√∫squeda (`.ilike`, `.or`)
- [ ] **TAREA-2002-020**: Validar tipos y rangos de datos antes de insertar en BD
- [ ] **TAREA-2002-021**: Implementar validaci√≥n de longitud m√°xima en todos los campos de texto
- [ ] **TAREA-2002-022**: Validar formatos de URLs antes de guardar (image_url, logo_url)

**Ejemplo de riesgo**:
```typescript
// src/infrastructure/repositories/ProductRepository.ts l√≠nea 189
request = request.or(`name.ilike.%${normalizedQuery}%,description.ilike.%${normalizedQuery}%`);
// Si normalizedQuery contiene caracteres especiales, podr√≠a causar problemas
```

#### 6. Falta de headers de seguridad HTTP
**Ubicaci√≥n**: `next.config.ts`, middleware

**Problema**:
- No se configuran headers de seguridad est√°ndar (CSP, HSTS, X-Frame-Options, etc.)
- Falta protecci√≥n contra XSS, clickjacking, MIME sniffing
- No hay pol√≠tica de contenido seguro (CSP)

**Tareas**:
- [ ] **TAREA-2002-023**: Configurar headers de seguridad en `next.config.ts`:
  - `X-Content-Type-Options: nosniff`
  - `X-Frame-Options: DENY` o `SAMEORIGIN`
  - `X-XSS-Protection: 1; mode=block`
  - `Referrer-Policy: strict-origin-when-cross-origin`
  - `Permissions-Policy` (anteriormente Feature-Policy)
- [ ] **TAREA-2002-024**: Implementar Content Security Policy (CSP) estricta
- [ ] **TAREA-2002-025**: Configurar HSTS (Strict-Transport-Security) para HTTPS
- [ ] **TAREA-2002-026**: Agregar header `X-DNS-Prefetch-Control`

#### 7. Validaci√≥n de archivos insuficiente
**Ubicaci√≥n**: `src/infrastructure/repositories/AdoptionRequestRepository.ts`, `ProductRepository.ts`

**Problema**:
- La validaci√≥n de archivos se hace solo en el cliente
- No se valida el tipo MIME real del archivo (solo extensi√≥n)
- No se escanean archivos maliciosos
- El sanitizado de nombres es b√°sico

**Tareas**:
- [ ] **TAREA-2002-027**: Validar tipo MIME real del archivo en el servidor (magic bytes)
- [ ] **TAREA-2002-028**: Implementar l√≠mites de tama√±o m√°s estrictos por tipo de archivo
- [ ] **TAREA-2002-029**: Agregar validaci√≥n de dimensiones para im√°genes
- [ ] **TAREA-2002-030**: Mejorar sanitizaci√≥n de nombres de archivo (prevenir path traversal)
- [ ] **TAREA-2002-031**: Considerar escaneo de virus/malware para documentos de adopci√≥n
- [ ] **TAREA-2002-032**: Validar que las URLs de im√°genes sean realmente im√°genes antes de guardar

**Ejemplo de riesgo**:
```typescript
// src/infrastructure/repositories/AdoptionRequestRepository.ts l√≠nea 414
private sanitizeFileName(fileName: string): string {
  return fileName.replace(/[^a-z0-9.\-_]/gi, "-").toLowerCase();
}
// No previene path traversal como "../../etc/passwd"
```

#### 8. Manejo de errores expone informaci√≥n
**Ubicaci√≥n**: M√∫ltiples repositorios

**Problema**:
- Los mensajes de error pueden exponer detalles de la estructura de la BD
- Errores de Supabase se traducen pero pueden filtrar informaci√≥n
- No hay diferenciaci√≥n entre errores de usuario y errores del sistema

**Tareas**:
- [ ] **TAREA-2002-033**: Crear sistema de c√≥digos de error gen√©ricos (no exponer detalles t√©cnicos)
- [ ] **TAREA-2002-034**: Loggear errores detallados solo en servidor (nunca enviar al cliente)
- [ ] **TAREA-2002-035**: Implementar manejo centralizado de errores
- [ ] **TAREA-2002-036**: Validar que mensajes de error no contengan informaci√≥n sensible

### üü¢ MEDIO - Mejoras recomendadas

#### 9. Falta de CSRF protection
**Ubicaci√≥n**: Formularios y endpoints

**Problema**:
- No hay protecci√≥n expl√≠cita contra CSRF
- Next.js tiene protecci√≥n b√°sica pero deber√≠a ser expl√≠cita

**Tareas**:
- [ ] **TAREA-2002-037**: Implementar tokens CSRF para formularios cr√≠ticos
- [ ] **TAREA-2002-038**: Validar origen de requests en operaciones sensibles
- [ ] **TAREA-2002-039**: Configurar SameSite cookies apropiadamente

#### 10. Autenticaci√≥n sin 2FA/MFA
**Ubicaci√≥n**: `src/infrastructure/repositories/AuthRepository.ts`

**Problema**:
- Solo se usa email/password
- No hay autenticaci√≥n de dos factores
- Las cuentas de administrador son especialmente vulnerables

**Tareas**:
- [ ] **TAREA-2002-040**: Evaluar implementaci√≥n de 2FA para usuarios admin
- [ ] **TAREA-2002-041**: Considerar 2FA opcional para usuarios de fundaci√≥n
- [ ] **TAREA-2002-042**: Implementar recuperaci√≥n segura de contrase√±a
- [ ] **TAREA-2002-043**: Agregar verificaci√≥n de email obligatoria

#### 11. Falta de auditor√≠a y logging de seguridad
**Ubicaci√≥n**: Sistema completo

**Problema**:
- No se registran eventos de seguridad (logins fallidos, cambios de rol, etc.)
- No hay trazabilidad de acciones sensibles
- Dif√≠cil detectar comportamientos sospechosos

**Tareas**:
- [ ] **TAREA-2002-044**: Implementar tabla de auditor√≠a para eventos de seguridad
- [ ] **TAREA-2002-045**: Registrar todos los intentos de login (exitosos y fallidos)
- [ ] **TAREA-2002-046**: Registrar cambios de roles y permisos
- [ ] **TAREA-2002-047**: Registrar accesos a datos sensibles
- [ ] **TAREA-2002-048**: Implementar alertas para patrones sospechosos

#### 12. Pol√≠ticas RLS incompletas
**Ubicaci√≥n**: `docs/scripts/rls_policies.sql`

**Problema**:
- Las pol√≠ticas RLS est√°n definidas pero pueden tener gaps
- No hay pol√≠ticas de DELETE expl√≠citas
- Falta validaci√≥n de que todas las tablas tengan RLS activo

**Tareas**:
- [ ] **TAREA-2002-049**: Agregar pol√≠ticas DELETE para todas las tablas
- [ ] **TAREA-2002-050**: Crear script de validaci√≥n que verifique RLS en todas las tablas
- [ ] **TAREA-2002-051**: Documentar qu√© operaciones requieren permisos especiales
- [ ] **TAREA-2002-052**: Revisar pol√≠ticas de actualizaci√≥n para prevenir escalaci√≥n de privilegios

#### 13. Dependencias desactualizadas o vulnerables
**Ubicaci√≥n**: `package.json`

**Problema**:
- No se verifica regularmente vulnerabilidades en dependencias
- Algunas dependencias pueden tener versiones con vulnerabilidades conocidas

**Tareas**:
- [ ] **TAREA-2002-053**: Configurar `npm audit` en CI/CD
- [ ] **TAREA-2002-054**: Implementar Dependabot o similar para actualizaciones autom√°ticas
- [ ] **TAREA-2002-055**: Revisar y actualizar dependencias regularmente
- [ ] **TAREA-2002-056**: Documentar proceso de actualizaci√≥n de dependencias

#### 14. Falta de validaci√≥n de CORS
**Ubicaci√≥n**: Configuraci√≥n de Next.js y Supabase

**Problema**:
- No hay configuraci√≥n expl√≠cita de CORS
- Supabase maneja CORS pero deber√≠a validarse

**Tareas**:
- [ ] **TAREA-2002-057**: Configurar CORS expl√≠citamente en Next.js si hay API routes
- [ ] **TAREA-2002-058**: Validar configuraci√≥n de CORS en Supabase
- [ ] **TAREA-2002-059**: Restringir or√≠genes permitidos a dominios conocidos

#### 15. Falta de protecci√≥n contra enumeraci√≥n
**Ubicaci√≥n**: Autenticaci√≥n y recursos

**Problema**:
- Los mensajes de error pueden permitir enumeraci√≥n de usuarios
- Los IDs de recursos pueden ser predecibles

**Tareas**:
- [ ] **TAREA-2002-060**: Usar mensajes de error gen√©ricos en login (no distinguir entre usuario inexistente y contrase√±a incorrecta)
- [ ] **TAREA-2002-061**: Considerar usar UUIDs en lugar de IDs secuenciales para recursos sensibles
- [ ] **TAREA-2002-062**: Implementar rate limiting por IP para prevenir enumeraci√≥n

### üîµ BAJO - Mejoras opcionales

#### 16. Falta de Content Security Policy estricta
**Ubicaci√≥n**: Headers HTTP

**Problema**:
- No hay CSP configurada
- Permite ejecuci√≥n de scripts inline potencialmente peligrosos

**Tareas**:
- [ ] **TAREA-2002-063**: Implementar CSP con nonces o hashes para scripts
- [ ] **TAREA-2002-064**: Configurar CSP en modo report-only primero
- [ ] **TAREA-2002-065**: Validar que todas las fuentes externas est√©n permitidas expl√≠citamente

#### 17. Falta de subresource integrity
**Ubicaci√≥n**: Recursos externos

**Problema**:
- No se valida integridad de recursos externos (CDNs, librer√≠as)

**Tareas**:
- [ ] **TAREA-2002-066**: Implementar SRI para recursos externos cr√≠ticos
- [ ] **TAREA-2002-067**: Validar hashes de recursos en tiempo de build

#### 18. Falta de validaci√≥n de sesi√≥n en tiempo real
**Ubicaci√≥n**: `src/infrastructure/repositories/AuthRepository.ts`

**Problema**:
- Las sesiones se validan pero no se revocan inmediatamente si hay cambios

**Tareas**:
- [ ] **TAREA-2002-068**: Implementar invalidaci√≥n de sesi√≥n cuando cambia el rol
- [ ] **TAREA-2002-069**: Agregar verificaci√≥n peri√≥dica de validez de sesi√≥n
- [ ] **TAREA-2002-070**: Implementar logout forzado para usuarios comprometidos

#### 19. Falta de encriptaci√≥n de datos sensibles
**Ubicaci√≥n**: Base de datos

**Problema**:
- Algunos datos sensibles (emails, tel√©fonos) se almacenan en texto plano
- No hay encriptaci√≥n a nivel de aplicaci√≥n

**Tareas**:
- [ ] **TAREA-2002-071**: Evaluar necesidad de encriptar datos sensibles en reposo
- [ ] **TAREA-2002-072**: Considerar encriptaci√≥n de campos como tel√©fono, direcci√≥n
- [ ] **TAREA-2002-073**: Validar que Supabase use encriptaci√≥n en tr√°nsito (TLS)

#### 20. Falta de pruebas de seguridad
**Ubicaci√≥n**: Testing

**Problema**:
- No hay tests espec√≠ficos de seguridad
- No se validan vulnerabilidades conocidas

**Tareas**:
- [ ] **TAREA-2002-074**: Implementar tests de seguridad (OWASP Top 10)
- [ ] **TAREA-2002-075**: Agregar tests de autorizaci√≥n (verificar que usuarios no pueden acceder a recursos de otros)
- [ ] **TAREA-2002-076**: Implementar tests de inyecci√≥n (SQL, XSS)
- [ ] **TAREA-2002-077**: Agregar tests de validaci√≥n de entrada

---

## Resumen de Tareas por Prioridad

### Cr√≠tico (5 tareas principales)
1. Exposici√≥n de credenciales
2. Sesi√≥n mock en producci√≥n
3. Logging de informaci√≥n sensible
4. Falta de rate limiting

### Alto (8 tareas principales)
5. Validaci√≥n de entrada insuficiente
6. Falta de headers de seguridad
7. Validaci√≥n de archivos insuficiente
8. Manejo de errores expone informaci√≥n

### Medio (11 tareas principales)
9. Falta de CSRF protection
10. Autenticaci√≥n sin 2FA
11. Falta de auditor√≠a
12. Pol√≠ticas RLS incompletas
13. Dependencias vulnerables
14. Falta de validaci√≥n de CORS
15. Falta de protecci√≥n contra enumeraci√≥n

### Bajo (8 tareas principales)
16. CSP estricta
17. Subresource integrity
18. Validaci√≥n de sesi√≥n en tiempo real
19. Encriptaci√≥n de datos sensibles
20. Falta de pruebas de seguridad

**Total: 77 tareas identificadas**

---

## Criterios de Aceptaci√≥n (Given / When / Then)

### 1) Auditor√≠a completada

- **Dado** que se necesita una auditor√≠a de seguridad
- **Cuando** Codex analiza el c√≥digo
- **Entonces** se identifican todas las vulnerabilidades potenciales
- **Y** se categorizan por severidad (Cr√≠tico, Alto, Medio, Bajo)
- **Y** se documentan como tareas numeradas

---

### 2) Tareas extra√≠das sin modificar c√≥digo

- **Dado** que se realiza la auditor√≠a
- **Cuando** se identifican vulnerabilidades
- **Entonces** se crean tareas de mejora (TAREA-2002-XXX)
- **Y** NO se modifica ning√∫n archivo de c√≥digo
- **Y** NO se implementan correcciones

---

### 3) Documentaci√≥n completa

- **Dado** que se completan los hallazgos
- **Cuando** se revisa la HU-2002
- **Entonces** cada vulnerabilidad tiene:
  - Ubicaci√≥n espec√≠fica en el c√≥digo
  - Descripci√≥n del problema
  - Tareas asociadas numeradas
  - Ejemplos de c√≥digo cuando aplica

---

## Reglas t√©cnicas

### Auditor√≠a
- NO modificar c√≥digo existente
- NO implementar correcciones
- Solo identificar y documentar vulnerabilidades
- Priorizar por severidad y impacto

### Documentaci√≥n
- Cada tarea debe ser espec√≠fica y accionable
- Incluir ubicaciones exactas en el c√≥digo
- Proporcionar contexto suficiente para entender el riesgo

---

## Validaci√≥n

Comandos m√≠nimos:
- Revisar que no se modific√≥ ning√∫n archivo de c√≥digo
- Verificar que todas las tareas est√°n numeradas
- Confirmar que las vulnerabilidades est√°n categorizadas

Verificaciones:
- ‚úÖ No hay cambios en archivos de c√≥digo
- ‚úÖ Todas las tareas tienen formato TAREA-2002-XXX
- ‚úÖ Vulnerabilidades categorizadas por severidad
- ‚úÖ Ubicaciones espec√≠ficas documentadas

---

## Definici√≥n de Hecho

- [ ] Auditor√≠a completada
- [ ] Todas las vulnerabilidades identificadas
- [ ] Tareas extra√≠das y numeradas (77 tareas)
- [ ] Vulnerabilidades categorizadas por severidad
- [ ] Ubicaciones espec√≠ficas documentadas
- [ ] NO se modific√≥ ning√∫n archivo de c√≥digo
- [ ] NO se implementaron correcciones
- [ ] Documentaci√≥n completa y clara
- Commit sugerido:
  `docs: add security audit findings (HU-2002) - 77 improvement tasks identified`

---

## Notas Adicionales

### Pr√≥ximos Pasos Recomendados

1. **Priorizar tareas cr√≠ticas**: Comenzar con TAREA-2002-001 a TAREA-2002-017
2. **Crear HUs espec√≠ficas**: Agrupar tareas relacionadas en HUs de implementaci√≥n
3. **Implementar gradualmente**: No intentar corregir todo de una vez
4. **Validar en staging**: Probar todas las correcciones en ambiente de staging antes de producci√≥n
5. **Documentar decisiones**: Registrar por qu√© se implementan o no ciertas medidas

### Recursos de Referencia

- OWASP Top 10: https://owasp.org/www-project-top-ten/
- Next.js Security: https://nextjs.org/docs/advanced-features/security-headers
- Supabase Security: https://supabase.com/docs/guides/platform/security
- Row Level Security: https://supabase.com/docs/guides/auth/row-level-security
