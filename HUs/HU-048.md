# HU-048 — Solicitar información adicional al adoptante vía correo electrónico

**Como** miembro de fundación  
**Quiero** poder enviar un correo electrónico al adoptante solicitando información adicional sobre su solicitud de adopción  
**Para** poder obtener los datos necesarios para evaluar la solicitud y continuar con el proceso

---

## Dependencias

- HU-001 (Next.js App Router)
- HU-011 (Conexión a Supabase configurada)
- HU-016 (Sistema de traducciones configurado)
- HU-037 (Gestión de solicitudes de adopción implementada)
- Sistema de envío de correos configurado (`email_queue` y función `send-email-queue`)
- Resend API configurada

---

## Contexto / Notas

- Actualmente, el botón "SOLICITAR INFORMACIÓN" en `AdoptionRequestDetailPage` solo cambia el status a `info_requested` pero **no envía correo** ❌
- El sistema de correos ya está implementado:
  - Tabla `email_queue` para encolar correos
  - Función Supabase Edge `send-email-queue` que procesa los correos en batch
  - Templates de correo en `supabase/functions/send-email-queue/templates/`
  - Se usa Resend como proveedor de email
- El email del adoptante se obtiene de:
  - `adoption_request_details.adopter_email` (preferido, es un snapshot)
  - O desde `auth.users.email` usando `adoption_requests.adopter_user_id` (fallback)
- Esta HU implementa:
  - Modal de solicitud de información (basado en el diseño HTML)
  - Formulario con campos: Para (email, readonly), Asunto, Mensaje
  - Plantillas predefinidas que se pueden insertar en el mensaje
  - Envío del correo al adoptante
  - Actualización del status a `info_requested`
  - Encolado del correo en `email_queue` con template `info_requested`
- **Template de correo**: Se debe crear un nuevo template `adoption-info-requested.ts` similar a los existentes
- **Use Case**: Se debe crear `RequestAdoptionInfoUseCase` que:
  - Valide que el usuario es miembro de la fundación
  - Obtenga el email del adoptante
  - Encole el correo en `email_queue`
  - Actualice el status de la solicitud a `info_requested`

---

## Diseño (OBLIGATORIO si hay UI)

Referencias:
- Diseño: `docs/design/code_request_info_modal.html`
- Imagen: `docs/design/screen_request_info_modal.png`
- Componente existente: `src/presentation/components/adoptions-admin/AdoptionRequestDetailPage.tsx`

Reglas:
- El modal debe aparecer cuando se hace clic en "SOLICITAR INFORMACIÓN"
- El campo "Para" debe mostrar el email del adoptante (readonly)
- El campo "Asunto" debe tener un valor por defecto: "Información adicional requerida - Amigo Gigante"
- El campo "Mensaje" debe ser un textarea multilínea
- Debe haber botones de plantillas predefinidas:
  - "Video del hogar"
  - "Comprobante de ingresos"
  - "Referencias personales"
- Al hacer clic en una plantilla, se debe insertar el texto en el mensaje (al final o reemplazar)
- Botones: "Cancelar" y "Enviar Correo"
- Mostrar estados de carga durante el envío
- Manejar errores de forma amigable

---

## Reglas técnicas

- Arquitectura: ver `docs/01_arquitectura.md`
- Reglas Codex: ver `docs/02_reglas_de_codex.md`

## Alcance

Incluye:
- Crear componente `RequestInfoModal` para el modal de solicitud de información
- Crear `RequestAdoptionInfoUseCase` que:
  - Valide permisos (miembro de fundación)
  - Obtenga el email del adoptante desde `adoption_request_details.adopter_email` o `auth.users`
  - Encole el correo en `email_queue` con:
    - `template`: `"info_requested"`
    - `to_email`: email del adoptante
    - `payload`: `{ request_id, animal_id, foundation_id, subject, message, animal_name }`
    - `user_id`: `adopter_user_id`
  - Actualice el status de `adoption_requests` a `info_requested`
- Crear template de correo `adoption-info-requested.ts` en `supabase/functions/send-email-queue/templates/`
- Actualizar `send-email-queue/index.ts` para incluir el nuevo template
- Integrar el modal en `AdoptionRequestDetailPage`
- Agregar traducciones necesarias
- Plantillas predefinidas de mensaje (texto que se inserta en el textarea)

No incluye:
- Sistema de respuestas al correo (solo envío unidireccional)
- Historial de correos enviados (solo se encola en `email_queue`)
- Adjuntos en el correo
- Notificaciones in-app adicionales (ya se manejan en los triggers)
- Edición de correos ya enviados

---

## Criterios de aceptación (Given / When / Then)

### 1) Modal de solicitud de información implementado

- **Dado** que un miembro de fundación está viendo una solicitud de adopción
- **Cuando** hace clic en "SOLICITAR INFORMACIÓN"
- **Entonces** se abre un modal con:
  - Campo "Para" mostrando el email del adoptante (readonly)
  - Campo "Asunto" con valor por defecto: "Información adicional requerida - Amigo Gigante"
  - Campo "Mensaje" (textarea) vacío
  - Botones de plantillas predefinidas
  - Botones "Cancelar" y "Enviar Correo"

### 2) Plantillas predefinidas funcionan

- **Dado** que el modal está abierto
- **Cuando** hace clic en una plantilla (ej: "Video del hogar")
- **Entonces** se inserta el texto de la plantilla en el campo "Mensaje"
- **Y** el texto se agrega al final del mensaje existente (o reemplaza si está vacío)

### 3) Envío de correo implementado

- **Dado** que el modal está abierto con un mensaje válido
- **Cuando** hace clic en "Enviar Correo"
- **Entonces** se valida que:
  - El asunto no esté vacío
  - El mensaje no esté vacío
  - El email del adoptante existe
- **Y** se encola el correo en `email_queue` con:
  - `template`: `"info_requested"`
  - `to_email`: email del adoptante
  - `payload`: contiene `request_id`, `animal_id`, `foundation_id`, `subject`, `message`, `animal_name`
  - `user_id`: `adopter_user_id`
- **Y** se actualiza el status de `adoption_requests` a `info_requested`
- **Y** se cierra el modal
- **Y** se muestra un mensaje de éxito

### 4) Template de correo creado

- **Dado** que se encoló un correo con template `"info_requested"`
- **Cuando** la función `send-email-queue` procesa el correo
- **Entonces** se renderiza el template `adoption-info-requested.ts` con:
  - Título: "Información adicional requerida"
  - Asunto personalizado desde el payload
  - Mensaje personalizado desde el payload
  - Información de la solicitud (ID, mascota, fundación)
  - Botón para ver la solicitud (si hay URL configurada)

### 5) Actualización de status

- **Dado** que se envió exitosamente el correo
- **Cuando** se actualiza la solicitud
- **Entonces** el status de `adoption_requests` cambia a `info_requested`
- **Y** se dispara el trigger `trg_adoption_request_status_changed` (ya existe)
- **Y** se crea una notificación in-app para el adoptante (ya manejado por el trigger)

### 6) Manejo de errores

- **Dado** que se intenta enviar un correo
- **Cuando** ocurre un error (email no encontrado, sin permisos, etc.)
- **Entonces** se muestra un mensaje de error descriptivo
- **Y** el modal permanece abierto para permitir corrección
- **Y** el status NO se actualiza si falla el envío

### 7) Validación de permisos

- **Dado** que un usuario intenta solicitar información
- **Cuando** no es miembro de la fundación de la solicitud
- **Entonces** se muestra un error de autorización
- **Y** no se permite el envío del correo

---

## Reglas técnicas

### Arquitectura
- Presentation solo consume UseCases vía IoC (no importa repositorios concretos).
- Domain no importa React/Next/MUI/Tailwind/Inversify/Supabase.
- Infrastructure contiene implementaciones y wiring IoC.
- El Use Case debe validar permisos antes de encolar el correo.

### Estructura del Use Case

```typescript
// domain/usecases/adopt/RequestAdoptionInfoUseCase.ts
import type { IAdoptionRequestRepository } from "@/domain/repositories/IAdoptionRequestRepository";
import type { IAuthRepository } from "@/domain/repositories/IAuthRepository";
import type { IFoundationMembershipRepository } from "@/domain/repositories/IFoundationMembershipRepository";

export interface RequestAdoptionInfoInput {
  requestId: number;
  subject: string;
  message: string;
}

export class RequestAdoptionInfoUseCase {
  constructor(
    private readonly adoptionRequestRepository: IAdoptionRequestRepository,
    private readonly authRepository: IAuthRepository,
    private readonly foundationMembershipRepository: IFoundationMembershipRepository,
  ) {}

  async execute(input: RequestAdoptionInfoInput): Promise<void> {
    // 1. Validar sesión
    const session = await this.authRepository.getSession();
    if (!session?.user?.id) {
      throw new Error("errors.unauthorized");
    }

    // 2. Obtener foundationId del usuario
    const foundationId = await this.foundationMembershipRepository.getFoundationIdForUser(session.user.id);
    if (!foundationId) {
      throw new Error("errors.unauthorized");
    }

    // 3. Obtener detalles de la solicitud (incluye email del adoptante)
    const requestDetail = await this.adoptionRequestRepository.getRequestDetail({
      foundationId,
      requestId: input.requestId,
    });

    // 4. Validar que la solicitud pertenece a la fundación
    // (ya validado por getRequestDetail, pero por seguridad)

    // 5. Obtener email del adoptante
    const adopterEmail = requestDetail.adopterProfile.email;
    if (!adopterEmail) {
      // Fallback: obtener desde auth.users usando adopter_user_id
      // (necesitarías agregar este método al repositorio o use case)
      throw new Error("errors.adopterEmailNotFound");
    }

    // 6. Encolar correo en email_queue
    await this.adoptionRequestRepository.enqueueInfoRequestEmail({
      requestId: input.requestId,
      adopterUserId: requestDetail.adopterProfile.userId, // Necesitarías agregar esto al modelo
      toEmail: adopterEmail,
      subject: input.subject,
      message: input.message,
      animalName: requestDetail.animal.name,
      animalId: requestDetail.animal.id,
      foundationId,
    });

    // 7. Actualizar status a info_requested
    await this.adoptionRequestRepository.updateRequestStatus({
      foundationId,
      requestId: input.requestId,
      status: "info_requested",
    });
  }
}
```

### Actualización del Repositorio

```typescript
// domain/repositories/IAdoptionRequestRepository.ts
// Agregar método:

export interface EnqueueInfoRequestEmailParams {
  requestId: number;
  adopterUserId: string;
  toEmail: string;
  subject: string;
  message: string;
  animalName: string;
  animalId: number;
  foundationId: string;
}

export interface IAdoptionRequestRepository {
  // ... métodos existentes
  enqueueInfoRequestEmail(params: EnqueueInfoRequestEmailParams): Promise<void>;
  updateRequestStatus(params: { foundationId: string; requestId: number; status: AdoptionRequestStatus }): Promise<void>;
}
```

### Implementación en el Repositorio

```typescript
// infrastructure/repositories/AdoptionRequestRepository.ts
async enqueueInfoRequestEmail(params: EnqueueInfoRequestEmailParams): Promise<void> {
  const { data, error } = await supabaseClient
    .from("email_queue")
    .insert({
      user_id: params.adopterUserId,
      to_email: params.toEmail,
      template: "info_requested",
      payload: {
        request_id: params.requestId,
        animal_id: params.animalId,
        foundation_id: params.foundationId,
        animal_name: params.animalName,
        subject: params.subject,
        message: params.message,
      },
      status: "pending",
    })
    .select()
    .single();

  if (error) {
    throw new Error(this.translateAdoptionError(error));
  }
}

async updateRequestStatus(params: { foundationId: string; requestId: number; status: AdoptionRequestStatus }): Promise<void> {
  const { error } = await supabaseClient
    .from("adoption_requests")
    .update({ status: params.status })
    .eq("id", params.requestId)
    .eq("foundation_id", params.foundationId);

  if (error) {
    throw new Error(this.translateAdoptionError(error));
  }
}
```

### Template de Correo

```typescript
// supabase/functions/send-email-queue/templates/adoption-info-requested.ts
import { baseLayout } from "./base-layout.ts";
import { pill, primaryButton } from "./ui.ts";

export function adoptionInfoRequested(payload: any) {
  const requestId = String(payload?.request_id ?? "—");
  const animalName = payload?.animal_name ? String(payload.animal_name) : "la mascota";
  const foundationName = payload?.foundation_name ? String(payload.foundation_name) : null;
  const subject = payload?.subject ? String(payload.subject) : "Información adicional requerida";
  const message = payload?.message ? String(payload.message) : "";

  const viewUrl = payload?.view_url
    ? String(payload.view_url)
    : `https://tuapp.com/requests/${encodeURIComponent(requestId)}`;

  const details =
    pill("ID de solicitud", requestId) +
    pill("Mascota", animalName) +
    (foundationName ? pill("Fundación", foundationName) : "");

  const content = `
    <p style="margin:0 0 16px 0;">Hola,</p>
    <p style="margin:0 0 16px 0;">${message.replace(/\n/g, "<br>")}</p>
    <div style="margin:20px 0;">
      ${details}
    </div>
    ${primaryButton("Ver mi solicitud", viewUrl)}
    <p style="margin:16px 0 0 0;font-size:12px;color:#6b7280;">
      Por favor, responde a este correo o actualiza tu solicitud con la información solicitada.
    </p>
  `;

  return baseLayout({
    preheader: subject,
    title: subject,
    contentHtml: content,
  });
}
```

### Actualización de send-email-queue

```typescript
// supabase/functions/send-email-queue/index.ts
import { adoptionInfoRequested } from "./templates/adoption-info-requested.ts";

function renderSubject(template: string, payload: any) {
  switch (template) {
    case "adoption_request_created":
      return "Recibimos tu solicitud de adopción";
    case "adoption_status_changed":
      return "Actualización de tu solicitud de adopción";
    case "info_requested":
      return payload?.subject ?? "Información adicional requerida - Amigo Gigante";
    default:
      return "Notificación";
  }
}

function renderHtml(template: string, payload: any) {
  switch (template) {
    case "adoption_request_created":
      return adoptionRequestCreated(payload);
    case "adoption_status_changed":
      return adoptionStatusChanged(payload);
    case "info_requested":
      return adoptionInfoRequested(payload);
    default:
      return "<p>Tienes una nueva notificación.</p>";
  }
}
```

### Componente RequestInfoModal

```typescript
// src/presentation/components/adoptions-admin/RequestInfoModal.tsx
"use client";

import {
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Button,
  TextField,
  Box,
  Chip,
  CircularProgress,
  Alert,
} from "@mui/material";
import { useTranslations } from "next-intl";
import { useState } from "react";

export interface RequestInfoModalProps {
  open: boolean;
  adopterEmail: string;
  onClose: () => void;
  onSubmit: (subject: string, message: string) => Promise<void>;
}

const TEMPLATES = [
  {
    id: "home_video",
    label: "Video del hogar",
    text: "Necesitamos que nos proporciones un video corto mostrando tu hogar y el espacio donde viviría la mascota.",
  },
  {
    id: "income_proof",
    label: "Comprobante de ingresos",
    text: "Por favor, comparte un comprobante de ingresos que demuestre tu capacidad económica para mantener a la mascota.",
  },
  {
    id: "references",
    label: "Referencias personales",
    text: "Necesitamos al menos dos referencias personales (nombre, teléfono, relación) que puedan hablar sobre tu responsabilidad y capacidad para cuidar de una mascota.",
  },
];

export function RequestInfoModal({ open, adopterEmail, onClose, onSubmit }: RequestInfoModalProps) {
  const t = useTranslations("adoptionsAdmin");
  const [subject, setSubject] = useState("Información adicional requerida - Amigo Gigante");
  const [message, setMessage] = useState("");
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleTemplateClick = (templateText: string) => {
    if (message.trim()) {
      setMessage((prev) => `${prev}\n\n${templateText}`);
    } else {
      setMessage(templateText);
    }
  };

  const handleSubmit = async () => {
    setError(null);

    if (!subject.trim()) {
      setError(t("requestInfo.errors.subjectRequired"));
      return;
    }

    if (!message.trim()) {
      setError(t("requestInfo.errors.messageRequired"));
      return;
    }

    setIsSubmitting(true);
    try {
      await onSubmit(subject.trim(), message.trim());
      // Reset form
      setSubject("Información adicional requerida - Amigo Gigante");
      setMessage("");
      onClose();
    } catch (err) {
      setError(err instanceof Error ? err.message : t("requestInfo.errors.sendFailed"));
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleClose = () => {
    if (!isSubmitting) {
      setError(null);
      onClose();
    }
  };

  return (
    <Dialog open={open} onClose={handleClose} maxWidth="md" fullWidth>
      <DialogTitle>
        <Box className="flex items-center gap-3">
          <Box className="p-2 bg-sky-50 dark:bg-sky-900/30 rounded-lg">
            <span className="material-icons-round text-primary">mail</span>
          </Box>
          <Box>
            <Typography variant="h6">{t("requestInfo.title")}</Typography>
            <Typography variant="body2" color="text.secondary">
              {t("requestInfo.description")}
            </Typography>
          </Box>
        </Box>
      </DialogTitle>
      <DialogContent>
        <Box className="space-y-4 pt-2">
          {error && <Alert severity="error">{error}</Alert>}

          <TextField
            label={t("requestInfo.to")}
            value={adopterEmail}
            fullWidth
            disabled
            InputProps={{
              startAdornment: <span className="material-icons-round text-slate-400 text-sm mr-2">alternate_email</span>,
            }}
          />

          <TextField
            label={t("requestInfo.subject")}
            value={subject}
            onChange={(e) => setSubject(e.target.value)}
            fullWidth
            required
            disabled={isSubmitting}
          />

          <Box>
            <Typography variant="caption" className="text-slate-400 mb-2 block">
              {t("requestInfo.insertTemplate")}
            </Typography>
            <Box className="flex flex-wrap gap-2 mb-4">
              {TEMPLATES.map((template) => (
                <Chip
                  key={template.id}
                  label={template.label}
                  onClick={() => handleTemplateClick(template.text)}
                  disabled={isSubmitting}
                  className="cursor-pointer"
                />
              ))}
            </Box>
          </Box>

          <TextField
            label={t("requestInfo.message")}
            value={message}
            onChange={(e) => setMessage(e.target.value)}
            fullWidth
            multiline
            rows={5}
            required
            disabled={isSubmitting}
            placeholder={t("requestInfo.messagePlaceholder")}
          />
        </Box>
      </DialogContent>
      <DialogActions>
        <Button onClick={handleClose} disabled={isSubmitting}>
          {t("requestInfo.cancel")}
        </Button>
        <Button
          onClick={handleSubmit}
          variant="contained"
          disabled={isSubmitting || !subject.trim() || !message.trim()}
          startIcon={isSubmitting ? <CircularProgress size={18} /> : undefined}
        >
          {t("requestInfo.send")}
        </Button>
      </DialogActions>
    </Dialog>
  );
}
```

### Integración en AdoptionRequestDetailPage

```typescript
// src/presentation/components/adoptions-admin/AdoptionRequestDetailPage.tsx
// Agregar:
const [isRequestInfoModalOpen, setIsRequestInfoModalOpen] = useState(false);
const requestInfoUseCase = useMemo(
  () => appContainer.get<RequestAdoptionInfoUseCase>(USE_CASE_TYPES.RequestAdoptionInfoUseCase),
  [],
);

const handleRequestInfo = async (subject: string, message: string) => {
  if (!detail) return;
  
  await requestInfoUseCase.execute({
    requestId: detail.id,
    subject,
    message,
  });
  
  // Recargar detalles para actualizar el status
  await loadDetail();
};

// En el JSX, reemplazar:
// onRequestInfo={() => handleStatusUpdate("info_requested")}
// Por:
onRequestInfo={() => setIsRequestInfoModalOpen(true)}

// Agregar el modal:
<RequestInfoModal
  open={isRequestInfoModalOpen}
  adopterEmail={detail.adopterProfile.email ?? ""}
  onClose={() => setIsRequestInfoModalOpen(false)}
  onSubmit={handleRequestInfo}
/>
```

### Traducciones (OBLIGATORIO si hay UI)

```json
// src/messages/es/adoptions-admin.json
{
  "requestInfo": {
    "title": "Solicitar Información Adicional",
    "description": "Envía un correo electrónico al adoptante para requerir más detalles sobre su solicitud.",
    "to": "Para",
    "subject": "Asunto",
    "message": "Mensaje",
    "messagePlaceholder": "Escribe el mensaje aquí...",
    "insertTemplate": "INSERTAR PLANTILLA:",
    "cancel": "Cancelar",
    "send": "Enviar Correo",
    "success": "Correo enviado exitosamente",
    "errors": {
      "subjectRequired": "El asunto es requerido",
      "messageRequired": "El mensaje es requerido",
      "sendFailed": "Error al enviar el correo. Por favor, intenta de nuevo.",
      "adopterEmailNotFound": "No se pudo encontrar el email del adoptante"
    }
  }
}
```

```json
// src/messages/en/adoptions-admin.json
{
  "requestInfo": {
    "title": "Request Additional Information",
    "description": "Send an email to the adopter requesting more details about their application.",
    "to": "To",
    "subject": "Subject",
    "message": "Message",
    "messagePlaceholder": "Write your message here...",
    "insertTemplate": "INSERT TEMPLATE:",
    "cancel": "Cancel",
    "send": "Send Email",
    "success": "Email sent successfully",
    "errors": {
      "subjectRequired": "Subject is required",
      "messageRequired": "Message is required",
      "sendFailed": "Error sending email. Please try again.",
      "adopterEmailNotFound": "Could not find adopter email"
    }
  }
}
```

---

## Implementación sugerida

### 1. Crear el Use Case

- Crear `RequestAdoptionInfoUseCase` en `src/domain/usecases/adopt/`
- Agregar métodos al repositorio: `enqueueInfoRequestEmail` y `updateRequestStatus`
- Implementar en `AdoptionRequestRepository`

### 2. Crear el template de correo

- Crear `adoption-info-requested.ts` en `supabase/functions/send-email-queue/templates/`
- Actualizar `send-email-queue/index.ts` para incluir el nuevo template

### 3. Crear el componente modal

- Crear `RequestInfoModal.tsx` en `src/presentation/components/adoptions-admin/`
- Integrar en `AdoptionRequestDetailPage`

### 4. Registrar en IoC

- Agregar `RequestAdoptionInfoUseCase` a `usecases.types.ts`
- Registrar en `usecases.container.ts`

### 5. Agregar traducciones

- Agregar keys en `adoptions-admin.json` (es y en)

---

## Validación

Comandos mínimos:
- `npm run dev` (verificar que el modal funciona y envía correos)
- `npm run build` (verificar que no hay errores de compilación)

Pruebas manuales:
1. Ir a una solicitud de adopción
2. Hacer clic en "SOLICITAR INFORMACIÓN"
3. Verificar que se abre el modal con el email del adoptante
4. Escribir un asunto y mensaje
5. Probar insertar una plantilla
6. Enviar el correo
7. Verificar en Supabase Dashboard > `email_queue` que se encoló el correo
8. Verificar que el status cambió a `info_requested`
9. Verificar que la función `send-email-queue` procesa el correo correctamente
10. Verificar que el adoptante recibe el correo con el formato correcto

---

## Definición de Hecho

- [ ] Criterios de aceptación cumplidos
- [ ] `npm run dev` OK
- [ ] `npm run build` OK
- [ ] Sin violaciones de capas
- [ ] Sin cambios fuera del alcance
- [ ] **Traducciones incluidas**:
  - [ ] Textos agregados en `src/messages/es/adoptions-admin.json`
  - [ ] Textos agregados en `src/messages/en/adoptions-admin.json`
- [ ] Pruebas manuales realizadas:
  - [ ] Modal se abre correctamente
  - [ ] Plantillas funcionan
  - [ ] Correo se encola en `email_queue`
  - [ ] Status se actualiza a `info_requested`
  - [ ] Template de correo se renderiza correctamente
  - [ ] El adoptante recibe el correo
- [ ] Template de correo creado y funcionando
- [ ] Use Case registrado en IoC
- Commit sugerido:
  `feat: implementar solicitud de información adicional vía correo (HU-048)`
