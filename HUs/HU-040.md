# HU-040 — Registro de usuario externo con Supabase

**Como** usuario externo (adoptante)  
**Quiero** registrarme en la plataforma con mi email y contraseña  
**Para** poder adoptar animales y realizar compras en la tienda

---

## Dependencias

- HU-001 (Next.js App Router)
- HU-011 (Conexión a Supabase configurada)
- HU-013 (Estrategia de roles y protección de rutas definida)
- HU-016 (Sistema de traducciones configurado)
- Tabla `profiles` creada en `db.sql` (líneas 1-9) con soporte para rol `external`

---

## Contexto / Notas

- Esta HU implementa el registro de usuarios externos (adoptantes) conectando con Supabase.
- El diseño está disponible en `docs/design/registration_external_user_screen.png` y `docs/design/code_registration_external_user.html`.
- El flujo de registro debe crear:
  1. Usuario en Supabase Auth (con email y password)
  2. Perfil en `profiles` (con `role: 'external'` y `display_name`, `phone` si se proporcionan)
- Después del registro exitoso, el usuario debe quedar autenticado y ser redirigido a **home** (no dashboard).
- El sistema debe detectar que el usuario es `external` y mostrar el menú de cuenta en lugar del botón de login (HU-041).
- Se debe manejar errores del servidor y mostrarlos al usuario.
- El formulario incluye: nombre completo, email, teléfono, contraseña, confirmar contraseña, y checkbox de términos.

---

## Diseño (OBLIGATORIO si hay UI)

Referencias:
- Diseño: `docs/design/registration_external_user_screen.png`
- Código HTML: `docs/design/code_registration_external_user.html`
- Design System: `docs/design/system.md`

Reglas:
- Respetar jerarquía visual del diseño.
- Usar tokens definidos en el Design System (no inventar tamaños/colores).
- El formulario debe tener validación en el frontend (similar a HU-014).
- Campos del formulario:
  - Nombre completo (text)
  - Email (email)
  - Teléfono (tel)
  - Contraseña (password con toggle de visibilidad)
  - Confirmar contraseña (password con toggle de visibilidad)
  - Checkbox de términos y condiciones
- Botón de registro con Google (opcional, puede dejarse para otra HU).
- Botón principal "Create Account" con estilo primary.

---

## Reglas técnicas

- Arquitectura: ver `docs/01_arquitectura.md`
- Reglas Codex: ver `docs/02_reglas_de_codex.md`

## Alcance

Incluye:
- Crear UseCase de registro de usuario externo (`RegisterExternalUserUseCase`)
- Crear repositorios necesarios (Auth, Profile) o reutilizar existentes
- Implementar servicios de Supabase para registro
- Crear formulario de registro de usuario externo (página `/register/external` o similar)
- Conectar el formulario con el UseCase
- Manejo de errores del servidor (mostrar mensajes al usuario)
- Redirección después del registro exitoso a **home** (no dashboard)
- Crear perfil automáticamente con rol `external`
- Guardar `display_name` y `phone` en el perfil si se proporcionan
- Validación de formulario (email válido, contraseñas coinciden, términos aceptados)

No incluye:
- Registro con Google (puede dejarse para otra HU)
- Validación de email por correo
- Recuperación de contraseña
- Edición de perfil (otra HU)
- Menú de cuenta para usuario externo (HU-041)

---

## Criterios de aceptación (Given / When / Then)

### 1) UseCase de registro implementado

- **Dado** que se necesita registrar un usuario externo
- **Cuando** se implementa la lógica de negocio
- **Entonces** existe un UseCase `RegisterExternalUserUseCase` en `domain/usecases/auth/`
- **Y** el UseCase recibe: `email`, `password`, `displayName` (opcional), `phone` (opcional)
- **Y** el UseCase retorna: `user`, `session`
- **Y** el UseCase crea el usuario en Supabase Auth
- **Y** el UseCase crea el perfil con `role: 'external'`
- **Y** el UseCase guarda `display_name` y `phone` si se proporcionan

### 2) Repositorios implementados o reutilizados

- **Dado** que se necesita interactuar con Supabase
- **Cuando** se implementa el registro
- **Entonces** se reutiliza `IAuthRepository` existente o se extiende si es necesario
- **Y** `AuthRepository.signUp()` crea el usuario en Supabase Auth
- **Y** `AuthRepository.createProfile()` crea el perfil con los datos proporcionados
- **Y** el perfil se crea con `role: 'external'` por defecto

### 3) Formulario de registro implementado

- **Dado** que el usuario quiere registrarse como usuario externo
- **Cuando** accede a la página de registro externo
- **Entonces** se muestra un formulario con los campos: nombre completo, email, teléfono, contraseña, confirmar contraseña, checkbox de términos
- **Y** el formulario tiene validación en el frontend:
  - Email válido
  - Contraseña con mínimo de caracteres (ej: 8)
  - Contraseñas coinciden
  - Términos aceptados
- **Y** el formulario muestra mensajes de error claros
- **Y** el formulario respeta el diseño proporcionado

### 4) Integración con Supabase

- **Dado** que el formulario está completo y validado
- **Cuando** el usuario envía el formulario
- **Entonces** se llama a `RegisterExternalUserUseCase.execute()`
- **Y** se crea el usuario en Supabase Auth con email y password
- **Y** se crea el perfil en la tabla `profiles` con:
  - `id` = `user.id` (referencia a `auth.users`)
  - `role` = `'external'`
  - `display_name` = nombre completo (si se proporciona)
  - `phone` = teléfono (si se proporciona)
- **Y** se manejan errores de Supabase (email duplicado, error de conexión, etc.)

### 5) Manejo de errores del servidor

- **Dado** que ocurre un error durante el registro
- **Cuando** se intenta registrar un usuario
- **Entonces** se muestra un mensaje de error traducido al usuario
- **Y** los errores comunes se manejan y traducen:
  - Email duplicado → "Este email ya está registrado"
  - Contraseña débil → "La contraseña debe tener al menos 8 caracteres"
  - Error de conexión → "No pudimos conectarnos al servidor. Revisa tu conexión"
  - Error de validación → "Por favor completa todos los campos requeridos"
- **Y** los mensajes de error están en `src/messages/es/register.json` y `src/messages/en/register.json`
- **Y** se muestran en el formulario sin romper la UI

### 6) Redirección después del registro exitoso

- **Dado** que el registro es exitoso
- **Cuando** se completa la autenticación
- **Entonces** el usuario es redirigido a **home** (`/` o `/[locale]`)
- **Y** NO se redirige al dashboard (a diferencia de usuarios foundation)
- **Y** la redirección preserva el locale (ej: `/es` o `/en`)
- **Y** el usuario queda autenticado automáticamente
- **Y** el sistema detecta que el usuario es `external` (para mostrar menú de cuenta en HU-041)

### 7) Persistencia de sesión

- **Dado** que el usuario se registra exitosamente
- **Cuando** se crea la sesión
- **Entonces** la sesión se persiste en el cliente (cookies o localStorage según estrategia de Supabase)
- **Y** el usuario permanece autenticado al recargar la página
- **Y** el hook `useAuth` puede obtener la sesión activa
- **Y** el hook `useAuth` retorna `role: 'external'` correctamente

### 8) Validación de formulario

- **Dado** que el usuario completa el formulario
- **Cuando** se valida antes de enviar
- **Entonces** se valida que:
  - Email es válido (formato correcto)
  - Contraseña tiene mínimo de caracteres (ej: 8)
  - Contraseñas coinciden
  - Términos y condiciones están aceptados
  - Nombre completo es requerido (o opcional según diseño)
- **Y** los mensajes de validación están traducidos
- **Y** se muestran errores de validación en tiempo real o al enviar

---

## Reglas técnicas

### Arquitectura
- Presentation solo consume UseCases vía IoC (no importa repositorios concretos).
- Domain no importa React/Next/MUI/Tailwind/Inversify/Supabase.
- Infrastructure contiene implementaciones y wiring IoC.
- **Supabase solo vive en Infrastructure**: servicios y repositorios.

### Flujo de registro
1. Usuario completa formulario (validado en frontend)
2. `onSubmit` del formulario llama a `RegisterExternalUserUseCase` (Presentation)
3. UseCase llama a `AuthRepository.signUp()` (Domain → Infrastructure)
4. UseCase crea perfil con `role: 'external'` usando `AuthRepository.createProfile()` (Domain → Infrastructure)
5. UseCase guarda `display_name` y `phone` en el perfil si se proporcionan
6. Retornar éxito y redirigir a home (Presentation)

### Transacciones
- Si es posible, usar transacciones de Supabase para asegurar atomicidad.
- Si falla algún paso, revertir los cambios anteriores.
- Si no es posible transacciones, manejar errores y limpiar datos creados.

### Redirección
- Preservar el locale en la redirección (ej: `/es` o `/en`).
- Redirigir siempre a home (`/` o `/[locale]`) para usuarios externos.
- NO redirigir a dashboard (a diferencia de usuarios foundation).

### Traducciones (OBLIGATORIO si hay UI con texto)
- **TODOS los textos visibles en la UI deben estar traducidos** (español e inglés).
- Usar el sistema de traducciones configurado en HU-016 (`next-intl`).
- Agregar traducciones en:
  - `src/messages/es/register.json` (español)
  - `src/messages/en/register.json` (inglés)
- Keys sugeridas:
  - `register.external.title`
  - `register.external.subtitle`
  - `register.external.form.fullName.label`
  - `register.external.form.email.label`
  - `register.external.form.phone.label`
  - `register.external.form.password.label`
  - `register.external.form.confirmPassword.label`
  - `register.external.form.terms.label`
  - `register.external.form.terms.link`
  - `register.external.form.submit`
  - `register.external.form.errors.emailRequired`
  - `register.external.form.errors.emailInvalid`
  - `register.external.form.errors.passwordRequired`
  - `register.external.form.errors.passwordMinLength`
  - `register.external.form.errors.passwordsMismatch`
  - `register.external.form.errors.termsRequired`
  - `register.external.errors.emailExists`
  - `register.external.errors.connectionError`
- Usar `useTranslations("register")` para acceder a traducciones.

### Dependencias / Paquetes
- No agregar dependencias nuevas salvo que esta HU lo indique explícitamente.
- Reutilizar `AuthRepository` existente si es posible.
- Si aparece error 403/conectividad:
  1) Detenerse
  2) Pedir dominios requeridos
  3) Explicar por qué se requieren
  4) No continuar

---

## Implementación sugerida (opcional)

### Estructura de archivos sugerida:

```
src/domain/
├── models/
│   └── AuthUser.ts (ya existe, reutilizar)
├── repositories/
│   └── IAuthRepository.ts (ya existe, reutilizar o extender)
└── usecases/
    └── auth/
        └── RegisterExternalUserUseCase.ts (nuevo)

src/infrastructure/
├── repositories/
│   └── AuthRepository.ts (ya existe, reutilizar o extender)

src/presentation/
└── components/
    └── register/
        └── RegisterExternalForm.tsx (nuevo)
└── app/
    └── [locale]/
        └── register/
            └── external/
                └── page.tsx (nuevo, o modificar register existente)
```

### Flujo de implementación:

1. **Crear UseCase**:
   - `RegisterExternalUserUseCase.execute(data)`:
     - Sign up en Auth con `AuthRepository.signUp()`
     - Crear perfil con `role: 'external'` usando `AuthRepository.createProfile()`
     - Guardar `display_name` y `phone` si se proporcionan

2. **Crear o modificar repositorio**:
   - Verificar que `AuthRepository.createProfile()` acepta `display_name` y `phone`
   - Si no, extender la interfaz y implementación

3. **Crear formulario**:
   - `RegisterExternalForm.tsx` con campos del diseño
   - Validación con Yup o similar (como en HU-014)
   - Integrar con `RegisterExternalUserUseCase`

4. **Crear página**:
   - `src/app/[locale]/register/external/page.tsx`
   - O modificar la página de registro existente para detectar tipo de usuario

5. **Manejar errores**:
   - Traducir errores de Supabase a mensajes amigables
   - Mostrar mensajes de error en el formulario

6. **Redirección**:
   - Después del registro exitoso, redirigir a `/[locale]` (home)
   - NO redirigir a dashboard

### Notas importantes:
- Usar transacciones si es posible (Supabase permite múltiples inserts).
- Los errores de Supabase deben traducirse a mensajes amigables en español e inglés.
- Después del registro, el usuario debe quedar autenticado automáticamente.
- El sistema debe detectar que el usuario es `external` para mostrar el menú de cuenta (HU-041).

---

## Validación

Comandos mínimos:
- `npm run dev` (verificar que el registro funciona)
- `npm run build` (verificar que no hay errores de compilación)

Verificaciones:
- El registro crea usuario en Supabase Auth
- El registro crea perfil con `role: 'external'`
- El registro guarda `display_name` y `phone` si se proporcionan
- El usuario es redirigido a home (no dashboard)
- El usuario queda autenticado después del registro
- Los errores se muestran correctamente
- Las traducciones están completas (ES/EN)
- El formulario tiene validación en frontend
- La sesión persiste al recargar la página

---

## Definición de Hecho

- [ ] Criterios de aceptación cumplidos
- [ ] `npm run dev` OK
- [ ] `npm run build` OK
- [ ] Sin violaciones de capas
- [ ] Sin cambios fuera del alcance
- [ ] **Traducciones incluidas** (si aplica UI con texto):
  - [ ] Textos agregados en `src/messages/es/register.json`
  - [ ] Textos agregados en `src/messages/en/register.json`
  - [ ] Componentes usan `useTranslations` (no textos hardcodeados)
  - [ ] Keys consistentes entre idiomas
- [ ] Usuario redirigido a home (no dashboard)
- [ ] Perfil creado con `role: 'external'`
- [ ] Sesión persiste correctamente
- Commit sugerido:
  `feat: add external user registration with Supabase`
