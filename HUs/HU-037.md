# HU-037 — Gestión de Solicitudes de Adopción (Admin Panel + Supabase)

**Como** usuario administrador de fundación  
**Quiero** visualizar y gestionar las solicitudes de adopción  
**Para** aprobar, rechazar o solicitar más información de cada solicitud

---

## Dependencias

- HU-001 (Next.js App Router)
- HU-007 (Tailwind configurado)
- HU-010 (Atomic Design - componentes reutilizables)
- HU-011 (Conexión a Supabase configurada)
- HU-016 (Sistema de traducciones configurado)
- HU-036 (Flujo de solicitud de adopción)

---

## Contexto / Notas

- Esta HU implementa el **panel de administración** para solicitudes de adopción.
- Las solicitudes creadas en HU-036 deben aparecer aquí.
- Diseños:
  - Lista de solicitudes: `docs/design/request_info_code.html` + `request_info_screen.png`
  - Detalle de solicitud: `docs/design/requests_adopt_code.html` + `requests_adopt_screen.png`
- La data proviene de Supabase según `docs/scripts/db.sql`.
- Debe respetar la jerarquía visual del diseño (sidebar, tablas, cards, badges).

Modelo de datos disponible:
- `adoption_requests`
- `adoption_request_details`
- `adoption_request_documents`
- `animals`
- `foundations`
- `profiles`

---

## Diseño (OBLIGATORIO)

Referencias:
- Lista: `docs/design/request_info_code.html`
- Detalle: `docs/design/requests_adopt_code.html`
- Imágenes: `docs/design/request_info_screen.png`, `docs/design/requests_adopt_screen.png`
- Design System: `docs/design/system.md`
- Esquema BD: `docs/scripts/db.sql`

Reglas:
- Respetar jerarquía visual y estilos del diseño.
- Layout responsive (sidebar fijo en desktop, topbar en mobile).
- Los textos deben estar traducidos (ES/EN).
- No inventar datos que no existan en BD.

---

## Alcance

Incluye:
- Crear ruta admin de lista: `/admin/adoptions` (o `app/[locale]/admin/adoptions/page.tsx`)
- Crear ruta admin de detalle: `/admin/adoptions/[id]`
- Listado con búsqueda, filtros por estado y prioridad, y paginación
- Visualización de datos reales de solicitudes
- Vista detalle con:
  - Perfil del adoptante (datos del snapshot)
  - Información del animal
  - Experiencia / motivación
  - Documentos de soporte
- Acciones:
  - **Aprobar** → status `approved`
  - **Rechazar** → status `rejected` + `rejection_reason`
  - **Solicitar más información** → status `info_requested`
- Exportar CSV (UI + acción real)
- Estados de loading y error
- Traducciones completas (ES/EN)

No incluye:
- Mensajería directa con el adoptante
- Notificaciones por email
- Tests automatizados

---

## Criterios de aceptación (Given / When / Then)

### 1) Listado de solicitudes
- **Dado** solicitudes creadas en HU-036
- **Cuando** ingreso a `/admin/adoptions`
- **Entonces** veo el listado con diseño correcto
- **Y** se muestran solo solicitudes de la fundación del admin

### 2) Búsqueda y filtros
- **Dado** el buscador y los filtros
- **Cuando** busco por nombre de animal o adoptante
- **Entonces** se filtran resultados (case-insensitive)
- **Y** los filtros de estado y prioridad se aplican correctamente

### 3) Detalle de solicitud
- **Dado** una solicitud en la lista
- **Cuando** hago clic en “View Detail”
- **Entonces** navego al detalle y veo toda la información de la solicitud

### 4) Aprobar solicitud
- **Dado** una solicitud en estado `pending` o `in_review`
- **Cuando** hago clic en “Approve Request”
- **Entonces** el status cambia a `approved`

### 5) Rechazar solicitud
- **Dado** una solicitud activa
- **Cuando** hago clic en “Reject”
- **Entonces** el status cambia a `rejected`
- **Y** se guarda el motivo en `rejection_reason`

### 6) Solicitar más información
- **Dado** una solicitud activa
- **Cuando** hago clic en “Request Information”
- **Entonces** el status cambia a `info_requested`

### 7) Documentos visibles
- **Dado** archivos en `adoption_request_documents`
- **Cuando** se muestra el detalle
- **Entonces** se ven como cards con preview y acciones (ver/descargar)

### 8) Exportar CSV
- **Dado** el listado de solicitudes
- **Cuando** hago clic en “Export CSV”
- **Entonces** se descarga un CSV con los datos visibles

### 9) Estados de loading y error
- **Dado** consultas a Supabase
- **Cuando** carga la lista o el detalle
- **Entonces** se muestra loading y luego los datos
- **Y** si hay error se muestra mensaje traducido

### 10) Traducciones
- **Dado** la implementación
- **Cuando** se revisa la UI
- **Entonces** no hay textos hardcodeados
- **Y** existen traducciones en `src/messages/es/adoptions-admin.json` y `src/messages/en/adoptions-admin.json`

---

## Reglas técnicas

### Arquitectura
- Presentation solo consume UseCases vía IoC.
- Domain no importa React/Next/MUI/Tailwind/Inversify/Supabase.
- Infrastructure contiene implementaciones y wiring IoC.
- Supabase solo vive en Infrastructure.

### Supabase / Queries
- Listado:
  - `SELECT * FROM adoption_requests`
  - Filtros: `status`, `priority`
  - Búsqueda: por `animals.name` o `adoption_request_details.adopter_display_name`
  - Paginación: `range(from, to)` con `count: 'exact'`
  - Solo solicitudes de fundaciones donde el admin es miembro (`foundation_members`)
- Detalle:
  - `adoption_requests` + `adoption_request_details`
  - `adoption_request_documents` por `request_id`
  - `animals` por `animal_id`
- Acciones:
  - `update adoption_requests set status = 'approved'`
  - `update adoption_requests set status = 'rejected', rejection_reason = :reason`
  - `update adoption_requests set status = 'info_requested'`

### Permisos
- El admin solo puede ver/gestionar solicitudes de su fundación.

### Traducciones
- Usar `useTranslations('adoptionsAdmin')`.
- No hardcodear textos.

### Dependencias / Paquetes
- No agregar dependencias nuevas.

---

## Implementación sugerida

### Estructura de archivos sugerida:
```
src/app/[locale]/admin/adoptions/page.tsx
src/app/[locale]/admin/adoptions/[id]/page.tsx

src/presentation/components/adoptions-admin/
├── AdoptionRequestsPage.tsx
├── AdoptionRequestsTable.tsx
├── AdoptionRequestsFilters.tsx
├── AdoptionRequestsPagination.tsx
├── AdoptionRequestDetailPage.tsx
├── AdoptionRequestProfile.tsx
├── AdoptionRequestDocuments.tsx
└── AdoptionRequestActions.tsx

src/domain/
├── models/
│   ├── AdoptionRequest.ts
│   └── AdoptionRequestDocument.ts
├── repositories/
│   └── IAdoptionRequestRepository.ts (extender con getAdminRequests, getRequestDetail, updateStatus)
└── usecases/
    └── adopt/
        ├── GetAdminAdoptionRequestsUseCase.ts
        ├── GetAdoptionRequestDetailUseCase.ts
        └── UpdateAdoptionRequestStatusUseCase.ts

src/infrastructure/
├── repositories/
│   └── AdoptionRequestRepository.ts
└── ioc/
    └── bindings actualizados

src/messages/
├── es/
│   └── adoptions-admin.json
└── en/
    └── adoptions-admin.json
```

---

## Validación

Comandos mínimos:
- `npm run dev`
- `npm run build`

Verificaciones:
- Listado y detalle coinciden con diseño
- Solicitudes reales desde Supabase
- Acciones de aprobar/rechazar/solicitar info funcionan
- CSV exporta datos correctos
- Traducciones completas

---

## Definición de Hecho

- [ ] Criterios de aceptación cumplidos
- [ ] `npm run dev` OK
- [ ] `npm run build` OK
- [ ] Listado y detalle funcionales
- [ ] Acciones sobre solicitudes funcionando
- [ ] Traducciones incluidas (ES/EN)
- [ ] Sin violaciones de capas
- [ ] Sin cambios fuera del alcance
- Commit sugerido:
  `feat: add admin adoption requests management`

