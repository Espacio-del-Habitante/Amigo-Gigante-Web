# HU-045 — Eliminación de imágenes de animales desde Supabase Storage

**Como** miembro de fundación  
**Quiero** poder eliminar imágenes de animales desde el formulario de edición  
**Para** mantener las fotos actualizadas y evitar acumulación de archivos no utilizados en el storage

---

## Dependencias

- HU-001 (Next.js App Router)
- HU-011 (Conexión a Supabase configurada)
- HU-016 (Sistema de traducciones configurado)
- HU-024 (Crear animales implementado)
- HU-043 (Sistema de almacenamiento de imágenes públicas implementado)
- HU-044 (Editar animales implementado)
- Bucket `amg-public-image` creado en Supabase Storage (configuración manual)

---

## Contexto / Notas

- **PROBLEMA ACTUAL**: Cuando se edita un animal y se eliminan fotos desde el formulario:
  - Las fotos se eliminan de la interfaz de usuario ✅
  - **PERO las referencias NO se eliminan correctamente de la tabla `animal_photos` en la base de datos** ❌
  - **Y las imágenes NO se eliminan de Supabase Storage** ❌
  - Esto causa acumulación de archivos huérfanos en el storage y referencias incorrectas en la BD
- Cuando se reemplazan fotos (eliminar y agregar nuevas):
  - Las nuevas fotos se suben correctamente a Supabase Storage ✅
  - Las fotos antiguas quedan en el storage sin referencia en la BD ❌
  - Las referencias antiguas pueden quedar en la BD ❌
- Cuando se elimina un animal completo:
  - El animal se elimina de la tabla `animals` ✅
  - **PERO las fotos NO se eliminan de `animal_photos`** ❌
  - **Y las imágenes NO se eliminan de Supabase Storage** ❌
- Esta HU implementa:
  - **Corrección del bug**: Asegurar que las fotos eliminadas se borren correctamente de `animal_photos`
  - Eliminación física de imágenes desde Supabase Storage cuando:
    - Se eliminan fotos desde el formulario de edición
    - Se reemplazan fotos (las antiguas deben eliminarse)
    - Se elimina un animal completo
- **Solo para imágenes de animales** almacenadas en `amg-public-image/animals/{foundationId}/{animalId}/`
- **NO incluye**:
  - Eliminación de imágenes de productos (ver HU-046)
  - Eliminación de imágenes de eventos o logos de fundaciones
  - Limpieza masiva de archivos huérfanos existentes (puede ser script separado)

---

## Diseño (OBLIGATORIO si hay UI)

Referencias:
- Diseño: `docs/design/system.md`
- Componentes existentes:
  - `src/presentation/components/animals/EditAnimalForm.tsx`
  - `src/presentation/components/animals/AddAnimalForm.tsx`

Reglas:
- La eliminación debe ser transparente para el usuario
- No se requiere confirmación adicional (ya hay confirmación al eliminar desde la UI)
- Los errores de eliminación deben manejarse de forma amigable
- Si falla la eliminación del storage pero se elimina de la BD, registrar el error pero no bloquear la operación

---

## Reglas técnicas

- Arquitectura: ver `docs/01_arquitectura.md`
- Reglas Codex: ver `docs/02_reglas_de_codex.md`

## Alcance

Incluye:
- **Corregir bug**: Asegurar que `replaceAnimalPhotos` elimine correctamente las fotos de `animal_photos` antes de insertar las nuevas
- Agregar método `deleteImage` a `IPublicImageStorage` e implementación en `PublicImageStorage`
- Crear UseCase `DeletePublicImageUseCase` para eliminar imágenes del storage
- Modificar `UpdateAnimalUseCase` para:
  - Detectar fotos eliminadas comparando fotos anteriores vs nuevas
  - Eliminar las fotos del storage antes de actualizar la BD
  - Asegurar que `replaceAnimalPhotos` funcione correctamente
- Modificar `DeleteAnimalUseCase` para:
  - Obtener todas las fotos del animal antes de eliminarlo
  - Eliminar las fotos del storage
  - Eliminar las referencias de `animal_photos` (actualmente solo elimina de `animals`)
- Extraer la ruta del storage desde la URL pública para poder eliminarla
- Manejo de errores al eliminar (no bloquear la operación principal si falla)
- Eliminar imágenes del storage cuando se eliminan desde `EditAnimalForm`
- Eliminar imágenes antiguas cuando se reemplazan por nuevas
- Eliminar todas las imágenes cuando se elimina un animal completo

No incluye:
- Eliminación de imágenes de productos (ver HU-046)
- Eliminación de imágenes de eventos o logos de fundaciones
- Limpieza masiva de archivos huérfanos existentes (puede ser script separado)
- Sistema de soft-delete o recuperación de imágenes eliminadas
- Confirmación adicional en la UI (ya existe en el formulario)

---

## Criterios de aceptación (Given / When / Then)

### 1) Método de eliminación implementado en IPublicImageStorage

- **Dado** que se necesita eliminar imágenes del storage
- **Cuando** se implementa el sistema
- **Entonces** existe un método `deleteImage(url: string): Promise<void>` en `IPublicImageStorage`
- **Y** existe la implementación en `PublicImageStorage`
- **Y** el método extrae la ruta del storage desde la URL pública
- **Y** elimina el archivo del bucket `amg-public-image` en Supabase Storage
- **Y** maneja errores de forma amigable (no lanza excepciones que bloqueen la operación principal)

### 2) UseCase de eliminación implementado

- **Dado** que se necesita eliminar una imagen pública
- **Cuando** se implementa la lógica de negocio
- **Entonces** existe un UseCase `DeletePublicImageUseCase` en `domain/usecases/storage/`
- **Y** el UseCase recibe: `url` (URL pública de la imagen)
- **Y** el UseCase retorna `void` (no retorna valor)
- **Y** el UseCase maneja errores internamente (no propaga excepciones críticas)

### 3) Eliminación correcta de referencias en animal_photos

- **Dado** que un usuario edita un animal y elimina fotos
- **Cuando** se guarda el formulario
- **Entonces** `UpdateAnimalUseCase` detecta las fotos eliminadas (comparando fotos anteriores vs nuevas)
- **Y** elimina las fotos del storage usando `DeletePublicImageUseCase` (antes de actualizar la BD)
- **Y** `replaceAnimalPhotos` elimina CORRECTAMENTE todas las fotos antiguas de `animal_photos`
- **Y** `replaceAnimalPhotos` inserta solo las fotos nuevas en `animal_photos`
- **Y** si falla la eliminación del storage, se registra el error pero no se bloquea la operación
- **Y** las referencias en la BD quedan correctamente sincronizadas con las fotos actuales

### 4) Extracción de ruta desde URL pública

- **Dado** que se tiene una URL pública de Supabase Storage
- **Cuando** se necesita eliminar el archivo
- **Entonces** se extrae la ruta del storage desde la URL pública
- **Y** se valida que la URL pertenece al bucket `amg-public-image`
- **Y** se maneja el caso de URLs externas (no se intenta eliminar)

### 5) Manejo de errores

- **Dado** que se intenta eliminar una imagen
- **Cuando** ocurre un error (archivo no existe, sin permisos, etc.)
- **Entonces** el error se registra pero no se propaga como excepción crítica
- **Y** la operación principal (actualizar animal) continúa normalmente
- **Y** se muestra un mensaje de advertencia si es necesario (opcional)

### 6) Reemplazo de fotos

- **Dado** que un usuario reemplaza fotos de un animal
- **Cuando** se guarda el formulario
- **Entonces** las fotos antiguas que ya no están en la lista se eliminan del storage
- **Y** las nuevas fotos se suben al storage
- **Y** las referencias en la BD se actualizan correctamente (eliminando las antiguas e insertando las nuevas)

### 7) Eliminación de fotos al eliminar animal completo

- **Dado** que un usuario elimina un animal completo
- **Cuando** se ejecuta `DeleteAnimalUseCase`
- **Entonces** se obtienen todas las fotos del animal antes de eliminarlo
- **Y** se eliminan todas las fotos del storage usando `DeletePublicImageUseCase`
- **Y** se eliminan todas las referencias de `animal_photos` para ese animal
- **Y** se elimina el animal de la tabla `animals`
- **Y** si falla la eliminación del storage, se registra el error pero se continúa con la eliminación del animal

---

## Reglas técnicas

### Arquitectura
- Presentation solo consume UseCases vía IoC (no importa repositorios concretos).
- Domain no importa React/Next/MUI/Tailwind/Inversify/Supabase.
- Infrastructure contiene implementaciones y wiring IoC.
- El servicio de storage debe estar en Infrastructure, la interfaz en Domain.

### Extracción de ruta desde URL pública

Las URLs públicas de Supabase Storage tienen el formato:
```
https://{project-ref}.supabase.co/storage/v1/object/public/{bucket-name}/{path}
```

Ejemplo:
```
https://abc123.supabase.co/storage/v1/object/public/amg-public-image/animals/foundation-1/animal-123/1234567890-foto.jpg
```

Para extraer la ruta:
1. Validar que la URL contiene `/storage/v1/object/public/amg-public-image/`
2. Extraer la parte después de `/amg-public-image/`
3. Usar esa ruta para eliminar: `storage.from(bucket).remove([path])`

### Manejo de URLs externas

- Si la URL no pertenece a Supabase Storage (URLs externas), no intentar eliminarla
- Validar antes de intentar eliminar
- Retornar sin error si la URL es externa

### Estructura de eliminación

```typescript
// En UpdateAnimalUseCase
async execute(input: UpdateAnimalInput): Promise<void> {
  // 1. Obtener fotos actuales del animal
  const currentAnimal = await this.animalRepository.getAnimalById(...);
  const currentPhotoUrls = currentAnimal.photos.map(p => p.url);
  
  // 2. Resolver nuevas fotos (subir archivos nuevos, mantener URLs existentes)
  const resolvedPhotoUrls = await this.resolvePhotoUrls(...);
  
  // 3. Detectar fotos eliminadas (están en currentPhotoUrls pero no en resolvedPhotoUrls)
  const deletedPhotoUrls = currentPhotoUrls.filter(
    url => !resolvedPhotoUrls.includes(url)
  );
  
  // 4. Eliminar fotos del storage (en paralelo, sin bloquear)
  await Promise.allSettled(
    deletedPhotoUrls.map(url => 
      this.deletePublicImageUseCase.execute({ url })
    )
  );
  
  // 5. Actualizar animal y fotos en BD
  await this.animalRepository.updateAnimal(...);
  await this.animalRepository.replaceAnimalPhotos(...);
}
```

### Traducciones (OBLIGATORIO si hay UI con texto)

- Agregar traducciones en:
  - `src/messages/es/storage.json` (español)
  - `src/messages/en/storage.json` (inglés)
- Keys sugeridas:
  - `storage.delete.error.generic`: "Error al eliminar la imagen"
  - `storage.delete.error.notFound`: "La imagen no se encontró"
  - `storage.delete.error.permissionDenied`: "No se tienen permisos para eliminar la imagen"
  - `storage.delete.success`: "Imagen eliminada correctamente" (opcional, si se muestra mensaje)

---

## Implementación sugerida

### 1. Agregar método a IPublicImageStorage

```typescript
// domain/repositories/IPublicImageStorage.ts
export interface IPublicImageStorage {
  // ... métodos existentes
  deleteImage(url: string): Promise<void>;
}
```

### 2. Implementar en PublicImageStorage

```typescript
// infrastructure/repositories/PublicImageStorage.ts
async deleteImage(url: string): Promise<void> {
  try {
    // Validar que la URL pertenece a nuestro bucket
    if (!this.isStorageUrl(url)) {
      // URL externa, no intentar eliminar
      return;
    }
    
    const bucketName = getPublicImageBucket();
    const path = this.extractPathFromUrl(url);
    
    const { error } = await supabaseClient.storage
      .from(bucketName)
      .remove([path]);
    
    if (error) {
      // Log error pero no lanzar excepción crítica
      console.error('Error deleting image from storage:', error);
      // Opcional: lanzar error no crítico o retornar sin error
    }
  } catch (error) {
    // Log error pero no bloquear operación principal
    console.error('Unexpected error deleting image:', error);
  }
}

private isStorageUrl(url: string): boolean {
  const bucketName = getPublicImageBucket();
  return url.includes(`/storage/v1/object/public/${bucketName}/`);
}

private extractPathFromUrl(url: string): string {
  const bucketName = getPublicImageBucket();
  const prefix = `/storage/v1/object/public/${bucketName}/`;
  const index = url.indexOf(prefix);
  if (index === -1) return '';
  return url.substring(index + prefix.length);
}
```

### 3. Crear DeletePublicImageUseCase

```typescript
// domain/usecases/storage/DeletePublicImageUseCase.ts
export class DeletePublicImageUseCase {
  constructor(
    private readonly publicImageStorage: IPublicImageStorage,
  ) {}
  
  async execute({ url }: { url: string }): Promise<void> {
    await this.publicImageStorage.deleteImage(url);
  }
}
```

### 4. Modificar UpdateAnimalUseCase

```typescript
// domain/usecases/animals/UpdateAnimalUseCase.ts
export class UpdateAnimalUseCase {
  constructor(
    // ... dependencias existentes
    private readonly deletePublicImageUseCase: DeletePublicImageUseCase,
  ) {}
  
  async execute(input: UpdateAnimalInput): Promise<void> {
    // ... código existente para obtener foundationId, etc.
    
    // Obtener fotos actuales del animal ANTES de hacer cambios
    const currentAnimal = await this.animalRepository.getAnimalById({
      animalId: input.animalId,
      foundationId,
    });
    const currentPhotoUrls = currentAnimal.photos.map(p => p.url);
    
    // Resolver nuevas fotos (subir archivos nuevos)
    const resolvedPhotoUrls = await this.resolvePhotoUrls({
      photos: input.photos,
      foundationId,
      animalId: String(input.animalId),
    });
    
    // Detectar fotos eliminadas (están en currentPhotoUrls pero no en resolvedPhotoUrls)
    const deletedPhotoUrls = currentPhotoUrls.filter(
      url => !resolvedPhotoUrls.includes(url)
    );
    
    // Eliminar fotos del storage ANTES de actualizar la BD (en paralelo, sin bloquear)
    await Promise.allSettled(
      deletedPhotoUrls.map(url => 
        this.deletePublicImageUseCase.execute({ url })
      )
    );
    
    // Continuar con actualización normal
    const coverImageUrl = resolvedPhotoUrls[0] ?? null;
    
    await this.animalRepository.updateAnimal({
      // ... parámetros existentes
      coverImageUrl,
    });
    
    // replaceAnimalPhotos ya elimina todas las fotos antiguas y inserta las nuevas
    // Esto asegura que la BD quede sincronizada
    await this.animalRepository.replaceAnimalPhotos({
      animalId: input.animalId,
      photoUrls: resolvedPhotoUrls,
    });
  }
}
```

### 5. Modificar DeleteAnimalUseCase

```typescript
// domain/usecases/animals/DeleteAnimalUseCase.ts
export class DeleteAnimalUseCase {
  constructor(
    private readonly animalRepository: IAnimalRepository,
    private readonly authRepository: IAuthRepository,
    private readonly foundationMembershipRepository: IFoundationMembershipRepository,
    private readonly deletePublicImageUseCase: DeletePublicImageUseCase,
  ) {}
  
  async execute(input: DeleteAnimalInput): Promise<void> {
    const session = await this.authRepository.getSession();
    if (!session?.user?.id) {
      throw new Error("errors.unauthorized");
    }
    
    const foundationId = await this.foundationMembershipRepository.getFoundationIdForUser(session.user.id);
    
    // Obtener todas las fotos del animal ANTES de eliminarlo
    const animal = await this.animalRepository.getAnimalById({
      animalId: input.animalId,
      foundationId,
    });
    const photoUrls = animal.photos.map(p => p.url);
    
    // Eliminar fotos del storage (en paralelo, sin bloquear)
    await Promise.allSettled(
      photoUrls.map(url => 
        this.deletePublicImageUseCase.execute({ url })
      )
    );
    
    // Eliminar referencias de animal_photos (si no se hace automáticamente con CASCADE)
    // Nota: Verificar si hay CASCADE DELETE configurado en la BD
    // Si no hay, agregar método en AnimalRepository para eliminar fotos
    
    // Eliminar el animal
    await this.animalRepository.deleteAnimal({
      animalId: input.animalId,
      foundationId,
    });
  }
}
```

### 6. Verificar/Agregar método para eliminar fotos en AnimalRepository

```typescript
// infrastructure/repositories/AnimalRepository.ts
async deleteAnimalPhotos({ animalId }: { animalId: number }): Promise<void> {
  const { error } = await supabaseClient
    .from("animal_photos")
    .delete()
    .eq("animal_id", animalId);
  
  if (error) {
    throw new Error(this.translateAnimalsError(error));
  }
}
```

Y actualizar `DeleteAnimalUseCase` para usarlo si no hay CASCADE DELETE:
```typescript
// Eliminar referencias de animal_photos antes de eliminar el animal
await this.animalRepository.deleteAnimalPhotos({ animalId: input.animalId });
```

### 5. Registrar en IoC

- Agregar `DeletePublicImageUseCase` al contenedor IoC
- Registrar en `usecases.types.ts` y `usecases.container.ts`

### 6. Agregar traducciones

```json
// src/messages/es/storage.json
{
  "delete": {
    "error": {
      "generic": "Error al eliminar la imagen",
      "notFound": "La imagen no se encontró",
      "permissionDenied": "No se tienen permisos para eliminar la imagen"
    },
    "success": "Imagen eliminada correctamente"
  }
}
```

```json
// src/messages/en/storage.json
{
  "delete": {
    "error": {
      "generic": "Error deleting image",
      "notFound": "Image not found",
      "permissionDenied": "Permission denied to delete image"
    },
    "success": "Image deleted successfully"
  }
}
```

---

## Validación

Comandos mínimos:
- `npm run dev` (verificar que la eliminación funciona)
- `npm run build` (verificar que no hay errores de compilación)

Pruebas manuales:
1. Editar un animal con fotos existentes
2. Eliminar una o más fotos desde el formulario
3. Guardar el formulario
4. Verificar en Supabase Dashboard > Storage que las imágenes se eliminaron del bucket
5. Verificar en la BD que las referencias se eliminaron de `animal_photos`
6. Verificar que las nuevas fotos (si se agregaron) se subieron correctamente

---

## Definición de Hecho

- [ ] Criterios de aceptación cumplidos
- [ ] `npm run dev` OK
- [ ] `npm run build` OK
- [ ] Sin violaciones de capas
- [ ] Sin cambios fuera del alcance
- [ ] **Traducciones incluidas**:
  - [ ] Textos agregados en `src/messages/es/storage.json`
  - [ ] Textos agregados en `src/messages/en/storage.json`
- [ ] Pruebas manuales realizadas:
  - [ ] Eliminación de fotos funciona correctamente
  - [ ] Las imágenes se eliminan del storage
  - [ ] Las referencias se eliminan de la BD
  - [ ] Los errores se manejan sin bloquear la operación
- Commit sugerido:
  `feat: implementar eliminación de imágenes de animales desde Supabase Storage (HU-045)`
