# HU-043 — Sistema de almacenamiento de imágenes públicas con Supabase Storage

**Como** desarrollador  
**Quiero** un sistema centralizado para almacenar imágenes públicas en Supabase Storage  
**Para** reemplazar el uso de URLs y base64 directamente en la base de datos y tener un manejo consistente de archivos

---

## Dependencias

- HU-001 (Next.js App Router)
- HU-011 (Conexión a Supabase configurada)
- HU-016 (Sistema de traducciones configurado)
- HU-024 (Crear animales implementado)
- HU-030 (Crear productos implementado)
- Bucket `amg-public-image` creado en Supabase Storage (configuración manual)

---

## Contexto / Notas

- Actualmente el código maneja imágenes de diferentes formas:
  - URLs directas en la base de datos (productos, animales, eventos, logos)
  - Base64/data URLs en formularios (ej: `AddAnimalForm`)
  - Algunos repositorios ya tienen métodos de upload pero usan buckets diferentes (ej: `ProductRepository` usa bucket "products")
- Esta HU unifica el almacenamiento de imágenes públicas usando el bucket `amg-public-image` en Supabase Storage.
- **Solo para imágenes públicas**: productos, animales, eventos, logos de fundaciones.
- **NO incluye**:
  - Archivos internos de fundaciones
  - Documentos enviados en solicitudes de adopción (estos usan otro bucket)
- El bucket debe estar configurado como público en Supabase Dashboard.
- Estructura de carpetas sugerida:
  - `animals/{foundationId}/{animalId}/` - Fotos de animales
  - `products/{foundationId}/` - Imágenes de productos
  - `events/{foundationId}/` - Banners de eventos
  - `foundations/{foundationId}/` - Logos de fundaciones

---

## Diseño (OBLIGATORIO si hay UI)

Referencias:
- Diseño: `docs/design/system.md`
- Componentes existentes que manejan imágenes:
  - `src/presentation/components/animals/AddAnimalForm.tsx`
  - `src/presentation/components/products/ProductForm.tsx`

Reglas:
- El sistema debe ser transparente para los componentes de UI.
- Los componentes solo necesitan pasar `File` objects, no manejar uploads directamente.
- Las URLs públicas deben generarse automáticamente después del upload.
- El sistema debe manejar errores de forma amigable.

---

## Reglas técnicas

- Arquitectura: ver `docs/01_arquitectura.md`
- Reglas Codex: ver `docs/02_reglas_de_codex.md`

## Alcance

Incluye:
- Crear servicio/repositorio centralizado para almacenamiento de imágenes públicas (`IPublicImageStorage` e implementación)
- Crear UseCase para upload de imágenes (`UploadPublicImageUseCase`)
- Definir estructura de carpetas en el bucket `amg-public-image`
- Migrar `ProductRepository.uploadProductImage()` para usar el nuevo sistema
- Migrar `AddAnimalForm` para subir imágenes reales en lugar de base64
- Actualizar `CreateAnimalUseCase` para usar el nuevo sistema de upload
- Validación de imágenes (formato, tamaño)
- Generación de URLs públicas
- Manejo de errores de storage
- Limpieza de archivos antiguos al actualizar (opcional)

No incluye:
- Almacenamiento de documentos de solicitudes de adopción (ya tienen su propio bucket)
- Archivos internos de fundaciones
- Sistema de CDN o optimización de imágenes
- Compresión automática de imágenes
- Thumbnails o múltiples tamaños
- Migración de imágenes existentes en la BD (solo nuevas imágenes)

---

## Criterios de aceptación (Given / When / Then)

### 1) Servicio de almacenamiento implementado

- **Dado** que se necesita almacenar imágenes públicas
- **Cuando** se implementa el sistema
- **Entonces** existe una interfaz `IPublicImageStorage` en `domain/repositories/`
- **Y** existe una implementación `PublicImageStorage` en `infrastructure/repositories/`
- **Y** el servicio usa el bucket `amg-public-image` de Supabase Storage
- **Y** el servicio genera URLs públicas automáticamente

### 2) Estructura de carpetas definida

- **Dado** que se suben imágenes de diferentes tipos
- **Cuando** se almacenan en Supabase Storage
- **Entonces** las imágenes se organizan en carpetas según tipo:
  - `animals/{foundationId}/{animalId}/` para fotos de animales
  - `products/{foundationId}/` para imágenes de productos
  - `events/{foundationId}/` para banners de eventos
  - `foundations/{foundationId}/` para logos de fundaciones
- **Y** los nombres de archivo incluyen timestamp para evitar colisiones

### 3) UseCase de upload implementado

- **Dado** que se necesita subir una imagen pública
- **Cuando** se implementa la lógica de negocio
- **Entonces** existe un UseCase `UploadPublicImageUseCase` en `domain/usecases/storage/`
- **Y** el UseCase recibe: `file`, `type` (animal/product/event/foundation), `foundationId`, `entityId` (opcional)
- **Y** el UseCase retorna la URL pública de la imagen subida
- **Y** el UseCase valida formato y tamaño antes de subir

### 4) Validación de imágenes

- **Dado** que se intenta subir una imagen
- **Cuando** se valida antes del upload
- **Entonces** se valida que:
  - El formato es válido (PNG, JPG, JPEG, GIF, WEBP)
  - El tamaño no excede el límite (ej: 5MB)
  - El archivo es realmente una imagen (validar MIME type)
- **Y** se retorna error descriptivo si la validación falla

### 5) Migración de ProductRepository

- **Dado** que `ProductRepository` ya tiene método de upload
- **Cuando** se migra al nuevo sistema
- **Entonces** `ProductRepository.uploadProductImage()` usa `IPublicImageStorage`
- **Y** se elimina el código duplicado de upload
- **Y** las imágenes se almacenan en `products/{foundationId}/`
- **Y** el bucket "products" ya no se usa (o se depreca)

### 6) Migración de AddAnimalForm

- **Dado** que `AddAnimalForm` usa base64 actualmente
- **Cuando** se migra al nuevo sistema
- **Entonces** el formulario sube imágenes reales usando `UploadPublicImageUseCase`
- **Y** las imágenes se almacenan en `animals/{foundationId}/{animalId}/`
- **Y** se elimina el uso de `fileToDataUrl` para almacenamiento
- **Y** las URLs se guardan en la base de datos después del upload

### 7) Actualización de CreateAnimalUseCase

- **Dado** que `CreateAnimalUseCase` recibe URLs de fotos
- **Cuando** se actualiza para usar el nuevo sistema
- **Entonces** el UseCase puede recibir `File[]` en lugar de solo URLs
- **Y** el UseCase sube las imágenes antes de crear el animal
- **Y** las URLs generadas se guardan en `animal_photos` y `cover_image_url`

### 8) Manejo de errores

- **Dado** que puede fallar el upload de imágenes
- **Cuando** ocurre un error
- **Entonces** se manejan los siguientes casos:
  - Error de conexión → "No se pudo conectar al servidor de almacenamiento"
  - Archivo muy grande → "El archivo excede el tamaño máximo permitido"
  - Formato inválido → "El formato de imagen no es válido"
  - Error de permisos → "No tienes permisos para subir imágenes"
- **Y** los mensajes de error están traducidos (ES/EN)
- **Y** los errores se propagan correctamente a los componentes

### 9) URLs públicas generadas

- **Dado** que se sube una imagen exitosamente
- **Cuando** se completa el upload
- **Entonces** se genera una URL pública usando `supabaseClient.storage.from('amg-public-image').getPublicUrl()`
- **Y** la URL es accesible públicamente sin autenticación
- **Y** la URL se guarda en la base de datos (en el campo correspondiente)

### 10) Traducciones

- **Dado** que la aplicación soporta ES/EN
- **Cuando** se muestran mensajes relacionados con imágenes
- **Entonces** todos los textos están traducidos:
  - Mensajes de error de upload
  - Mensajes de validación
  - Mensajes de éxito
- **Y** los textos están en `src/messages/es/storage.json` y `src/messages/en/storage.json`
- **Y** se usa `useTranslations` para acceder a traducciones

---

## Reglas técnicas

### Arquitectura
- Presentation solo consume UseCases vía IoC (no importa repositorios concretos).
- Domain no importa React/Next/MUI/Tailwind/Inversify/Supabase.
- Infrastructure contiene implementaciones y wiring IoC.
- El servicio de storage debe estar en Infrastructure, la interfaz en Domain.

### Estructura de carpetas en Supabase Storage

```
amg-public-image/
├── animals/
│   └── {foundationId}/
│       └── {animalId}/
│           └── {timestamp}-{sanitized-filename}
├── products/
│   └── {foundationId}/
│       └── {timestamp}-{sanitized-filename}
├── events/
│   └── {foundationId}/
│       └── {timestamp}-{sanitized-filename}
└── foundations/
    └── {foundationId}/
        └── {timestamp}-{sanitized-filename}
```

### Validación de imágenes
- Formatos permitidos: `image/png`, `image/jpeg`, `image/jpg`, `image/gif`, `image/webp`
- Tamaño máximo: 5MB por imagen
- Validar MIME type del archivo
- Sanitizar nombres de archivo (eliminar caracteres especiales, espacios, etc.)

### Generación de nombres de archivo
- Formato: `{timestamp}-{sanitized-filename}`
- Timestamp: `Date.now()` o `new Date().toISOString().replace(/[:.]/g, '-')`
- Sanitizar: convertir a lowercase, reemplazar espacios y caracteres especiales por guiones
- Ejemplo: `"Mi Foto.jpg"` → `"1234567890-mi-foto.jpg"`

### Manejo de errores
- Los errores de Supabase Storage deben traducirse a mensajes amigables.
- Usar códigos de error de Supabase para identificar tipos de error.
- Los mensajes de error deben estar en los archivos de traducción.

### Traducciones (OBLIGATORIO si hay UI con texto)
- **TODOS los textos visibles en la UI deben estar traducidos** (español e inglés).
- Usar el sistema de traducciones configurado en HU-016 (`next-intl`).
- Agregar traducciones en:
  - `src/messages/es/storage.json` (español)
  - `src/messages/en/storage.json` (inglés)
- Keys sugeridas:
  - `storage.upload.success`
  - `storage.upload.error.connection`
  - `storage.upload.error.fileTooLarge`
  - `storage.upload.error.invalidFormat`
  - `storage.upload.error.permissionDenied`
  - `storage.upload.error.generic`
  - `storage.validation.maxSize`
  - `storage.validation.allowedFormats`
- Usar `useTranslations("storage")` para acceder a traducciones.

### Configuración de nombres de buckets
- Los nombres de buckets deben configurarse en variables de entorno o en el archivo de configuración.
- Agregar función en `src/infrastructure/config/environment.ts`:
  ```typescript
  export function getPublicImageBucket(): string {
    return process.env.NEXT_PUBLIC_SUPABASE_PUBLIC_IMAGE_BUCKET || 'amg-public-image';
  }
  ```
- O usar constante en el repositorio si no se requiere configuración por entorno:
  ```typescript
  const PUBLIC_IMAGE_BUCKET = 'amg-public-image';
  ```
- Si se usa variable de entorno, agregar a `.env.example`:
  ```bash
  NEXT_PUBLIC_SUPABASE_PUBLIC_IMAGE_BUCKET=amg-public-image
  ```
- El valor por defecto debe ser `'amg-public-image'` si no se especifica la variable.

### Dependencias / Paquetes
- No agregar dependencias nuevas salvo que esta HU lo indique explícitamente.
- Usar Supabase Storage que ya está disponible.
- Si aparece error 403/conectividad:
  1) Detenerse
  2) Pedir dominios requeridos
  3) Explicar por qué se requieren
  4) No continuar

---

## Implementación sugerida (opcional)

### Estructura de archivos sugerida:

```
src/domain/
├── repositories/
│   └── IPublicImageStorage.ts (nuevo)
└── usecases/
    └── storage/
        └── UploadPublicImageUseCase.ts (nuevo)

src/infrastructure/
├── repositories/
│   └── PublicImageStorage.ts (nuevo)
└── ioc/
    └── container.ts (registrar UseCase)

src/presentation/
└── components/
    └── animals/
        └── AddAnimalForm.tsx (modificar)
    └── products/
        └── ProductForm.tsx (modificar si es necesario)
```

### Flujo de implementación:

1. **Configurar nombres de buckets**:
   - Agregar función `getPublicImageBucket()` en `src/infrastructure/config/environment.ts`
   - O usar constante `PUBLIC_IMAGE_BUCKET = 'amg-public-image'` en el repositorio
   - Si se usa variable de entorno, agregar a `.env.example`

2. **Crear interfaz del repositorio**:
   ```typescript
   // IPublicImageStorage.ts
   export type PublicImageType = 'animal' | 'product' | 'event' | 'foundation';
   
   export interface UploadPublicImageParams {
     file: File;
     type: PublicImageType;
     foundationId: string;
     entityId?: string; // Para animales (animalId), opcional para otros
   }
   
   export interface IPublicImageStorage {
     uploadImage(params: UploadPublicImageParams): Promise<string>; // Retorna URL pública
   }
   ```

3. **Implementar repositorio**:
   ```typescript
   // PublicImageStorage.ts
   class PublicImageStorage implements IPublicImageStorage {
     async uploadImage({ file, type, foundationId, entityId }: UploadPublicImageParams): Promise<string> {
       // Validar formato y tamaño
       this.validateImage(file);
       
       // Generar ruta según tipo
       const path = this.generatePath(type, foundationId, entityId, file.name);
       
       // Subir a Supabase Storage (usar constante o función de configuración)
       const bucketName = getPublicImageBucket(); // o usar constante
       const { data, error } = await supabaseClient.storage
         .from(bucketName)
         .upload(path, file, { upsert: false });
       
       if (error) throw new Error(this.translateError(error));
       
       // Generar URL pública
       const { data: urlData } = supabaseClient.storage
         .from(bucketName)
         .getPublicUrl(data.path);
       
       return urlData.publicUrl;
     }
     
     private validateImage(file: File): void {
       // Validar formato, tamaño, etc.
     }
     
     private generatePath(type: PublicImageType, foundationId: string, entityId: string | undefined, fileName: string): string {
       const sanitized = this.sanitizeFileName(fileName);
       const timestamp = Date.now();
       const basePath = `${type}s/${foundationId}`;
       
       if (type === 'animal' && entityId) {
         return `${basePath}/${entityId}/${timestamp}-${sanitized}`;
       }
       
       return `${basePath}/${timestamp}-${sanitized}`;
     }
     
     private sanitizeFileName(fileName: string): string {
       return fileName
         .replace(/[^a-z0-9.\-_]/gi, '-')
         .toLowerCase();
     }
   }
   ```

4. **Crear UseCase**:
   ```typescript
   // UploadPublicImageUseCase.ts
   export class UploadPublicImageUseCase {
     constructor(private readonly imageStorage: IPublicImageStorage) {}
     
     async execute(params: UploadPublicImageParams): Promise<string> {
       return await this.imageStorage.uploadImage(params);
     }
   }
   ```

4. **Registrar en IoC**:
   - Agregar `IPublicImageStorage` y `PublicImageStorage` al contenedor
   - Registrar `UploadPublicImageUseCase`

5. **Migrar ProductRepository**:
   - Reemplazar `uploadProductImage()` para usar `IPublicImageStorage`
   - Eliminar código duplicado

6. **Migrar AddAnimalForm**:
   - En lugar de convertir a base64, subir imágenes directamente
   - Usar `UploadPublicImageUseCase` para subir cada imagen
   - Guardar URLs en lugar de data URLs
   - Mostrar preview usando las URLs públicas

7. **Actualizar CreateAnimalUseCase**:
   - Modificar para aceptar `File[]` además de URLs
   - Subir imágenes antes de crear el animal
   - Usar las URLs generadas para `animal_photos` y `cover_image_url`

### Configuración de Supabase Storage (Manual)

1. Ir a Supabase Dashboard > Storage
2. Crear bucket `amg-public-image` si no existe (o el nombre configurado en la variable de entorno)
3. Configurar como público (Public bucket)
4. Configurar políticas RLS si es necesario (o permitir acceso público)
5. (Opcional) Configurar variable de entorno `NEXT_PUBLIC_SUPABASE_PUBLIC_IMAGE_BUCKET` si se desea usar un nombre diferente

### Notas importantes:
- El bucket debe estar configurado como público para que las URLs funcionen.
- Las imágenes antiguas en la BD (URLs externas o base64) seguirán funcionando, solo las nuevas usarán el nuevo sistema.
- No es necesario migrar imágenes existentes en esta HU.
- El sistema debe ser retrocompatible: si se pasa una URL en lugar de un File, usarla directamente.

---

## Validación

Comandos mínimos:
- `npm run dev` (verificar que el upload funciona)
- `npm run build` (verificar que no hay errores de compilación)

Verificaciones:
- Las imágenes se suben correctamente a `amg-public-image`
- Las URLs públicas se generan correctamente
- Las imágenes se organizan en las carpetas correctas según tipo
- La validación de formato y tamaño funciona
- Los errores se manejan correctamente y se muestran mensajes traducidos
- `ProductRepository` usa el nuevo sistema
- `AddAnimalForm` sube imágenes reales en lugar de base64
- Las URLs se guardan correctamente en la base de datos
- Las traducciones están completas (ES/EN)
- El bucket está configurado como público en Supabase

---

## Definición de Hecho

- [ ] Criterios de aceptación cumplidos
- [ ] `npm run dev` OK
- [ ] `npm run build` OK
- [ ] Sin violaciones de capas
- [ ] Sin cambios fuera del alcance
- [ ] **Traducciones incluidas** (si aplica UI con texto):
  - [ ] Textos agregados en `src/messages/es/storage.json`
  - [ ] Textos agregados en `src/messages/en/storage.json`
  - [ ] Componentes usan `useTranslations` (no textos hardcodeados)
  - [ ] Keys consistentes entre idiomas
- [ ] Servicio de storage creado e implementado
- [ ] UseCase de upload creado y registrado en IoC
- [ ] `ProductRepository` migrado al nuevo sistema
- [ ] `AddAnimalForm` migrado para subir imágenes reales
- [ ] `CreateAnimalUseCase` actualizado para manejar uploads
- [ ] Validación de imágenes implementada
- [ ] Bucket `amg-public-image` configurado como público en Supabase
- [ ] Estructura de carpetas implementada correctamente
- Commit sugerido:
  `feat: implement public image storage with Supabase Storage`
