# HU-023 — Gestión de Animales (Funcionalidad con Supabase)

**Como** usuario de una fundación  
**Quiero** cargar, filtrar y gestionar animales desde la base de datos  
**Para** tener datos reales y persistentes de los animales de mi fundación

---

## Dependencias

- HU-011 (Conexión a Supabase configurada)
- HU-013 (Estrategia de roles y protección de rutas definida)
- HU-018 (Layout del dashboard de fundaciones con sidebar)
- HU-022 (UI de gestión de animales implementada) - **REQUERIDO**

---

## Contexto / Notas

- Esta HU implementa la **lógica de negocio** para gestionar animales conectando con Supabase.
- La UI ya está implementada (HU-022), ahora se conecta con el backend.
- El flujo debe:
  1. Cargar animales de la fundación del usuario autenticado desde Supabase
  2. Filtrar y buscar animales en el servidor (o cliente según estrategia)
  3. Paginar resultados desde la base de datos
  4. Permitir editar y eliminar animales (opcional, puede ser HU futura)
- Se deben manejar errores comunes (no encontrado, sin permisos, conectividad, etc.).
- Los datos deben mapearse correctamente desde la estructura de BD a los modelos de dominio.

Modelo de datos (según `docs/scripts/db.sql`):
- Tabla `animals`:
  - Campos: `id`, `foundation_id`, `name`, `species`, `breed`, `sex`, `age_months`, `size`, `status`, `description`, `cover_image_url`, `is_published`, `created_at`
- Tabla `animal_photos` (relación 1:N):
  - Campos: `id`, `animal_id`, `url`, `sort_order`
- Relación con fundación:
  - `animals.foundation_id` referencia `foundations(id)`
  - El usuario debe ser miembro de la fundación (vía `foundation_members`)

Reglas de autorización (alto nivel):
- El usuario debe estar autenticado.
- Para ver animales, el usuario debe ser miembro de la fundación.
- Solo puede ver/editar animales de su propia fundación.
- La seguridad final debe depender de RLS en Supabase (el middleware solo es "soft").

Mapeo de datos:
- `animals.id` → ID numérico (formatear como #AG-XXXX para UI)
- `animals.species` → Especie (dog/cat/bird/etc)
- `animals.status` → Estado (available/adopted/in_treatment/inactive)
- `animals.created_at` → Fecha de admisión (formatear para UI)
- `animals.cover_image_url` → Imagen de perfil (usar primera foto de `animal_photos` si no hay cover_image_url)

---

## Alcance

Incluye:
- Crear lógica de **lectura** de animales de la fundación:
  - Obtener `foundation_id` del usuario autenticado (vía `foundation_members`)
  - Leer `animals` filtrados por `foundation_id`
  - Incluir `cover_image_url` o primera foto de `animal_photos`
  - Mapear a modelo de dominio/DTO
- Crear lógica de **filtrado y búsqueda**:
  - Filtrar por status, species en la query de Supabase
  - Buscar por nombre, ID o raza (usar `ilike` o `textSearch` de Supabase)
  - Ordenar por fecha, nombre, etc.
- Crear lógica de **paginación**:
  - Implementar paginación server-side con Supabase (usar `range()`)
  - Calcular total de resultados para mostrar en paginación
- Conectar HU-022 para:
  - Cargar datos iniciales (loading + manejo de error)
  - Aplicar filtros y búsqueda (loading + actualización de tabla)
  - Paginar resultados (loading + actualización de tabla)
- Mensajes traducidos (i18n):
  - Error al cargar animales
  - Error genérico
  - No autorizado / sin permisos
  - Sin animales encontrados
- Reemplazar mocks con datos reales de Supabase

No incluye:
- Crear/editar/eliminar animales (eso va en HUs futuras)
- Upload real de imágenes (solo lectura de URLs existentes)
- Gestión de múltiples fundaciones por usuario (se asume 1 fundación "activa" por perfil)
- Permisos granulares avanzados (más allá de membership básico)
- Tests automatizados (si luego se define estrategia de tests, se hará en HU futura)
- Optimización avanzada de queries (indexes, etc. se asume que ya están en BD)

---

## Criterios de aceptación (Given / When / Then)

### 1) Consulta de animales de la fundación

- **Dado** un usuario autenticado con rol `foundation_user`
- **Cuando** navega a la pantalla de gestión de animales (HU-022)
- **Entonces** el sistema consulta la fundación del usuario (usando `foundation_members`)
- **Y** obtiene los animales de esa fundación desde `animals`
- **Y** muestra los animales en la tabla
- **Y** si no hay animales, muestra mensaje apropiado

---

### 2) Filtrado por status y species

- **Dado** que el usuario selecciona un filtro (Status o Species)
- **Cuando** aplica el filtro
- **Entonces** se envía la query a Supabase con el filtro correspondiente
- **Y** la tabla se actualiza con los resultados filtrados
- **Y** se muestra estado de loading durante la consulta
- **Y** los filtros pueden combinarse (Status + Species)

---

### 3) Búsqueda por nombre, ID o raza

- **Dado** que el usuario escribe en el campo de búsqueda
- **Cuando** busca por nombre, ID o raza
- **Entonces** se envía la query a Supabase con el término de búsqueda
- **Y** la tabla se actualiza con los resultados
- **Y** la búsqueda es case-insensitive
- **Y** si no hay resultados, se muestra mensaje apropiado

---

### 4) Ordenamiento de resultados

- **Dado** que el usuario selecciona un orden (Newest First, Oldest First, Name A-Z, etc.)
- **Cuando** aplica el ordenamiento
- **Entonces** se envía la query a Supabase con el `order` correspondiente
- **Y** la tabla se actualiza con los resultados ordenados

---

### 5) Paginación server-side

- **Dado** que hay más animales de los que caben en una página
- **Cuando** el usuario cambia de página
- **Entonces** se envía una nueva query a Supabase con el rango correspondiente
- **Y** se muestra el total de resultados correctamente
- **Y** la tabla se actualiza con los animales de la página seleccionada
- **Y** se muestra estado de loading durante la consulta

---

### 6) Mapeo correcto de datos

- **Dado** que se cargan animales desde Supabase
- **Cuando** se mapean a la UI
- **Entonces** los campos se mapean correctamente:
  - `id` → formateado como #AG-XXXX
  - `species` → traducido y mostrado correctamente
  - `breed` → mostrado junto con species (ej: "Dog (Golden Ret.)")
  - `status` → traducido y mostrado con badge correcto
  - `created_at` → formateado como fecha legible (ej: "Oct 12, 2023")
  - `cover_image_url` → usado para imagen de perfil (o primera foto de `animal_photos`)
- **Y** los datos se muestran correctamente en la tabla

---

### 7) Manejo de errores y permisos

- **Dado** que ocurre un error al consultar o filtrar
- **Cuando** Supabase retorna error (por ejemplo: sin permisos, not found, conectividad)
- **Entonces** se muestra un mensaje traducido apropiado
- **Y** la UI no se rompe ni queda en un estado inconsistente
- **Y** si el usuario no tiene permisos (no es miembro), se bloquea la operación y se informa

---

### 8) Estados de loading

- **Dado** que se realiza una operación (cargar, filtrar, buscar, paginar)
- **Cuando** se está ejecutando la query
- **Entonces** se muestra un estado de loading (spinner, skeleton, etc.)
- **Y** la UI indica que se está cargando
- **Y** al finalizar, el estado de loading desaparece

---

### 9) Reglas de arquitectura cumplidas

- **Dado** que se implementa la lógica
- **Cuando** se revisan imports y capas
- **Entonces** Domain no importa Supabase/React/Next/MUI
- **Y** Presentation consume UseCases vía IoC
- **Y** Infrastructure contiene las implementaciones de repositorios y el wiring

---

## Reglas técnicas

### Arquitectura
- Presentation solo consume UseCases vía IoC (no importa repositorios concretos).
- Domain no importa React/Next/MUI/Tailwind/Inversify/Supabase.
- Infrastructure contiene implementaciones y wiring IoC.
- **Supabase solo vive en Infrastructure**: servicios y repositorios.

### Flujo de consulta de animales

1. Usuario navega a `/foundations/animals` (Presentation)
2. `AnimalsManagementPage` llama a `GetAnimalsUseCase` (Presentation → Domain)
3. UseCase obtiene `foundation_id` del usuario (vía `GetSessionUseCase` o similar)
4. UseCase llama a `AnimalRepository.getAnimals()` (Domain → Infrastructure)
5. `AnimalRepository.getAnimals()` consulta Supabase con filtros
6. `AnimalRepository` retorna lista de animales mapeados
7. UseCase retorna lista de animales
8. Presentation muestra animales en la tabla

### Obtener foundation_id del usuario

- Usar `supabaseClient.auth.getUser()` para obtener `user.id`.
- Query: `SELECT foundation_id FROM foundation_members WHERE user_id = :userId LIMIT 1`
- Si no existe membership, manejar como error (usuario sin fundación).

### Consulta de animales

- Query base: `SELECT * FROM animals WHERE foundation_id = :foundationId`
- Aplicar filtros:
  - Status: `AND status = :status` (si no es "all")
  - Species: `AND species = :species` (si no es "all")
- Aplicar búsqueda:
  - `AND (name ILIKE :search OR breed ILIKE :search OR id::text ILIKE :search)`
- Aplicar ordenamiento:
  - `ORDER BY created_at DESC` (newest first)
  - `ORDER BY created_at ASC` (oldest first)
  - `ORDER BY name ASC` (name A-Z)
  - `ORDER BY name DESC` (name Z-A)
- Aplicar paginación:
  - `LIMIT :pageSize OFFSET :offset`
- Obtener total:
  - Query separada con `COUNT(*)` o usar `count` de Supabase

### Mapeo de datos

- Crear modelo de dominio `AnimalManagement` o extender `Animal` existente.
- Mapear campos de BD a modelo:
  - `id` → `id` (formatear para UI)
  - `name` → `name`
  - `species` → `species`
  - `breed` → `breed`
  - `status` → `status`
  - `created_at` → `admissionDate` (formatear)
  - `cover_image_url` → `imageUrl` (o primera foto de `animal_photos`)

### Imagen de perfil

- Si `cover_image_url` existe, usarla.
- Si no, consultar `animal_photos` para obtener la primera foto (`sort_order = 0` o `MIN(sort_order)`).
- Si no hay fotos, usar placeholder o imagen por defecto.

### Manejo de errores

- Los errores de Supabase deben traducirse a mensajes legibles en español e inglés.
- Usar `PostgrestError` de Supabase para identificar tipos de error.
- Los mensajes de error deben estar en los archivos de traducción.
- Mostrar errores en la UI sin romper el layout.

### Traducciones
- **TODOS los mensajes visibles en la UI deben estar traducidos** (español e inglés).
- Usar el sistema de traducciones configurado en HU-016 (`next-intl`).
- Agregar traducciones en:
  - `src/messages/es/animals.json` (español)
  - `src/messages/en/animals.json` (inglés)
- Incluir traducciones para:
  - Mensajes de error
  - Estados de loading
  - Mensajes de "sin resultados"
  - Nombres de especies y estados
- Usar `useTranslations` hook de `next-intl` para acceder a traducciones.

### Dependencias / Paquetes
- No agregar dependencias nuevas salvo que esta HU lo indique explícitamente.
- Supabase ya está configurado (HU-011).
- Si aparece error 403/conectividad:
  1) Detenerse
  2) Pedir dominios requeridos
  3) Explicar por qué se requieren
  4) No continuar

---

## Implementación sugerida

### Estructura de archivos sugerida:

```
src/domain/
├── models/
│   └── AnimalManagement.ts          # Modelo de dominio para gestión (o extender Animal)
├── repositories/
│   └── IAnimalRepository.ts         # Agregar métodos: getAnimals, getAnimalsCount
└── usecases/
    └── animals/
        ├── GetAnimalsUseCase.ts     # UseCase para obtener animales con filtros
        └── GetAnimalsCountUseCase.ts # UseCase para obtener total (opcional)

src/infrastructure/
├── repositories/
│   └── AnimalRepository.ts           # Implementar getAnimals, getAnimalsCount
└── ioc/
    └── ...                          # Agregar bindings de nuevos use cases

src/presentation/
└── components/
    └── animals/
        └── AnimalsManagementPage.tsx # Conectar con GetAnimalsUseCase (reemplazar mocks)
```

### Flujo de implementación:

1. **Extender IAnimalRepository**:
   ```typescript
   export interface GetAnimalsParams {
     foundationId: string;
     filters?: {
       status?: string;
       species?: string;
       search?: string;
       sort?: 'newest' | 'oldest' | 'nameAsc' | 'nameDesc';
     };
     pagination?: {
       page: number;
       pageSize: number;
     };
   }
   
   export interface GetAnimalsResult {
     animals: AnimalManagement[];
     total: number;
   }
   
   export interface IAnimalRepository {
     getHomeAnimals(): Promise<HomeAnimals>;
     getAnimals(params: GetAnimalsParams): Promise<GetAnimalsResult>; // Nuevo
     getAnimalsCount(params: GetAnimalsParams): Promise<number>; // Nuevo (opcional)
   }
   ```

2. **Implementar getAnimals en AnimalRepository**:
   - Obtener `foundation_id` del usuario (o recibirlo como parámetro)
   - Construir query de Supabase con filtros
   - Aplicar búsqueda, ordenamiento y paginación
   - Obtener total de resultados
   - Mapear resultados a modelo de dominio
   - Manejar errores y traducirlos

3. **Crear GetAnimalsUseCase**:
   ```typescript
   export interface GetAnimalsInput {
     filters?: {
       status?: string;
       species?: string;
       search?: string;
       sort?: 'newest' | 'oldest' | 'nameAsc' | 'nameDesc';
     };
     pagination?: {
       page: number;
       pageSize: number;
     };
   }
   
   export class GetAnimalsUseCase {
     constructor(
       private readonly animalRepository: IAnimalRepository,
       private readonly authRepository: IAuthRepository // Para obtener foundation_id
     ) {}
     
     async execute(input: GetAnimalsInput): Promise<GetAnimalsResult> {
       // 1. Obtener usuario autenticado
       // 2. Obtener foundation_id del usuario
       // 3. Llamar a animalRepository.getAnimals() con foundation_id y filtros
       // 4. Retornar resultados
     }
   }
   ```

4. **Conectar AnimalsManagementPage con UseCase**:
   - Inyectar `GetAnimalsUseCase` vía IoC
   - Reemplazar mocks con llamadas al UseCase
   - Manejar estados de loading
   - Manejar errores y mostrarlos en la UI
   - Actualizar tabla cuando cambian filtros/búsqueda/paginación

5. **Agregar traducciones**:
   - Agregar mensajes de error en `src/messages/es/animals.json` y `src/messages/en/animals.json`
   - Agregar traducciones de especies y estados
   - Usar `useTranslations('animals')` en componentes

### Estrategia técnica (resumen):
- Identidad: usar `supabase.auth.getUser()` para obtener `user.id`.
- Resolver `foundation_id`:
  - `SELECT foundation_id FROM foundation_members WHERE user_id = :userId LIMIT 1`
- Leer animales:
  - `SELECT * FROM animals WHERE foundation_id = :foundationId [filtros] [orden] [paginación]`
- Obtener total:
  - `SELECT COUNT(*) FROM animals WHERE foundation_id = :foundationId [filtros]`
- Imagen de perfil:
  - Si `cover_image_url` existe, usarla
  - Si no, `SELECT url FROM animal_photos WHERE animal_id = :animalId ORDER BY sort_order LIMIT 1`

---

## Validación

Comandos mínimos:
- `npm run dev` (verificar que no hay errores de compilación)
- `npm run build` (verificar que no hay errores de compilación)

Verificaciones manuales:
- [ ] Los animales se cargan correctamente desde Supabase
- [ ] Los filtros funcionan correctamente
- [ ] La búsqueda funciona correctamente
- [ ] El ordenamiento funciona correctamente
- [ ] La paginación funciona correctamente
- [ ] Se muestran estados de loading apropiados
- [ ] Se manejan errores correctamente
- [ ] Los mensajes de error están traducidos
- [ ] Los datos se mapean correctamente a la UI
- [ ] Las imágenes se muestran correctamente

---

## Definición de Hecho

- [ ] Criterios de aceptación cumplidos
- [ ] `npm run dev` OK
- [ ] `npm run build` OK
- [ ] Método `getAnimals` implementado en `IAnimalRepository` y `AnimalRepository`
- [ ] `GetAnimalsUseCase` creado y funcional
- [ ] `AnimalsManagementPage` conectado con `GetAnimalsUseCase` (mocks reemplazados)
- [ ] Filtrado, búsqueda y ordenamiento funcionan con Supabase
- [ ] Paginación server-side implementada
- [ ] Manejo de errores implementado y traducido
- [ ] Estados de loading implementados
- [ ] Mapeo de datos correcto (formato de ID, fechas, imágenes)
- [ ] **Traducciones incluidas**:
  - [ ] Mensajes de error agregados en `src/messages/es/animals.json`
  - [ ] Mensajes de error agregados en `src/messages/en/animals.json`
  - [ ] Componentes usan `useTranslations` (no textos hardcodeados)
  - [ ] Keys consistentes entre idiomas
- [ ] Sin violaciones de capas
- [ ] Sin cambios fuera del alcance
- Commit sugerido:
  `feat: connect animals management page with Supabase backend`

