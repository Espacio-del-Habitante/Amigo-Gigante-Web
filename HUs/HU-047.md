# HU-047 — Carga y eliminación de logo de fundación con Supabase Storage

**Como** miembro de fundación  
**Quiero** poder subir y eliminar el logo de mi fundación desde el perfil  
**Para** mantener actualizada la imagen de mi organización y evitar acumulación de archivos no utilizados

---

## Dependencias

- HU-001 (Next.js App Router)
- HU-011 (Conexión a Supabase configurada)
- HU-016 (Sistema de traducciones configurado)
- HU-019 (Perfil de fundación implementado)
- HU-043 (Sistema de almacenamiento de imágenes públicas implementado)
- HU-045 (Eliminación de imágenes de animales implementada - para reutilizar `DeletePublicImageUseCase`)
- Bucket `amg-public-image` creado en Supabase Storage (configuración manual)

---

## Contexto / Notas

- Actualmente, el componente `LogoSection` solo muestra botones pero no tiene funcionalidad implementada:
  - El botón "SUBIR NUEVO" no hace nada ❌
  - El botón "ELIMINAR" no hace nada ❌
  - El logo se muestra pero no se puede actualizar desde la UI ❌
- El `UpdateFoundationProfileUseCase` solo actualiza el `logo_url` en la BD, pero:
  - No acepta archivos (`File` objects) ❌
  - No sube imágenes a Supabase Storage ❌
  - No elimina imágenes anteriores cuando se reemplaza ❌
- Esta HU implementa:
  - Funcionalidad completa de upload del logo usando `UploadPublicImageUseCase`
  - Funcionalidad de eliminación del logo usando `DeletePublicImageUseCase`
  - Eliminación automática de la imagen anterior cuando se sube una nueva
  - Actualización del `logo_url` en la tabla `foundations`
- **Solo para logos de fundaciones** almacenados en `amg-public-image/foundations/{foundationId}/`
- **NO incluye**:
  - Eliminación de imágenes de animales, productos o eventos
  - Limpieza masiva de archivos huérfanos existentes
  - Validación de dimensiones específicas (solo formato y tamaño)

---

## Diseño (OBLIGATORIO si hay UI)

Referencias:
- Diseño: `docs/design/code_profile_foundation_screen.html`
- Imagen: `docs/design/profile_foundation_screen.png`
- Componente existente: `src/presentation/components/profile/LogoSection.tsx`

Reglas:
- El componente debe mostrar el logo actual si existe
- El botón "SUBIR NUEVO" debe abrir un selector de archivos
- El botón "ELIMINAR" debe eliminar el logo actual (con confirmación opcional)
- Mostrar preview del logo seleccionado antes de guardar
- Validar formato (JPG, PNG) y tamaño (máx. 5MB)
- Mostrar estados de carga durante el upload
- Manejar errores de forma amigable

---

## Reglas técnicas

- Arquitectura: ver `docs/01_arquitectura.md`
- Reglas Codex: ver `docs/02_reglas_de_codex.md`

## Alcance

Incluye:
- Implementar funcionalidad en `LogoSection` para:
  - Seleccionar y subir archivo de logo
  - Mostrar preview del logo actual y del nuevo logo seleccionado
  - Eliminar el logo actual
- Modificar `UpdateFoundationProfileUseCase` para:
  - Aceptar `logoFile?: File | null` además de `logoUrl`
  - Subir el logo a Supabase Storage usando `UploadPublicImageUseCase`
  - Obtener el logo actual antes de actualizar
  - Eliminar el logo anterior del storage cuando se sube uno nuevo
  - Eliminar el logo del storage cuando se elimina (logoUrl = null)
- Actualizar `ProfileForm` para:
  - Manejar el estado del logo (File o URL)
  - Pasar el `logoFile` al use case
  - Sincronizar el estado después de actualizar
- Validación de archivo (formato JPG/PNG, tamaño máx. 5MB)
- Manejo de errores al eliminar (no bloquear la operación principal si falla)

No incluye:
- Eliminación de imágenes de animales, productos o eventos
- Limpieza masiva de archivos huérfanos existentes
- Validación de dimensiones específicas (ej: exactamente 400x400px)
- Sistema de soft-delete o recuperación de logos eliminados
- Confirmación adicional en la UI (opcional, puede agregarse)

---

## Criterios de aceptación (Given / When / Then)

### 1) Upload de logo implementado

- **Dado** que un usuario está en el perfil de fundación
- **Cuando** hace clic en "SUBIR NUEVO" y selecciona un archivo
- **Entonces** se valida el formato (JPG, PNG) y tamaño (máx. 5MB)
- **Y** se muestra un preview del logo seleccionado
- **Y** al guardar el formulario, se sube el logo a Supabase Storage usando `UploadPublicImageUseCase`
- **Y** se actualiza el `logo_url` en la tabla `foundations`
- **Y** si hay un logo anterior, se elimina del storage antes de subir el nuevo

### 2) Eliminación de logo implementada

- **Dado** que un usuario tiene un logo en su perfil de fundación
- **Cuando** hace clic en "ELIMINAR"
- **Entonces** se elimina el logo del storage usando `DeletePublicImageUseCase`
- **Y** se actualiza el `logo_url` a `null` en la tabla `foundations`
- **Y** el logo desaparece de la UI
- **Y** si falla la eliminación del storage, se registra el error pero se actualiza la BD

### 3) Eliminación automática de logo anterior

- **Dado** que un usuario tiene un logo actual en su perfil
- **Cuando** sube un nuevo logo
- **Entonces** se obtiene el logo actual antes de subir el nuevo
- **Y** se elimina el logo anterior del storage usando `DeletePublicImageUseCase`
- **Y** se sube el nuevo logo al storage
- **Y** se actualiza el `logo_url` en la BD con la nueva URL
- **Y** si falla la eliminación del logo anterior, se registra el error pero se continúa con el upload

### 4) Validación de archivo

- **Dado** que un usuario intenta subir un logo
- **Cuando** el archivo no cumple con los requisitos
- **Entonces** se valida que:
  - El formato es JPG o PNG
  - El tamaño no excede 5MB
  - El archivo es realmente una imagen (validar MIME type)
- **Y** se muestra un mensaje de error descriptivo si la validación falla
- **Y** no se intenta subir el archivo si la validación falla

### 5) Manejo de errores

- **Dado** que se intenta subir o eliminar un logo
- **Cuando** ocurre un error (storage no disponible, sin permisos, etc.)
- **Entonces** el error se registra pero no se propaga como excepción crítica (si es posible)
- **Y** se muestra un mensaje de error amigable al usuario
- **Y** la operación principal (actualizar perfil) puede continuar si el error no es crítico

### 6) Preview del logo

- **Dado** que un usuario selecciona un nuevo logo
- **Cuando** el archivo es válido
- **Entonces** se muestra un preview del logo seleccionado antes de guardar
- **Y** se muestra el logo actual si existe
- **Y** el preview se actualiza cuando se selecciona un nuevo archivo

---

## Reglas técnicas

### Arquitectura
- Presentation solo consume UseCases vía IoC (no importa repositorios concretos).
- Domain no importa React/Next/MUI/Tailwind/Inversify/Supabase.
- Infrastructure contiene implementaciones y wiring IoC.
- Reutilizar `UploadPublicImageUseCase` y `DeletePublicImageUseCase` creados en HUs anteriores.

### Estructura de actualización en UpdateFoundationProfileUseCase

```typescript
// domain/usecases/foundation/UpdateFoundationProfileUseCase.ts
import { UploadPublicImageUseCase } from "@/domain/usecases/storage/UploadPublicImageUseCase";
import { DeletePublicImageUseCase } from "@/domain/usecases/storage/DeletePublicImageUseCase";

class UpdateFoundationProfileUseCase {
  constructor(
    private readonly foundationProfileRepository: IFoundationProfileRepository,
    private readonly uploadPublicImageUseCase: UploadPublicImageUseCase,
    private readonly deletePublicImageUseCase: DeletePublicImageUseCase,
  ) {}
  
  async execute(profile: FoundationProfile & { logoFile?: File | null }): Promise<FoundationProfile> {
    // Obtener perfil actual ANTES de hacer cambios
    const currentProfile = await this.foundationProfileRepository.getFoundationProfile();
    const currentLogoUrl = currentProfile.logoUrl;
    
    let resolvedLogoUrl: string | null = profile.logoUrl;
    
    // Si se está eliminando el logo (logoUrl es null y hay un logo actual)
    if (profile.logoUrl === null && currentLogoUrl) {
      // Eliminar logo actual del storage
      await this.deletePublicImageUseCase.execute({ url: currentLogoUrl })
        .catch(error => {
          console.error('Error deleting foundation logo from storage:', error);
        });
      resolvedLogoUrl = null;
    }
    // Si se está subiendo un nuevo logo (hay logoFile)
    else if (profile.logoFile) {
      // Eliminar logo anterior si existe
      if (currentLogoUrl) {
        await this.deletePublicImageUseCase.execute({ url: currentLogoUrl })
          .catch(error => {
            console.error('Error deleting old foundation logo from storage:', error);
          });
      }
      
      // Subir nuevo logo
      resolvedLogoUrl = await this.uploadPublicImageUseCase.execute({
        file: profile.logoFile,
        type: "foundation",
        foundationId: profile.foundationId,
        entityId: undefined, // Los logos no tienen entityId
      });
    }
    // Si solo se está actualizando logoUrl (sin archivo nuevo)
    else {
      resolvedLogoUrl = profile.logoUrl;
    }
    
    // Actualizar perfil con el logo resuelto
    const updatedProfile: FoundationProfile = {
      ...profile,
      logoUrl: resolvedLogoUrl,
    };
    
    return await this.foundationProfileRepository.updateFoundationProfile(updatedProfile);
  }
}
```

### Actualización de LogoSection

```typescript
// src/presentation/components/profile/LogoSection.tsx
'use client';

import { Avatar, Button, Typography, CircularProgress } from '@mui/material';
import { useTranslations } from 'next-intl';
import { useRef, useState, useEffect } from 'react';

interface LogoSectionProps {
  currentLogoUrl: string | null;
  onLogoSelect: (file: File | null) => void;
  onLogoRemove: () => void;
  isUploading?: boolean;
}

const LogoSection = ({ currentLogoUrl, onLogoSelect, onLogoRemove, isUploading = false }: LogoSectionProps) => {
  const t = useTranslations('profile');
  const fileInputRef = useRef<HTMLInputElement>(null);
  const [previewUrl, setPreviewUrl] = useState<string | null>(currentLogoUrl);

  useEffect(() => {
    setPreviewUrl(currentLogoUrl);
  }, [currentLogoUrl]);

  const handleFileSelect = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0] ?? null;
    if (!file) return;

    // Validar formato
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png'];
    if (!validTypes.includes(file.type)) {
      // Mostrar error
      return;
    }

    // Validar tamaño (5MB)
    const maxSize = 5 * 1024 * 1024;
    if (file.size > maxSize) {
      // Mostrar error
      return;
    }

    // Crear preview
    const objectUrl = URL.createObjectURL(file);
    setPreviewUrl(objectUrl);

    // Notificar al componente padre
    onLogoSelect(file);
  };

  const handleRemove = () => {
    setPreviewUrl(null);
    onLogoRemove();
  };

  return (
    <section className="flex flex-col gap-4 rounded-xl border border-neutral-200 bg-white p-6">
      <div className="flex items-center justify-between">
        <Typography variant="h6" className="text-neutral-900">
          {t('logo.title')}
        </Typography>
      </div>
      <div className="flex flex-col items-start gap-4 md:flex-row md:items-center">
        <Avatar
          variant="rounded"
          src={previewUrl ?? undefined}
          className="h-24 w-24 bg-neutral-100 text-neutral-400"
          alt={t('logo.title')}
        />
        <div className="flex flex-wrap items-center gap-3">
          <input
            ref={fileInputRef}
            type="file"
            accept="image/jpeg,image/jpg,image/png"
            className="hidden"
            onChange={handleFileSelect}
            disabled={isUploading}
          />
          <Button
            variant="contained"
            className="bg-brand-500 text-white hover:bg-brand-600"
            onClick={() => fileInputRef.current?.click()}
            disabled={isUploading}
            startIcon={isUploading ? <CircularProgress size={16} /> : null}
          >
            {t('logo.upload')}
          </Button>
          <Button
            variant="outlined"
            className="border-neutral-300 text-neutral-700 hover:border-neutral-400"
            onClick={handleRemove}
            disabled={!currentLogoUrl || isUploading}
          >
            {t('logo.remove')}
          </Button>
        </div>
      </div>
      <Typography variant="body2" className="text-neutral-500">
        {t('logo.help')}
      </Typography>
    </section>
  );
};

export default LogoSection;
```

### Actualización de ProfileForm

```typescript
// src/presentation/components/profile/ProfileForm.tsx
// Agregar estado para logoFile
const [logoFile, setLogoFile] = useState<File | null>(null);
const [isUploadingLogo, setIsUploadingLogo] = useState(false);

// En el onSubmit
const payload: FoundationProfile & { logoFile?: File | null } = {
  foundationId: profileMeta.foundationId,
  logoUrl: logoFile === null && !profileMeta.logoUrl ? null : profileMeta.logoUrl, // null si se eliminó, mantener actual si no hay cambio
  logoFile: logoFile,
  ...values,
};

// Actualizar LogoSection para pasar props
<LogoSection
  currentLogoUrl={profileMeta.logoUrl}
  onLogoSelect={(file) => setLogoFile(file)}
  onLogoRemove={() => {
    setLogoFile(null);
    // Marcar para eliminar
    setProfileMeta({ ...profileMeta, logoUrl: null });
  }}
  isUploading={formik.isSubmitting || isUploadingLogo}
/>
```

### Traducciones (OBLIGATORIO si hay UI con texto)

- Las traducciones ya existen en `profile.json`:
  - `logo.title`: "Logo de la Fundación"
  - `logo.upload`: "SUBIR NUEVO"
  - `logo.remove`: "ELIMINAR"
  - `logo.help`: "Tamaño recomendado 400x400px. Formatos soportados: JPG, PNG."
- Agregar keys adicionales si es necesario:
  - `logo.errors.invalidFormat`: "Formato no válido. Solo se permiten JPG y PNG."
  - `logo.errors.tooLarge`: "El archivo es demasiado grande. Tamaño máximo: 5MB."
  - `logo.errors.uploadFailed`: "Error al subir el logo. Por favor, intenta de nuevo."

---

## Implementación sugerida

### 1. Modificar UpdateFoundationProfileUseCase

Ver código en sección "Estructura de actualización" arriba.

### 2. Actualizar LogoSection

Ver código en sección "Actualización de LogoSection" arriba.

### 3. Actualizar ProfileForm

- Agregar estado `logoFile` y `isUploadingLogo`
- Pasar props a `LogoSection`
- Incluir `logoFile` en el payload al actualizar

### 4. Registrar UseCases en IoC (si no están ya registrados)

- Verificar que `UploadPublicImageUseCase` y `DeletePublicImageUseCase` estén registrados
- Si no están, agregarlos en `usecases.types.ts` y `usecases.container.ts`

### 5. Agregar traducciones adicionales (si es necesario)

```json
// src/messages/es/profile.json
{
  "logo": {
    "title": "Logo de la Fundación",
    "upload": "SUBIR NUEVO",
    "remove": "ELIMINAR",
    "help": "Tamaño recomendado 400x400px. Formatos soportados: JPG, PNG.",
    "errors": {
      "invalidFormat": "Formato no válido. Solo se permiten JPG y PNG.",
      "tooLarge": "El archivo es demasiado grande. Tamaño máximo: 5MB.",
      "uploadFailed": "Error al subir el logo. Por favor, intenta de nuevo."
    }
  }
}
```

---

## Validación

Comandos mínimos:
- `npm run dev` (verificar que el upload y eliminación funcionan)
- `npm run build` (verificar que no hay errores de compilación)

Pruebas manuales:
1. Ir al perfil de fundación
2. Hacer clic en "SUBIR NUEVO" y seleccionar un logo
3. Verificar que se muestra el preview
4. Guardar el formulario
5. Verificar en Supabase Dashboard > Storage que el logo se subió a `foundations/{foundationId}/`
6. Verificar que la URL se actualizó en la tabla `foundations`
7. Subir un nuevo logo reemplazando el anterior
8. Verificar que el logo anterior se eliminó del storage
9. Hacer clic en "ELIMINAR"
10. Verificar que el logo se eliminó del storage
11. Verificar que `logo_url` se actualizó a `null` en la BD

---

## Definición de Hecho

- [ ] Criterios de aceptación cumplidos
- [ ] `npm run dev` OK
- [ ] `npm run build` OK
- [ ] Sin violaciones de capas
- [ ] Sin cambios fuera del alcance
- [ ] Reutiliza `UploadPublicImageUseCase` y `DeletePublicImageUseCase` (no duplicar código)
- [ ] **Traducciones incluidas**:
  - [ ] Textos agregados en `src/messages/es/profile.json` (si se agregaron nuevas keys)
  - [ ] Textos agregados en `src/messages/en/profile.json` (si se agregaron nuevas keys)
- [ ] Pruebas manuales realizadas:
  - [ ] Upload de logo funciona correctamente
  - [ ] El logo se sube al storage
  - [ ] La URL se actualiza en la BD
  - [ ] Eliminación de logo funciona
  - [ ] El logo se elimina del storage
  - [ ] Eliminación automática de logo anterior al subir uno nuevo
  - [ ] Los errores se manejan sin bloquear la operación
- Commit sugerido:
  `feat: implementar carga y eliminación de logo de fundación (HU-047)`
