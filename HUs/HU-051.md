# HU-051 — Login dual para adoptantes y fundaciones con redirecciones corregidas

**Como** usuario (adoptante o fundación)  
**Quiero** tener un login que funcione para ambos tipos de usuarios con redirecciones correctas  
**Para** poder iniciar sesión correctamente y ser dirigido a la página adecuada según mi rol

---

## Dependencias

- HU-001 (Next.js App Router)
- HU-011 (Conexión a Supabase configurada)
- HU-013 (Estrategia de roles y protección de rutas definida)
- HU-016 (Sistema de traducciones configurado)
- HU-020 (Login con Supabase implementado)
- **HU-050 (Pantalla intermedia de selección de tipo de registro)** - **OBLIGATORIA**

**Conexión con HU-050:**
- Esta HU (HU-051) actualiza el login para que todos los enlaces de registro apunten a `/register`.
- HU-050 crea la pantalla de selección en `/register` que recibe a los usuarios desde el login.
- **Flujo completo:** Login (esta HU) → Pantalla de selección (HU-050) → Formulario de registro correspondiente.
- **Importante:** HU-050 debe implementarse antes o junto con HU-051 para que el flujo funcione correctamente.

---

## Contexto / Notas

- **Problema actual:**
  - El login redirige a usuarios externos a `/external` que no existe → debe redirigir a `/` (home)
  - El login actual solo menciona fundaciones, pero debe funcionar para ambos tipos de usuarios
  - Los enlaces de registro en el login apuntan directamente a formularios, pero deben apuntar a `/register` (pantalla de selección creada en **HU-050**)
- **Conexión con HU-050:**
  - Esta HU actualiza el login para que todos los enlaces de registro apunten a `/register`.
  - HU-050 crea la pantalla de selección en `/register` que recibe a los usuarios desde el login.
  - Los usuarios hacen clic en "Create an account" o "Register your foundation" en el login → van a `/register` (HU-050) → seleccionan su tipo → van al formulario correspondiente.
- **Solución:**
  - Corregir la función `getRedirectTarget` en `LoginForm.tsx` para que usuarios externos vayan a `/` en lugar de `/external`
  - Agregar selector de tipo de usuario (adopter/foundation) con radio buttons en el login
  - El subtítulo y el enlace de registro deben cambiar dinámicamente según el tipo seleccionado
  - Ambos enlaces de registro deben apuntar a `/register` (pantalla de selección)
  - Actualizar el header del login para que el botón "Get Started" apunte a `/register`
- El diseño está disponible en `docs/design/new_login_screen_code.html` y `docs/design/new_login_screen.png`.
- El login debe seguir siendo funcional para ambos tipos de usuarios sin importar qué opción esté seleccionada (el selector es solo visual/UX).

---

## Diseño (OBLIGATORIO si hay UI)

Referencias:
- Diseño: `docs/design/new_login_screen.png`
- Código HTML: `docs/design/new_login_screen_code.html`
- Design System: `docs/design/system.md`

Reglas:
- Respetar jerarquía visual del diseño.
- Usar tokens definidos en el Design System (no inventar tamaños/colores).
- **Selector de tipo de usuario:**
  - Dos radio buttons ocultos: `adopter` (por defecto) y `foundation`
  - Dos labels visibles que actúan como botones: "I am an Adopter/Sponsor" y "I am a Foundation"
  - El label seleccionado debe tener estilo activo (fondo blanco, sombra, texto más oscuro)
  - El label no seleccionado debe tener estilo inactivo (fondo transparente, texto más claro)
  - Usar CSS para cambiar estilos según el radio button seleccionado
- **Subtítulo dinámico:**
  - Cuando `adopter` está seleccionado: "Find your next best friend and manage your sponsorships."
  - Cuando `foundation` está seleccionado: "Manage your foundation's adoptions and animal profiles."
  - Usar CSS para mostrar/ocultar según el radio button seleccionado
- **Enlace de registro dinámico:**
  - Cuando `adopter` está seleccionado: "Want to help or adopt? **Create an account**"
  - Cuando `foundation` está seleccionado: "Representing a shelter? **Register your foundation**"
  - **Ambos enlaces deben apuntar a `/register`** (pantalla de selección creada en **HU-050**)
  - Desde `/register`, el usuario selecciona su tipo y es redirigido al formulario correspondiente
  - Usar CSS para mostrar/ocultar según el radio button seleccionado
- **Header del login:**
  - El botón "Get Started" debe apuntar a `/register` (pantalla de selección de **HU-050**)
  - Actualizar el texto si es necesario para que sea más genérico
- El formulario de login (email, password) permanece igual para ambos tipos.
- El botón "Log In" funciona igual para ambos tipos (el selector es solo visual).

---

## Alcance

Incluye:
- Corregir `getRedirectTarget` en `LoginForm.tsx`:
  - Usuario `external` → redirigir a `/${locale}` (home) en lugar de `/${locale}/external`
  - Usuario `foundation_user` → mantener redirección a `/${locale}/foundations`
  - Usuario `admin` → mantener redirección a `/${locale}/admin`
- Agregar selector de tipo de usuario en `LoginForm.tsx`:
  - Dos radio buttons ocultos: `adopter` (checked por defecto) y `foundation`
  - Dos labels visibles que actúan como botones
  - Estilos CSS para mostrar el estado activo/inactivo
- Hacer dinámico el subtítulo en `LoginForm.tsx`:
  - Cambiar según el radio button seleccionado
  - Usar CSS para mostrar/ocultar los textos
- Hacer dinámico el enlace de registro en `LoginForm.tsx`:
  - Cambiar según el radio button seleccionado
  - **Ambos enlaces apuntan a `/register`** (pantalla de selección de HU-050)
  - Usar CSS para mostrar/ocultar los enlaces
- Actualizar `LoginHeader.tsx`:
  - El botón "Get Started" o "Register your foundation" debe apuntar a `/register` (pantalla de selección de HU-050)
  - Actualizar el texto del botón si es necesario
- Agregar traducciones para los nuevos textos:
  - Subtítulos para adoptante y fundación
  - Enlaces de registro para adoptante y fundación
  - Labels del selector

No incluye:
- Modificar la lógica de autenticación (el login funciona igual para ambos tipos)
- Crear nuevas rutas o páginas
- Modificar el flujo de registro (solo actualizar enlaces)

---

## Reglas técnicas

### Arquitectura
- Presentation solo consume UseCases vía IoC (no importa repositorios concretos).
- Domain no importa React/Next/MUI/Tailwind/Inversify/Supabase.
- Infrastructure contiene implementaciones y wiring IoC.
- **Supabase solo vive en Infrastructure**: servicios y repositorios.

### Redirecciones después del login
```typescript
// Función getRedirectTarget corregida
const getRedirectTarget = (role: UserRole) => {
  const redirectTo = searchParams.get("redirectTo");
  
  if (redirectTo) {
    const normalized = normalizeRedirectPath(redirectTo, locale);
    if (normalized) {
      return normalized;
    }
  }

  if (role === "foundation_user") {
    return `/${locale}/foundations`; // Dashboard de fundaciones
  }

  if (role === "admin") {
    return `/${locale}/admin`; // Dashboard de admin
  }

  if (role === "external") {
    return `/${locale}`; // Home (corregido: antes era /external)
  }

  return `/${locale}`; // Home por defecto
};
```

### Selector de tipo de usuario
- Usar radio buttons HTML nativos con CSS para el estilo.
- El selector es **puramente visual/UX** - no afecta la lógica de autenticación.
- El login funciona igual sin importar qué opción esté seleccionada.
- Usar estado local de React para manejar qué radio está seleccionado.

### CSS para mostrar/ocultar contenido
```css
/* Ejemplo basado en el diseño HTML */
#foundation:checked ~ div label[for="foundation"] {
  @apply bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm;
}

#adopter:checked ~ div label[for="adopter"] {
  @apply bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm;
}

#foundation:checked ~ form .foundation-content { display: block; }
#foundation:checked ~ form .adopter-content { display: none; }
#adopter:checked ~ form .foundation-content { display: none; }
#adopter:checked ~ form .adopter-content { display: block; }
```

### Traducciones (OBLIGATORIO si hay UI con texto)
- **TODOS los textos visibles en la UI deben estar traducidos** (español e inglés).
- Usar el sistema de traducciones configurado en HU-016 (`next-intl`).
- Agregar traducciones en:
  - `src/messages/es/login.json` (español)
  - `src/messages/en/login.json` (inglés)
- Keys sugeridas:
  - `form.userType.adopter` → "I am an Adopter/Sponsor"
  - `form.userType.foundation` → "I am a Foundation"
  - `form.subtitle.adopter` → "Find your next best friend and manage your sponsorships."
  - `form.subtitle.foundation` → "Manage your foundation's adoptions and animal profiles."
  - `form.register.adopter.text` → "Want to help or adopt?"
  - `form.register.adopter.link` → "Create an account"
  - `form.register.foundation.text` → "Representing a shelter?"
  - `form.register.foundation.link` → "Register your foundation"
  - `header.getStarted` → "Get Started" (o mantener "Register your foundation" si se prefiere)

### Componentes a modificar
1. **`src/presentation/components/login/LoginForm.tsx`**:
   - Corregir función `getRedirectTarget` (línea 83-106)
   - Agregar selector de tipo de usuario (radio buttons + labels)
   - Hacer dinámico el subtítulo
   - Hacer dinámico el enlace de registro
   - Agregar estilos CSS para el selector
2. **`src/presentation/components/login/LoginHeader.tsx`**:
   - Actualizar el botón "Get Started" para que apunte a `/register`
   - Actualizar el texto del botón si es necesario

---

## Criterios de aceptación

- [ ] Usuarios externos son redirigidos a `/` (home) después del login exitoso
- [ ] Usuarios de fundación son redirigidos a `/foundations` (dashboard) después del login exitoso
- [ ] Usuarios admin son redirigidos a `/admin` después del login exitoso
- [ ] El selector de tipo de usuario funciona correctamente (radio buttons + labels)
- [ ] El subtítulo cambia dinámicamente según el tipo seleccionado
- [ ] El enlace de registro cambia dinámicamente según el tipo seleccionado
- [ ] Ambos enlaces de registro apuntan a `/register` (pantalla de selección)
- [ ] El botón "Get Started" en el header apunta a `/register`
- [ ] El login funciona correctamente para ambos tipos de usuarios (sin importar qué opción esté seleccionada)
- [ ] Todos los textos están traducidos (español e inglés)
- [ ] Los estilos del selector coinciden con el diseño (estado activo/inactivo)
- [ ] El diseño es responsive (desktop y mobile)

---

## Notas de implementación

- **Importante**: El selector de tipo de usuario es **puramente visual/UX**. No afecta la lógica de autenticación. El login funciona igual sin importar qué opción esté seleccionada.
- **Conexión con HU-050**: Esta HU actualiza el login para que todos los enlaces apunten a `/register`. HU-050 debe estar implementada para que el flujo funcione correctamente. El flujo completo es:
  1. Usuario hace clic en enlace de registro en el login (esta HU)
  2. Usuario es redirigido a `/register` (HU-050 - pantalla de selección)
  3. Usuario selecciona su tipo (adoptante o fundación)
  4. Usuario es redirigido al formulario correspondiente (`/register/external` o `/register/foundation`)
- La corrección de redirección es crítica: usuarios externos no deben ir a `/external` (que no existe).
- Considerar usar `useState` para manejar el estado del selector si se necesita lógica adicional.
- Mantener la consistencia visual con el resto de la aplicación (colores, tipografía, espaciado).
- El diseño HTML proporcionado usa Tailwind CSS, pero el proyecto usa MUI. Adaptar los estilos a MUI manteniendo la apariencia del diseño.
