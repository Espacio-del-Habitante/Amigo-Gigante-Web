# HU-013 — Estrategia de roles y protección de rutas

**Como** desarrollador  
**Quiero** definir la estrategia para validar roles y proteger rutas  
**Para** tener una arquitectura clara de autenticación y autorización

---

## Dependencias

- HU-011 (Conexión a Supabase configurada)

---

## Contexto / Notas

- Esta HU define la **estrategia y arquitectura** para roles y protección de rutas.
- No implementa funcionalidad completa, solo la estructura y plan.
- Los roles se implementan a nivel **soft**: solo verificación básica, sin lógica compleja de permisos.
- Roles definidos: `'admin'`, `'foundation_user'`, `'external'` (según esquema BD).docs/scripts/db.sql
- Se debe definir cómo se verifica la sesión de Supabase y cómo se obtiene el rol del usuario.
- Se debe definir la estrategia para proteger rutas en Next.js App Router.

---

## Alcance

Incluye:
- Definir estructura para verificar autenticación (sesión de Supabase)
- Definir estructura para obtener y verificar roles del usuario
- Definir estrategia de middleware para Next.js App Router
- Crear tipos/interfaces para roles y autenticación
- Crear hooks/utilities básicos para verificar auth y roles
- Documentar la estrategia de protección de rutas
- Crear estructura base (sin implementación completa)

No incluye:
- Implementación completa del middleware
- Implementación de lógica de registro
- Validación de formularios
- Conexión real con Supabase para registro
- Sistema completo de permisos granular
- Lógica compleja de roles

---

## Criterios de aceptación (Given / When / Then)

### 1) Tipos e interfaces definidos

- **Dado** que se necesita trabajar con roles y autenticación
- **Cuando** se define la estructura
- **Entonces** existen tipos/interfaces para:
  - `UserRole` (tipo: `'admin' | 'foundation_user' | 'external'`)
  - `AuthUser` (interfaz con id, email, role)
  - `AuthSession` (interfaz para sesión)
- **Y** están en `domain/models/` o `domain/types/`

---

### 2) Hook de autenticación definido

- **Dado** que se necesita verificar autenticación
- **Cuando** se crea la estructura
- **Entonces** existe un hook `useAuth` (o similar) en `presentation/hooks/`
- **Y** el hook expone:
  - `user`: usuario actual o null
  - `isAuthenticated`: boolean
  - `role`: rol del usuario o null
  - `loading`: estado de carga
- **Y** está documentado cómo se obtiene la sesión de Supabase

---

### 3) Utilidades de verificación de roles

- **Dado** que se necesita verificar roles
- **Cuando** se crea la estructura
- **Entonces** existen funciones utilitarias para:
  - Verificar si un usuario tiene un rol específico
  - Verificar si un usuario tiene alguno de varios roles
  - Obtener el rol del usuario desde la sesión
- **Y** están en `presentation/utils/` o similar

---

### 4) Estrategia de middleware documentada

- **Dado** que se necesita proteger rutas
- **Cuando** se define la estrategia
- **Entonces** existe documentación que explica:
  - Cómo funciona el middleware de Next.js App Router
  - Dónde se ubicará el middleware (`middleware.ts` en raíz)
  - Cómo verificar la sesión en el middleware
  - Cómo redirigir según autenticación/rol
- **Y** la documentación está en `docs/` o como comentarios

---

### 5) Estructura base de middleware creada

- **Dado** que se necesita proteger rutas
- **Cuando** se crea la estructura
- **Entonces** existe un archivo `middleware.ts` (o estructura base)
- **Y** el middleware tiene:
  - Configuración de rutas protegidas
  - Lógica base para verificar sesión (comentada o con TODO)
  - Lógica base para redirigir (comentada o con TODO)
- **Nota**: No necesita estar completamente funcional, solo la estructura

---

### 6) Estrategia de protección por roles documentada

- **Dado** que existen diferentes roles
- **Cuando** se define la estrategia
- **Entonces** existe documentación que explica:
  - Cómo proteger rutas según rol específico
  - Cómo redirigir según el rol del usuario
  - Ejemplos de rutas protegidas por rol
- **Y** la estrategia es clara y simple (soft, sin lógica compleja)

---

## Reglas técnicas

### Arquitectura
- Presentation solo consume UseCases vía IoC (no importa repositorios concretos).
- Domain no importa React/Next/MUI/Tailwind/Inversify/Supabase.
- Infrastructure contiene implementaciones y wiring IoC.
- **Supabase solo vive en Infrastructure**: servicios y repositorios.

### Flujo de registro
1. Validar datos del formulario (Presentation)
2. Llamar a `RegisterFoundationUseCase` (Presentation)
3. UseCase llama a `AuthRepository.signUp()` (Domain → Infrastructure)
4. UseCase llama a `FoundationRepository.createFoundation()` (Domain → Infrastructure)
5. UseCase crea perfil, contacto y miembro (Domain → Infrastructure)
6. Retornar éxito y redirigir (Presentation)

### Protección de rutas
- En Next.js App Router, usar middleware en `middleware.ts` (raíz del proyecto).
- El middleware verifica la sesión de Supabase.
- Redirige a `/login` si no hay sesión.
- Opcional: crear HOC `withAuth` para componentes si se prefiere.

### Roles
- Roles definidos: `'admin'`, `'foundation_user'`, `'external'`.
- Por defecto, usuarios registrados tienen `'foundation_user'`.
- Verificación básica: solo chequear el campo `role` en `profiles`.
- No implementar lógica compleja de permisos (se hará en otra HU).

### Dependencias / Paquetes
- No agregar dependencias nuevas salvo que esta HU lo indique explícitamente.
- Si aparece error 403/conectividad:
  1) Detenerse
  2) Pedir dominios requeridos
  3) Explicar por qué se requieren
  4) No continuar

---

## Implementación sugerida

### Estructura de archivos sugerida:

```
src/domain/
├── types/
│   └── auth.types.ts          # UserRole, AuthUser, AuthSession
└── models/
    └── AuthUser.ts            # Modelo de usuario autenticado (opcional)

src/presentation/
├── hooks/
│   └── useAuth.ts             # Hook para obtener sesión y usuario
└── utils/
    └── roleUtils.ts           # Utilidades para verificar roles

middleware.ts                   # Middleware base (raíz del proyecto)

docs/
└── auth-strategy.md           # Documentación de la estrategia
```

### Flujo de implementación:

1. **Definir tipos**:
   - `UserRole`: tipo union de roles
   - `AuthUser`: interfaz con id, email, role
   - `AuthSession`: interfaz para sesión

2. **Crear hook useAuth**:
   - Obtener sesión de Supabase
   - Obtener usuario y rol
   - Estados: loading, isAuthenticated, user, role

3. **Crear utilidades de roles**:
   - `hasRole(user, role): boolean`
   - `hasAnyRole(user, roles): boolean`
   - `getUserRole(session): UserRole | null`

4. **Documentar estrategia de middleware**:
   - Cómo verificar sesión en middleware
   - Cómo proteger rutas
   - Cómo redirigir según auth/rol

5. **Crear estructura base de middleware**:
   - Archivo `middleware.ts` con estructura base
   - Configuración de rutas protegidas
   - Lógica comentada o con TODOs

### Notas importantes:
- Esta HU es solo estrategia/estructura, no implementación completa.
- El middleware puede tener TODOs o lógica comentada.
- La documentación debe ser clara para las siguientes HUs.
- Los tipos deben estar bien definidos para usar en HU-014 y HU-015.

---

## Validación

Comandos mínimos:
- `npm run dev` (verificar que no hay errores de compilación)
- `npm run build` (verificar que no hay errores de compilación)

Verificaciones:
- Los tipos están definidos y son correctos
- El hook useAuth tiene la estructura correcta (puede tener TODOs)
- Las utilidades de roles están definidas
- La documentación de estrategia está clara
- El middleware tiene estructura base (puede tener TODOs)

---

## Definición de Hecho

- [ ] Criterios de aceptación cumplidos
- [ ] `npm run dev` OK
- [ ] `npm run build` OK
- [ ] Tipos e interfaces definidos
- [ ] Hook useAuth con estructura definida
- [ ] Utilidades de roles creadas
- [ ] Estrategia de middleware documentada
- [ ] Estructura base de middleware creada
- [ ] Estrategia de protección por roles documentada
- [ ] Sin violaciones de capas
- [ ] Sin cambios fuera del alcance
- Commit sugerido:
  `feat: define auth and role protection strategy`

