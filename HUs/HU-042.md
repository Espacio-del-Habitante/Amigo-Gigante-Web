# HU-042 — Menú de cuenta y cierre de sesión para foundation_user

**Como** usuario foundation_user autenticado  
**Quiero** hacer clic en mi nombre o avatar en el header del dashboard  
**Para** ver un menú desplegable con opciones de cuenta como cerrar sesión

---

## Dependencias

- HU-001 (Next.js App Router)
- HU-013 (Estrategia de roles y protección de rutas definida)
- HU-016 (Sistema de traducciones configurado)
- HU-020 (Login implementado)
- HU-025 (Dashboard implementado)
- Hook `useAuth` configurado y funcionando
- Componente `FoundationHeader` existente

---

## Contexto / Notas

- Esta HU modifica el `FoundationHeader` para agregar un menú desplegable cuando el usuario hace clic en el nombre o avatar.
- El menú debe ser pequeño y discreto, mostrando opciones básicas:
  - Cerrar sesión
  - Editar perfil (navegar a página de edición, será otra HU)
- El menú debe abrirse al hacer clic en el nombre o avatar del usuario.
- El menú debe cerrarse al hacer clic fuera o al seleccionar una opción.
- El comportamiento debe ser similar a HU-041 pero adaptado para `foundation_user` en el dashboard.
- La opción "Editar perfil" será implementada en otra HU, pero debe estar presente en el menú.
- Después del logout, el usuario debe ser redirigido a home (`/` o `/[locale]`).

---

## Diseño (OBLIGATORIO si hay UI)

Referencias:
- Diseño: `docs/design/system.md`
- Componente existente: `src/presentation/components/layouts/FoundationLayout/FoundationHeader.tsx`
- Diseño dashboard: `docs/design/dashboard_code.html`

Reglas:
- El menú desplegable debe ser discreto y pequeño (no ocupar mucho espacio).
- El menú debe usar componentes de MUI (Menu, MenuItem, Divider).
- El menú debe mostrar:
  - Email del usuario (opcional, como información)
  - Divider
  - "Editar perfil" (navegar a página de edición)
  - "Cerrar sesión" (cerrar sesión y redirigir a home)
- El menú debe tener animación suave al abrir/cerrar.
- El nombre y avatar deben ser clickeables y mostrar un cursor pointer al hover.
- El menú debe posicionarse correctamente debajo del nombre/avatar.

---

## Reglas técnicas

- Arquitectura: ver `docs/01_arquitectura.md`
- Reglas Codex: ver `docs/02_reglas_de_codex.md`

## Alcance

Incluye:
- Modificar `FoundationHeader` para hacer clickeable el nombre y avatar
- Crear componente de menú desplegable (usando MUI Menu)
- Crear UseCase de logout (`LogoutUseCase`)
- Agregar método `signOut()` al `IAuthRepository` e implementación
- Implementar opción "Cerrar sesión" (llamar a UseCase de logout)
- Implementar opción "Editar perfil" (navegar a página de edición, será otra HU)
- Mostrar email del usuario en el menú (opcional)
- Manejar estado de apertura/cierre del menú
- Redirigir a home después del logout
- Actualizar hook `useAuth` para exponer método de logout (opcional)

No incluye:
- Implementación de la página de edición de perfil (otra HU)
- Cambios en otros headers (HomeNavBar, LoginHeader, etc.)
- Cambios en el comportamiento para usuarios `external` o `admin`
- Notificaciones (ya implementadas en HU-039)

---

## Criterios de aceptación (Given / When / Then)

### 1) Nombre y avatar clickeables

- **Dado** que el usuario foundation_user está autenticado
- **Cuando** se carga el `FoundationHeader`
- **Entonces** el nombre y avatar del usuario son clickeables
- **Y** muestran un cursor pointer al hacer hover
- **Y** al hacer clic, se abre el menú desplegable

### 2) Menú desplegable implementado

- **Dado** que el usuario foundation_user está autenticado
- **Cuando** hace clic en el nombre o avatar
- **Entonces** se abre un menú desplegable pequeño y discreto
- **Y** el menú muestra las opciones: "Editar perfil" y "Cerrar sesión"
- **Y** el menú muestra el email del usuario (opcional, como información)
- **Y** el menú usa componentes de MUI (Menu, MenuItem, Divider)
- **Y** el menú tiene animación suave al abrir/cerrar
- **Y** el menú se posiciona correctamente debajo del nombre/avatar

### 3) Cerrar menú

- **Dado** que el menú está abierto
- **Cuando** el usuario hace clic fuera del menú
- **Entonces** el menú se cierra
- **Y** cuando el usuario selecciona una opción del menú
- **Entonces** el menú se cierra automáticamente

### 4) UseCase de logout implementado

- **Dado** que se necesita cerrar sesión
- **Cuando** se implementa la lógica de negocio
- **Entonces** existe un UseCase `LogoutUseCase` en `domain/usecases/auth/`
- **Y** el UseCase llama a `AuthRepository.signOut()`
- **Y** el UseCase limpia la sesión en Supabase
- **Y** el UseCase retorna éxito o error según corresponda

### 5) Repositorio de logout implementado

- **Dado** que se necesita cerrar sesión en Supabase
- **Cuando** se implementa el repositorio
- **Entonces** `IAuthRepository` tiene un método `signOut(): Promise<void>`
- **Y** `AuthRepository.signOut()` llama a `supabaseClient.auth.signOut()`
- **Y** el método maneja errores correctamente

### 6) Opción "Cerrar sesión"

- **Dado** que el menú está abierto
- **Cuando** el usuario hace clic en "Cerrar sesión"
- **Entonces** se llama al `LogoutUseCase.execute()`
- **Y** la sesión se cierra correctamente en Supabase
- **Y** el usuario es redirigido a home (`/` o `/[locale]`)
- **Y** el menú se cierra automáticamente
- **Y** el usuario ya no está autenticado
- **Y** si intenta acceder al dashboard, es redirigido a login

### 7) Opción "Editar perfil"

- **Dado** que el menú está abierto
- **Cuando** el usuario hace clic en "Editar perfil"
- **Entonces** se navega a la página de edición de perfil (ej: `/[locale]/foundations/profile/edit`)
- **Y** el menú se cierra automáticamente
- **Nota**: La página de edición será implementada en otra HU, pero la navegación debe funcionar

### 8) Actualización del hook useAuth (opcional)

- **Dado** que se necesita exponer logout desde el hook
- **Cuando** se implementa el logout
- **Entonces** el hook `useAuth` puede exponer un método `logout()` (opcional)
- **Y** el método `logout()` llama al `LogoutUseCase`
- **Y** el método actualiza el estado local del hook
- **Nota**: Esto es opcional, puede llamarse directamente al UseCase desde el componente

### 9) Traducciones

- **Dado** que la aplicación soporta ES/EN
- **Cuando** se muestra el menú de cuenta
- **Entonces** todos los textos están traducidos:
  - "Editar perfil" / "Edit Profile"
  - "Cerrar sesión" / "Logout"
- **Y** los textos están en `src/messages/es/dashboard.json` y `src/messages/en/dashboard.json`
- **Y** se usa `useTranslations` para acceder a traducciones

---

## Reglas técnicas

### Arquitectura
- Presentation solo consume UseCases vía IoC (no importa repositorios concretos).
- Domain no importa React/Next/MUI/Tailwind/Inversify/Supabase.
- Infrastructure contiene implementaciones y wiring IoC.
- El menú debe estar en el componente `FoundationHeader` (Presentation).

### UI
- UI con MUI (Menu, MenuItem, Divider).
- Tailwind se usa para layout/spacing/responsive utilities.
- El menú debe usar `Menu` de MUI con `anchorEl` para posicionamiento.
- El nombre y avatar deben tener `cursor: pointer` y `onClick` handler.
- El menú debe posicionarse correctamente usando `anchorOrigin` y `transformOrigin` de MUI.

### Lógica de logout
- Crear `LogoutUseCase` en `domain/usecases/auth/LogoutUseCase.ts`.
- Agregar método `signOut()` a `IAuthRepository` e implementación en `AuthRepository`.
- El logout debe llamar a `supabaseClient.auth.signOut()`.
- El logout debe limpiar la sesión en el cliente.
- El logout debe redirigir a home.
- El hook `useAuth` debe actualizarse después del logout (o recargar la sesión).

### Navegación
- Usar `next/navigation` para redirección después del logout.
- Usar `next/link` para navegación a "Editar perfil".
- Preservar el locale en la navegación (ej: `/es` o `/en`).
- La ruta de edición puede ser `/[locale]/foundations/profile/edit` o similar (definir según convención del proyecto).

### Traducciones (OBLIGATORIO si hay UI con texto)
- **TODOS los textos visibles en la UI deben estar traducidos** (español e inglés).
- Usar el sistema de traducciones configurado en HU-016 (`next-intl`).
- Agregar traducciones en:
  - `src/messages/es/dashboard.json` (español)
  - `src/messages/en/dashboard.json` (inglés)
- Keys sugeridas:
  - `header.user.menu.editProfile`
  - `header.user.menu.logout`
- Usar `useTranslations("dashboard")` para acceder a traducciones.

### Dependencias / Paquetes
- No agregar dependencias nuevas salvo que esta HU lo indique explícitamente.
- Usar MUI Menu que ya está disponible.
- Si aparece error 403/conectividad:
  1) Detenerse
  2) Pedir dominios requeridos
  3) Explicar por qué se requieren
  4) No continuar

---

## Implementación sugerida (opcional)

### Estructura de archivos sugerida:

```
src/domain/
├── repositories/
│   └── IAuthRepository.ts (modificar, agregar signOut)
└── usecases/
    └── auth/
        └── LogoutUseCase.ts (nuevo)

src/infrastructure/
├── repositories/
│   └── AuthRepository.ts (modificar, implementar signOut)
└── ioc/
    └── container.ts (registrar LogoutUseCase)

src/presentation/
└── components/
    └── layouts/
        └── FoundationLayout/
            └── FoundationHeader.tsx (modificar)
```

### Flujo de implementación:

1. **Crear UseCase de logout**:
   - `LogoutUseCase.execute()`:
     - Llama a `AuthRepository.signOut()`
     - Retorna éxito o error

2. **Agregar método al repositorio**:
   - Agregar `signOut(): Promise<void>` a `IAuthRepository`
   - Implementar `signOut()` en `AuthRepository`:
     - Llamar a `supabaseClient.auth.signOut()`
     - Manejar errores

3. **Registrar UseCase en IoC**:
   - Agregar `LogoutUseCase` al contenedor IoC
   - Registrar tipos y binding

4. **Modificar FoundationHeader**:
   - Agregar estado para controlar apertura/cierre del menú
   - Hacer clickeable el nombre y avatar (agregar `onClick` y `cursor: pointer`)
   - Agregar `Menu` de MUI con `anchorEl` apuntando al nombre/avatar
   - Agregar `MenuItem` para "Editar perfil" y "Cerrar sesión"
   - Implementar handler de logout que llama al UseCase y redirige

5. **Actualizar hook useAuth (opcional)**:
   - Agregar método `logout()` al hook
   - O llamar directamente al UseCase desde el componente

6. **Traducciones**:
   - Agregar traducciones en `dashboard.json`
   - Usar `useTranslations` en el componente

### Ejemplo de código sugerido:

```typescript
// En FoundationHeader.tsx
const { user, loading } = useAuth();
const [menuAnchor, setMenuAnchor] = useState<null | HTMLElement>(null);
const router = useRouter();
const locale = useLocale();
const logoutUseCase = useMemo(
  () => appContainer.get<LogoutUseCase>(USE_CASE_TYPES.LogoutUseCase),
  []
);

const handleMenuOpen = (event: React.MouseEvent<HTMLElement>) => {
  setMenuAnchor(event.currentTarget);
};

const handleMenuClose = () => {
  setMenuAnchor(null);
};

const handleLogout = async () => {
  try {
    await logoutUseCase.execute();
    handleMenuClose();
    router.push(`/${locale}`);
  } catch (error) {
    // Manejar error
    console.error('Error al cerrar sesión:', error);
  }
};

// En el JSX
<Box 
  className="flex items-center gap-3"
  onClick={handleMenuOpen}
  sx={{ cursor: 'pointer' }}
>
  <Box className="hidden text-right sm:block">
    <Typography variant="body2" sx={{ fontWeight: 700 }}>
      {displayName}
    </Typography>
    <Typography variant="caption" color="text.secondary">
      {displayEmail}
    </Typography>
  </Box>
  <Avatar sx={{ width: 40, height: 40, bgcolor: "primary.main" }}>
    {initials}
  </Avatar>
</Box>
<Menu
  anchorEl={menuAnchor}
  open={Boolean(menuAnchor)}
  onClose={handleMenuClose}
  anchorOrigin={{
    vertical: 'bottom',
    horizontal: 'right',
  }}
  transformOrigin={{
    vertical: 'top',
    horizontal: 'right',
  }}
>
  <MenuItem onClick={handleMenuClose} component={Link} href={`/${locale}/foundations/profile/edit`}>
    {t('header.user.menu.editProfile')}
  </MenuItem>
  <Divider />
  <MenuItem onClick={handleLogout}>
    {t('header.user.menu.logout')}
  </MenuItem>
</Menu>
```

### Notas importantes:
- El menú debe ser pequeño y discreto.
- El menú debe cerrarse automáticamente al seleccionar una opción.
- La opción "Editar perfil" navegará a una página que será implementada en otra HU.
- El logout debe limpiar la sesión correctamente en Supabase.
- Las traducciones deben estar completas (ES/EN).
- El nombre y avatar deben ser claramente clickeables (cursor pointer, hover effect opcional).

---

## Validación

Comandos mínimos:
- `npm run dev` (verificar que el menú funciona)
- `npm run build` (verificar que no hay errores de compilación)

Verificaciones:
- El nombre y avatar son clickeables y muestran cursor pointer
- El menú se abre al hacer clic en el nombre o avatar
- El menú se cierra al hacer clic fuera o al seleccionar una opción
- El logout funciona correctamente y redirige a home
- La sesión se limpia correctamente en Supabase
- La navegación a "Editar perfil" funciona (aunque la página no esté implementada)
- Las traducciones están completas (ES/EN)
- El UseCase de logout está registrado en IoC
- El método `signOut()` está implementado en el repositorio

---

## Definición de Hecho

- [ ] Criterios de aceptación cumplidos
- [ ] `npm run dev` OK
- [ ] `npm run build` OK
- [ ] Sin violaciones de capas
- [ ] Sin cambios fuera del alcance
- [ ] **Traducciones incluidas** (si aplica UI con texto):
  - [ ] Textos agregados en `src/messages/es/dashboard.json`
  - [ ] Textos agregados en `src/messages/en/dashboard.json`
  - [ ] Componentes usan `useTranslations` (no textos hardcodeados)
  - [ ] Keys consistentes entre idiomas
- [ ] UseCase de logout creado y registrado en IoC
- [ ] Método `signOut()` agregado al repositorio e implementado
- [ ] Menú funciona correctamente
- [ ] Logout funciona correctamente y redirige a home
- [ ] Navegación a "Editar perfil" funciona (aunque la página no esté implementada)
- Commit sugerido:
  `feat: add account menu and logout for foundation users`
