# HU-031 — Editar Animal (Fundación) con Supabase

**Como** usuario de una fundación  
**Quiero** editar los datos de un animal existente  
**Para** mantener actualizado su perfil en el catálogo

---

## Dependencias

- HU-011 (Conexión a Supabase configurada)
- HU-013 (Estrategia de roles y protección de rutas definida)
- HU-014 (Formik y Yup configurados)
- HU-016 (Sistema de traducciones configurado)
- HU-018 (Layout del dashboard de fundaciones con sidebar) - **REQUERIDO**
- HU-023 (Gestión de animales con Supabase) - **REQUERIDO**
- HU-024 (Agregar animal) - **REQUERIDO**

---

## Contexto / Notas

- Esta HU permite **editar un animal existente** usando el mismo formulario de HU-024.
- La ruta debe ser `/foundations/animals/[id]/edit`.
- Los datos se cargan desde `animals` y `animal_photos`.
- El usuario solo puede editar animales de su propia fundación.
- La edición debe permitir actualizar:
  - Campos básicos del animal
  - Descripción
  - Estado y publicación
  - Imágenes (agregar/eliminar/reordenar si aplica)
- El modelo de datos es el de `docs/scripts/db.sql`.

Modelo de datos:
- `animals`: `id`, `foundation_id`, `name`, `species`, `breed`, `sex`, `age_months`, `size`, `status`, `description`, `cover_image_url`, `is_published`, `created_at`
- `animal_photos`: `animal_id`, `url`, `sort_order`

---

## Diseño (OBLIGATORIO)

Referencias:
- Diseño: `docs/design/add_animals_code.html`
- Imagen: `docs/design/add_animals_screen.png`
- Design System: `docs/design/system.md`
- Esquema BD: `docs/scripts/db.sql`

Reglas:
- Reutilizar el diseño del formulario de HU-024.
- El título y breadcrumbs deben indicar **edición**.
- Los campos deben estar prellenados con los datos actuales.
- Debe mantener validaciones y UI de HU-024.

---

## Alcance

Incluye:
- Crear página `/foundations/animals/[id]/edit`
- Cargar datos del animal desde Supabase
- Prellenar el formulario con datos existentes
- Actualizar campos en `animals`
- Manejar imágenes:
  - Mantener imágenes actuales
  - Agregar nuevas imágenes
  - Eliminar imágenes existentes
  - Actualizar `cover_image_url`
- Guardar cambios como borrador o publicado
- Redirección a `/foundations/animals` al guardar
- Estados de loading y error
- Traducciones completas (ES/EN)

No incluye:
- Crear animales nuevos (HU-024)
- Eliminar animales (HU-032)
- Historial de cambios
- Tests automatizados

---

## Criterios de aceptación (Given / When / Then)

### 1) Ruta de edición creada

- **Dado** un animal existente
- **Cuando** navego a `/foundations/animals/[id]/edit`
- **Entonces** veo el formulario de edición
- **Y** el layout usa el dashboard de fundaciones

---

### 2) Datos prellenados

- **Dado** un animal con datos en BD
- **Cuando** se carga la página
- **Entonces** los campos se prellenan con los valores actuales

---

### 3) Actualización de datos básicos

- **Dado** cambios en nombre, raza, edad, género, tamaño
- **Cuando** guardo
- **Entonces** se actualizan en `animals`

---

### 4) Actualización de descripción y estado

- **Dado** cambios en descripción o status
- **Cuando** guardo
- **Entonces** se actualizan en `animals`

---

### 5) Manejo de imágenes

- **Dado** imágenes actuales del animal
- **Cuando** agrego o elimino imágenes
- **Entonces** se actualizan los registros en `animal_photos`
- **Y** `cover_image_url` se ajusta a la primera imagen

---

### 6) Guardar como borrador o publicar

- **Dado** el toggle de publicación
- **Cuando** guardo cambios
- **Entonces** `is_published` se actualiza según selección

---

### 7) Validaciones

- **Dado** campos requeridos vacíos
- **Cuando** intento guardar
- **Entonces** se muestran errores validados por Yup

---

### 8) Estados de loading y error

- **Dado** que se guarda el formulario
- **Cuando** Supabase procesa la solicitud
- **Entonces** se muestra loading
- **Y** se maneja error con mensaje traducido

---

### 9) Traducciones

- **Dado** que se implementa la UI
- **Cuando** se revisa el código
- **Entonces** todos los textos usan `useTranslations`
- **Y** existen traducciones en `src/messages/es/animals.json` y `src/messages/en/animals.json`

---

## Reglas técnicas

### Arquitectura
- Presentation solo consume UseCases vía IoC.
- Domain no importa React/Next/MUI/Tailwind/Inversify/Supabase.
- Infrastructure contiene implementaciones y wiring IoC.
- Supabase solo vive en Infrastructure.

### Supabase / Queries
- Obtener animal:
  - `SELECT * FROM animals WHERE id = :id AND foundation_id = :foundationId`
- Actualizar:
  - `UPDATE animals SET ... WHERE id = :id AND foundation_id = :foundationId`
- Fotos:
  - `SELECT * FROM animal_photos WHERE animal_id = :id ORDER BY sort_order`
  - Insertar nuevas fotos
  - Eliminar fotos removidas

### Traducciones
- Usar `useTranslations('animals')`.
- No hardcodear textos.

---

## Implementación sugerida

```
src/app/[locale]/foundations/animals/[id]/edit/page.tsx

src/presentation/components/animals/
├── EditAnimalForm.tsx
└── addAnimalValidation.ts (reutilizable)

src/domain/
├── repositories/
│   └── IAnimalRepository.ts (add getAnimalById, updateAnimal)
└── usecases/
    └── animals/
        └── UpdateAnimalUseCase.ts

src/infrastructure/
└── repositories/
    └── AnimalRepository.ts (implementación Supabase)
```

---

## Validación

Comandos mínimos:
- `npm run dev`
- `npm run build`

Verificaciones:
- Datos prellenados
- Actualización exitosa
- Imágenes actualizadas
- Traducciones completas

---

## Definición de Hecho

- [ ] Criterios de aceptación cumplidos
- [ ] `npm run dev` OK
- [ ] `npm run build` OK
- [ ] Página de edición creada
- [ ] Actualización en Supabase funcionando
- [ ] Manejo de imágenes funcionando
- [ ] Traducciones incluidas (ES/EN)
- [ ] Sin violaciones de capas
- [ ] Sin cambios fuera del alcance
- Commit sugerido:
  `feat: add edit animal form with supabase`

