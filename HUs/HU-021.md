# HU-021 — Gestión de Perfil (lógica de negocio + persistencia en Supabase)

**Como** usuario de una fundación  
**Quiero** poder editar, guardar y reconsultar la información de mi perfil de fundación  
**Para** mantenerla siempre actualizada y consistente en la plataforma

---

## Dependencias

- Requiere: HU-019 (UI del perfil), HU-014 (Formik/Yup), HU-011 (Supabase), HU-013 (roles/rutas), HU-016 (i18n)
- Requiere análisis de BD: `docs/scripts/db.sql`


---

## Contexto / Notas

- Esta HU implementa la **lógica de negocio** para **consultar y actualizar** el perfil de fundación en Supabase.
- El formulario de edición y perfil de fundación **HU-019** ahora debe conectarse con el backend.
- El formulario debe autocompletarse con lo que ya anteriormente el usuario ha diligenciado.
- El flujo de edición y visualización del perfil de la fundación debe:
  1. Consultar la información actual de la fundación.
  2. Completar los campos que cuenten con información en la UI.
  3. Si un campo no tiene información, debe aparecer vacío (con placeholder).
  4. Al guardar, persistir los cambios en la base de datos.
  5. Al cancelar, confirmar con un modal; si se confirma, descartar cambios y **reconsultar** desde BD.
  6. Confirmar al usuario cuando la información fue almacenada correctamente.
- Se deben manejar errores comunes (no encontrado, sin permisos, conectividad, etc.).
- Después de guardar, debe quedarse en la misma página (no redirigir).

Modelo de datos (según `docs/scripts/db.sql`):
- Tabla `foundations`:
  - Campos relevantes: `name`, `description`, `logo_url`, `city`, `country`
- Tabla `foundation_contacts` (1:1):
  - Campos relevantes: `public_email`, `public_phone`, `instagram_url`, `whatsapp_url`, `address`
- Relación con usuario:
  - `profiles.id` referencia `auth.users(id)`
  - La pertenencia a una fundación se modela con `foundation_members (foundation_id, user_id)`

Reglas de autorización (alto nivel):
- El usuario debe estar autenticado.
- Para editar, el usuario debe ser miembro de la fundación (idealmente `member_role = 'owner'` o `'editor'`).
- La seguridad final debe depender de RLS en Supabase (el middleware solo es “soft”).

---

## Diseño (OBLIGATORIO si hay UI)

Referencias:
- Diseño: `docs/design/profile_foundation_screen.png` y/o `docs/design/code_profile_foundation_screen.html` (referenciados por HU-019)
- Design System: `docs/design/system.md`

Reglas:
- Respetar jerarquía visual del diseño.
- Usar tokens definidos en el Design System (no inventar tamaños/colores).
- Si algo no es claro en el diseño, preguntar antes de asumir.

---
---

## Reglas técnicas

- Arquitectura: ver `docs/01_arquitectura.md`
- Reglas Codex: ver `docs/02_reglas_de_codex.md`

## Alcance

Incluye:
- Crear lógica de **lectura** del perfil de fundación para autocompletar HU-019:
  - Obtener `foundation_id` del usuario autenticado (vía `foundation_members`)
  - Leer `foundations` y `foundation_contacts` y mapear a un modelo de dominio/DTO de “perfil”
- Crear lógica de **actualización** del perfil de fundación:
  - Update parcial de `foundations`
  - Upsert de `foundation_contacts` (si no existe aún, crearla)
- Conectar HU-019 para:
  - cargar datos iniciales (loading + manejo de error)
  - guardar (loading + éxito/error)
  - cancelar (modal de confirmación + reconsultar)
- Modal de confirmación reutilizable (Atomic Design) para “descartar cambios”
- Mensajes traducidos (i18n):
  - éxito al guardar
  - error genérico
  - no autorizado / sin permisos
  - confirmación de descarte
- Mantenerse en la misma pantalla tras guardar (sin redirect)

No incluye:
- Upload real del logo (`logo_url` solo se actualiza como string; el storage/upload va en otra HU)
- Gestión de múltiples fundaciones por usuario (se asume 1 fundación “activa” por perfil para este flujo)
- Permisos granulares avanzados (más allá de membership básico)
- Crear/editar `profiles` o roles (solo se usa identidad del usuario)
- Tests automatizados (si luego se define estrategia de tests, se hará en HU futura)

---

## Criterios de aceptación (Given / When / Then)

### 1) Consulta de perfil (autocompletar)

- **Dado** un usuario autenticado con rol `foundation_user`
- **Cuando** navega a la pantalla de perfil de fundación (HU-019)
- **Entonces** el sistema consulta la fundación del usuario (usando `foundation_members`)
- **Y** obtiene la información de `foundations` y `foundation_contacts`
- **Y** precarga el formulario con los valores existentes
- **Y** si un dato no existe, el campo queda vacío con placeholder (sin romper la UI)

### 2) Guardado de perfil (persistencia en Supabase)

- **Dado** que el usuario modifica campos del formulario
- **Cuando** presiona “Guardar”
- **Entonces** se envían los cambios al UseCase correspondiente
- **Y** se actualiza `foundations` (campos del perfil base)
- **Y** se crea o actualiza `foundation_contacts` (campos de contacto público) mediante upsert
- **Y** se muestra estado de loading durante el guardado
- **Y** al finalizar correctamente se muestra un mensaje de éxito traducido
- **Y** la pantalla no redirige (permanece en el perfil)

### 3) Cancelar con confirmación y reconsulta

- **Dado** que el usuario tiene cambios sin guardar
- **Cuando** presiona “Cancelar”
- **Entonces** se muestra un modal de confirmación (reutilizable)
- **Y** si confirma, se descartan los cambios y se reconsulta la información desde BD
- **Y** si cancela el modal, se mantienen los cambios actuales en el formulario

### 4) Manejo de errores y permisos

- **Dado** que ocurre un error al consultar o guardar
- **Cuando** Supabase retorna error (por ejemplo: sin permisos, not found, conectividad)
- **Entonces** se muestra un mensaje traducido apropiado
- **Y** la UI no se rompe ni queda en un estado inconsistente
- **Y** si el usuario no tiene permisos (no es miembro), se bloquea la operación y se informa

### 5) Reglas de arquitectura cumplidas

- **Dado** que se implementa la lógica
- **Cuando** se revisan imports y capas
- **Entonces** Domain no importa Supabase/React/Next/MUI
- **Y** Presentation consume UseCases vía IoC
- **Y** Infrastructure contiene las implementaciones de repositorios y el wiring
---

## Reglas técnicas

### Arquitectura
- Presentation solo consume UseCases vía IoC (no importa repositorios concretos).
- Domain no importa React/Next/MUI/Tailwind/Inversify.
- Infrastructure contiene implementaciones y wiring IoC.

### UI (si aplica)
- UI con MUI.
- Tailwind se usa para layout/spacing/responsive utilities (si está habilitado).
- No agregar librerías de estilos adicionales sin HU específica.

### Traducciones (OBLIGATORIO si hay UI con texto)
- **TODOS los textos visibles en la UI deben estar traducidos** (español e inglés).
- Usar el sistema de traducciones configurado en HU-016 (`next-intl`).
- Agregar traducciones en los archivos correspondientes:
  - `src/messages/es/<namespace>.json` (español)
  - `src/messages/en/<namespace>.json` (inglés)
- Organizar traducciones por namespace:
  - `common.json`: textos comunes (botones, labels, mensajes genéricos)
  - `home.json`: textos de la página home
  - `register.json`: textos de registro
  - `[feature].json`: textos específicos de cada feature
- **NO hardcodear textos en español o inglés** en componentes.
- Usar `useTranslations` hook de `next-intl` para acceder a traducciones.
- Keys descriptivas y anidadas: `home.hero.title`, `register.form.email.label`.
- Mantener consistencia: mismas keys en ambos idiomas.

### Dependencias / Paquetes
- No agregar dependencias nuevas salvo que esta HU lo indique explícitamente.
- Si aparece error 403/conectividad:
  1) Detenerse
  2) Pedir dominios requeridos
  3) Explicar por qué se requieren
  4) No continuar

---

## Implementación sugerida (opcional)

- Archivos/carpetas sugeridas:
  - Domain:
    - `src/domain/models/FoundationProfile.ts` (modelo agregado o DTO de perfil)
    - `src/domain/repositories/IFoundationProfileRepository.ts`
    - `src/domain/usecases/foundation/GetFoundationProfileUseCase.ts`
    - `src/domain/usecases/foundation/UpdateFoundationProfileUseCase.ts`
  - Infrastructure:
    - `src/infrastructure/repositories/FoundationProfileRepository.ts` (Supabase)
    - IoC bindings en `src/infrastructure/ioc/...`
  - Presentation:
    - En HU-019, adaptar la página para cargar/guardar con los use cases
    - `src/presentation/components/atoms/ConfirmDialog.tsx` (modal genérico, si no existe)
  - i18n:
    - `src/messages/es/foundations.json`
    - `src/messages/en/foundations.json`

Estrategia técnica (resumen):
- Identidad: usar `supabase.auth.getUser()` para obtener `user.id`.
- Resolver `foundation_id`:
  - `select foundation_id from foundation_members where user_id = :userId limit 1`
- Leer:
  - `foundations` por `foundation_id`
  - `foundation_contacts` por `foundation_id` (puede no existir)
- Guardar:
  - `update foundations set ... where id = :foundationId`
  - `upsert foundation_contacts (foundation_id, ...) on conflict (foundation_id)`

---

## Validación

Comandos mínimos:
- `npm run dev`
- `npm run build`

(Agregar tests si aplica)

---

## Definición de Hecho

- [ ] Criterios de aceptación cumplidos
- [ ] `npm run dev` OK
- [ ] `npm run build` OK
- [ ] Sin violaciones de capas
- [ ] Sin cambios fuera del alcance
- [ ] **Traducciones incluidas** (si aplica UI con texto):
  - [ ] Textos agregados en `src/messages/es/<namespace>.json`
  - [ ] Textos agregados en `src/messages/en/<namespace>.json`
  - [ ] Componentes usan `useTranslations` (no textos hardcodeados)
  - [ ] Keys consistentes entre idiomas
- Commit sugerido:
  `<tipo>: <mensaje>`