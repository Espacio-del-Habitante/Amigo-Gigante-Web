# HU-029 — Gestión de Productos (Fundación) con Supabase

**Como** usuario de una fundación  
**Quiero** gestionar los productos de mi Tienda Solidaria  
**Para** publicar, filtrar y administrar mi catálogo

---

## Dependencias

- HU-005 (MUI configurado)
- HU-007 (Tailwind configurado)
- HU-010 (Atomic Design - componentes reutilizables)
- HU-011 (Conexión a Supabase configurada)
- HU-016 (Sistema de traducciones configurado)
- HU-018 (Layout del dashboard de fundaciones con sidebar) - **REQUERIDO**

---

## Contexto / Notas

- Esta HU implementa la **pantalla de gestión de productos** para fundaciones.
- La UI debe seguir `docs/design/products_screen.png` y `docs/design/products_code.html`.
- La ruta debe ser `/foundations/products`.
- La data proviene de Supabase (`products`) filtrada por `foundation_id` del usuario.
- **No existe categoría en BD** → el filtro “Category” del diseño se reemplaza por **rango de precio**.
- El estado publicado se maneja con `is_published`.

Modelo de datos (según `docs/scripts/db.sql`):
- `products`:
  - `id`, `foundation_id`, `name`, `description`, `price`, `image_url`, `is_published`, `created_at`

---

## Diseño (OBLIGATORIO)

Referencias:
- Diseño: `docs/design/products_code.html`
- Imagen: `docs/design/products_screen.png`
- Design System: `docs/design/system.md`
- Esquema BD: `docs/scripts/db.sql`

Estructura de la página:
- Sidebar (layout de fundaciones)
- Header con:
  - Título “Product Management”
  - Subtítulo
  - Botón “Add New Product”
- Barra de búsqueda y filtros:
  - Search input (name/description)
  - Filtro de Status (All / Published / Draft)
  - Filtro de Price (All / <$10 / $10–$25 / $25+)
- Tabla:
  - Image
  - Product Details (name + description)
  - Price
  - Published (toggle)
  - Actions (Edit/Delete en hover)
- Paginación

Reglas:
- Respetar jerarquía visual del diseño.
- Usar tokens del Design System.
- Tabla responsive con scroll horizontal.

---

## Alcance

Incluye:
- Crear página `/foundations/products`
- Renderizar tabla con productos de la fundación
- Búsqueda por nombre/descripcion
- Filtro por status (is_published)
- Filtro por rango de precio (derivado de `price`)
- Paginación server-side
- Toggle de publicado (actualiza `is_published`)
- Botón “Add New Product” navega a `/foundations/products/new` (HU-030)
- Estados de loading y error
- Traducciones completas (ES/EN)

No incluye:
- Categorías (no existen en BD)
- Carrito o checkout
- Edición completa (HU futura o HU-030 si se extiende)
- Eliminación definitiva (solo UI si no se define flujo)
- Tests automatizados

---

## Criterios de aceptación (Given / When / Then)

### 1) Página creada y accesible

- **Dado** que soy usuario de fundación
- **Cuando** navego a `/foundations/products`
- **Entonces** veo la gestión de productos
- **Y** el layout usa el sidebar de fundaciones

---

### 2) Lista de productos por fundación

- **Dado** productos en Supabase
- **Cuando** carga la página
- **Entonces** se consultan productos con `foundation_id` del usuario
- **Y** se muestran en la tabla

---

### 3) Búsqueda funcional

- **Dado** que escribo en el buscador
- **Cuando** busco por nombre o descripción
- **Entonces** la tabla se filtra correctamente

---

### 4) Filtro de status

- **Dado** el filtro de status
- **Cuando** selecciono Published/Draft
- **Entonces** se filtra por `is_published = true/false`

---

### 5) Filtro de precio

- **Dado** el filtro de precio
- **Cuando** selecciono un rango
- **Entonces** se filtran productos por `price` en ese rango

---

### 6) Toggle de publicado

- **Dado** un producto en la tabla
- **Cuando** cambio el toggle de Published
- **Entonces** se actualiza `is_published` en Supabase
- **Y** el estado visual se actualiza

---

### 7) Paginación server-side

- **Dado** muchos productos
- **Cuando** cambio de página
- **Entonces** se consulta Supabase con `range()`
- **Y** se actualiza la tabla

---

### 8) Botón Add New Product

- **Dado** el botón “Add New Product”
- **Cuando** hago clic
- **Entonces** navego a `/foundations/products/new`

---

### 9) Estados de loading y error

- **Dado** que se consulta Supabase
- **Cuando** se carga la tabla
- **Entonces** se muestra loading
- **Y** se manejan errores con mensaje traducido

---

### 10) Traducciones

- **Dado** que se implementa la UI
- **Cuando** se revisa el código
- **Entonces** todos los textos usan `useTranslations`
- **Y** existen traducciones en `src/messages/es/products.json` y `src/messages/en/products.json`

---

## Reglas técnicas

### Arquitectura
- Presentation solo consume UseCases vía IoC.
- Domain no importa React/Next/MUI/Tailwind/Inversify/Supabase.
- Infrastructure contiene implementaciones y wiring IoC.
- Supabase solo vive en Infrastructure.

### Supabase / Queries
- Productos:
  - `SELECT * FROM products WHERE foundation_id = :foundationId`
- Filtros:
  - status: `is_published = true/false`
  - price range: `price >= min AND price <= max`
  - search: `name ILIKE %q% OR description ILIKE %q%`
- Paginación:
  - `range(from, to)` con `count: 'exact'`

### Traducciones
- Usar `useTranslations('products')`.
- No hardcodear textos.

---

## Implementación sugerida

```
src/app/[locale]/foundations/products/page.tsx

src/presentation/components/products/
├── ProductsManagementPage.tsx
├── ProductsFilters.tsx
├── ProductsTable.tsx
├── ProductsPagination.tsx
└── ProductPublishToggle.tsx

src/domain/
├── repositories/
│   └── IProductRepository.ts (getProducts, updatePublishStatus)
└── usecases/
    └── products/
        └── GetProductsUseCase.ts

src/infrastructure/
├── repositories/
│   └── ProductRepository.ts (implementación Supabase)
└── ioc/
    └── bindings actualizados

src/messages/
├── es/
│   └── products.json
└── en/
    └── products.json
```

---

## Validación

Comandos mínimos:
- `npm run dev`
- `npm run build`

Verificaciones:
- Lista correcta desde Supabase
- Filtros y búsqueda funcionan
- Toggle publicado actualiza BD
- Traducciones completas

---

## Definición de Hecho

- [ ] Criterios de aceptación cumplidos
- [ ] `npm run dev` OK
- [ ] `npm run build` OK
- [ ] Página de gestión creada
- [ ] Filtros y búsqueda funcionales
- [ ] Toggle de publicación funcional
- [ ] Paginación server-side
- [ ] Traducciones incluidas (ES/EN)
- [ ] Sin violaciones de capas
- [ ] Sin cambios fuera del alcance
- Commit sugerido:
  `feat: add products management page with supabase data`

