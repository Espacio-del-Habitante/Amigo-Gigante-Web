# HU-050 — Proceso de Compra con Voucher y Notificaciones

**Como** usuario externo  
**Quiero** completar una compra desde el carrito con envío de voucher y factura  
**Para** recibir confirmación de mi compra y documentación formal

---

## Dependencias

- HU-001 (Next.js App Router)
- HU-007 (Tailwind configurado)
- HU-010 (Atomic Design - componentes reutilizables)
- HU-011 (Conexión a Supabase configurada)
- HU-016 (Sistema de traducciones configurado)
- HU-028 (Tienda Solidaria implementada)
- HU-035 (Detalle de Producto + Carrito de Compras)

---

## Contexto / Notas

- Esta HU es la **continuación de HU-035** y completa el flujo de compra.
- El proceso de compra debe:
  1. Crear una solicitud de compra (orden) con estado `pending`
  2. Generar un voucher visual atractivo
  3. Enviar datos de la compra a WhatsApp
  4. Enviar voucher por correo electrónico
  5. Enviar factura por correo electrónico
- Los emails se guardan en la tabla `email_queue` según `docs/scripts/db.sql`.
- El voucher debe tener un diseño profesional y atractivo.
- La factura debe seguir un formato estándar con todos los datos de la compra.
- El envío a WhatsApp puede ser mediante link con datos prellenados o integración con API.

---

## Diseño (OBLIGATORIO)

Referencias:
- Diseño: `docs/design/system.md`
- Voucher: debe ser visualmente atractivo con:
  - Logo de la fundación/producto
  - Número de orden/compra
  - Fecha y hora
  - Lista de productos comprados
  - Total pagado
  - Información de contacto
  - Código QR opcional para verificación
- Factura: formato profesional con:
  - Datos del comprador
  - Datos de la fundación
  - Detalle de productos
  - Subtotal, impuestos (si aplica), total
  - Número de factura
  - Fecha de emisión

Reglas:
- El voucher debe ser generado como PDF o imagen para envío por email.
- El diseño debe ser responsive y verse bien en diferentes dispositivos.
- Colores y estilos deben seguir el Design System.
- El voucher debe incluir información suficiente para que el usuario pueda verificar su compra.

---

## Alcance

Incluye:
- Crear tabla `purchase_orders` en BD para almacenar órdenes de compra
- Crear tabla `purchase_order_items` para los items de cada orden
- Crear página/formulario de checkout desde el carrito
- Implementar proceso de creación de orden con estado `pending`
- Generar voucher visual (PDF o HTML renderizado)
- Enviar datos de compra a WhatsApp (link o integración)
- Enviar voucher por email (guardado en `email_queue`)
- Enviar factura por email (guardado en `email_queue`)
- Guardar emails en la tabla `email_queue` con templates apropiados
- Mostrar confirmación de compra al usuario
- Traducciones completas (ES/EN)

No incluye:
- Procesamiento de pago real (tarjetas, transferencias)
- Integración con pasarelas de pago
- Gestión de inventario/stock
- Sistema de tracking de envíos
- Reembolsos o cancelaciones
- Tests automatizados

---

## Criterios de aceptación (Given / When / Then)

### 1) Tabla de órdenes creada
- **Dado** que se necesita almacenar órdenes de compra
- **Cuando** se implementa la funcionalidad
- **Entonces** existe la tabla `purchase_orders` en Supabase
- **Y** existe la tabla `purchase_order_items` para los items
- **Y** las tablas tienen las relaciones correctas con `products`, `foundations` y `profiles`

### 2) Página de checkout creada
- **Dado** un carrito con items
- **Cuando** el usuario hace clic en "Finalizar compra"
- **Entonces** se muestra la página de checkout
- **Y** se muestran los datos del usuario (si está autenticado)
- **Y** se muestra un formulario para completar datos de envío/contacto

### 3) Creación de orden
- **Dado** que el usuario completa el checkout
- **Cuando** confirma la compra
- **Entonces** se crea un registro en `purchase_orders` con estado `pending`
- **Y** se crean registros en `purchase_order_items` para cada producto
- **Y** se guarda la información del comprador y total

### 4) Generación de voucher
- **Dado** que se creó una orden
- **Cuando** se genera el voucher
- **Entonces** se crea un voucher visualmente atractivo
- **Y** el voucher incluye número de orden, fecha, productos, total
- **Y** el voucher puede ser exportado como PDF o imagen

### 5) Envío a WhatsApp
- **Dado** que se creó una orden
- **Cuando** se completa la compra
- **Entonces** se genera un link de WhatsApp con los datos de la compra
- **O** se envía un mensaje a WhatsApp con los detalles (si hay integración)
- **Y** el mensaje incluye número de orden y resumen de productos

### 6) Envío de voucher por email
- **Dado** que se creó una orden
- **Cuando** se completa la compra
- **Entonces** se crea un registro en `email_queue` con template `purchase_voucher`
- **Y** el payload incluye los datos de la orden y el voucher
- **Y** el email se envía al correo del comprador

### 7) Envío de factura por email
- **Dado** que se creó una orden
- **Cuando** se completa la compra
- **Entonces** se crea un registro en `email_queue` con template `purchase_invoice`
- **Y** el payload incluye los datos de la orden y la factura
- **Y** el email se envía al correo del comprador

### 8) Confirmación al usuario
- **Dado** que se completó una compra
- **Cuando** se procesa la orden
- **Entonces** se muestra una página de confirmación
- **Y** se muestra el número de orden
- **Y** se muestra el voucher generado
- **Y** se muestra el link de WhatsApp
- **Y** se indica que se enviaron los emails

### 9) Persistencia de emails
- **Dado** que se envían emails
- **Cuando** se crean los registros en `email_queue`
- **Entonces** todos los emails se guardan correctamente
- **Y** tienen el template correcto (`purchase_voucher` o `purchase_invoice`)
- **Y** el payload contiene todos los datos necesarios
- **Y** el status inicial es `pending`

### 10) Traducciones
- **Dado** la implementación
- **Cuando** se revisa la UI
- **Entonces** no hay textos hardcodeados
- **Y** existen traducciones en `src/messages/es/purchase.json` y `src/messages/en/purchase.json`

---

## Reglas técnicas

### Arquitectura
- Presentation solo consume UseCases vía IoC.
- Domain no importa React/Next/MUI/Tailwind/Inversify/Supabase.
- Infrastructure contiene implementaciones y wiring IoC.
- Supabase solo vive en Infrastructure.

### Modelo de datos

#### Tabla `purchase_orders`
```sql
create table purchase_orders (
  id bigint primary key generated always as identity,
  user_id uuid references profiles(id) on delete set null,
  foundation_id uuid not null references foundations(id) on delete cascade,
  
  -- Datos del comprador (snapshot)
  buyer_name text not null,
  buyer_email text not null,
  buyer_phone text,
  buyer_address text,
  buyer_city text,
  buyer_country text,
  
  -- Estado y totales
  status text not null default 'pending'
    check (status in ('pending', 'confirmed', 'processing', 'shipped', 'delivered', 'cancelled')),
  subtotal numeric not null check (subtotal >= 0),
  shipping_cost numeric default 0 check (shipping_cost >= 0),
  total numeric not null check (total >= 0),
  
  -- Información adicional
  notes text,
  whatsapp_sent boolean not null default false,
  voucher_sent boolean not null default false,
  invoice_sent boolean not null default false,
  
  -- Auditoría
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);
```

#### Tabla `purchase_order_items`
```sql
create table purchase_order_items (
  id bigint primary key generated always as identity,
  order_id bigint not null references purchase_orders(id) on delete cascade,
  product_id bigint not null references products(id) on delete restrict,
  
  -- Snapshot del producto al momento de la compra
  product_name text not null,
  product_price numeric not null check (product_price >= 0),
  quantity integer not null check (quantity > 0),
  subtotal numeric not null check (subtotal >= 0),
  
  created_at timestamptz not null default now()
);
```

#### Índices
```sql
create index purchase_orders_user_idx on purchase_orders(user_id);
create index purchase_orders_foundation_idx on purchase_orders(foundation_id);
create index purchase_orders_status_idx on purchase_orders(status);
create index purchase_order_items_order_idx on purchase_order_items(order_id);
create index purchase_order_items_product_idx on purchase_order_items(product_id);
```

### Supabase / Queries
- Crear orden:
  - `INSERT INTO purchase_orders (...) VALUES (...) RETURNING *`
  - `INSERT INTO purchase_order_items (...) VALUES (...)`
- Obtener orden:
  - `SELECT * FROM purchase_orders WHERE id = :id`
  - `SELECT * FROM purchase_order_items WHERE order_id = :id`
- Encolar emails:
  - `INSERT INTO email_queue(user_id, to_email, template, payload) VALUES (...)`

### WhatsApp
- Opción 1: Generar link con datos prellenados
  - Formato: `https://wa.me/{phone}?text={encoded_message}`
  - El mensaje debe incluir número de orden, productos y total
- Opción 2: Integración con API de WhatsApp Business (si está disponible)

### Generación de Voucher
- Usar librería de generación de PDF (ej: `react-pdf`, `jspdf`, `pdfkit`)
- O generar HTML y convertir a PDF/imagen
- El voucher debe ser visualmente atractivo con:
  - Header con logo/branding
  - Información de la orden
  - Lista de productos
  - Total
  - Footer con información de contacto

### Generación de Factura
- Similar al voucher pero con formato más formal
- Incluir datos fiscales si aplica
- Número de factura único
- Fecha de emisión

### Traducciones
- Usar `useTranslations('purchase')`.
- No hardcodear textos.
- Templates de email también deben estar traducidos.

### Dependencias / Paquetes
- Considerar agregar librería para generación de PDFs si no existe.
- Considerar agregar librería para generación de QR codes si se incluye.
- No agregar dependencias innecesarias.

---

## Implementación sugerida

### Estructura de archivos sugerida:
```
src/app/[locale]/shop/checkout/page.tsx
src/app/[locale]/shop/checkout/confirm/page.tsx

src/presentation/components/purchase/
├── CheckoutPage.tsx
├── CheckoutForm.tsx
├── CheckoutSummary.tsx
├── PurchaseConfirmationPage.tsx
├── VoucherGenerator.tsx
├── InvoiceGenerator.tsx
└── WhatsAppShareButton.tsx

src/domain/
├── models/
│   ├── PurchaseOrder.ts
│   └── PurchaseOrderItem.ts
├── repositories/
│   └── IPurchaseOrderRepository.ts
└── usecases/
    └── purchase/
        ├── CreatePurchaseOrderUseCase.ts
        ├── GetPurchaseOrderUseCase.ts
        ├── GenerateVoucherUseCase.ts
        ├── GenerateInvoiceUseCase.ts
        └── SendPurchaseNotificationsUseCase.ts

src/infrastructure/
├── repositories/
│   └── PurchaseOrderRepository.ts
└── ioc/
    └── bindings actualizados

src/messages/
├── es/
│   └── purchase.json
└── en/
    └── purchase.json
```

### Script SQL para crear tablas:
Agregar al archivo `docs/scripts/db.sql` las definiciones de `purchase_orders` y `purchase_order_items` según el modelo de datos definido arriba.

---

## Validación

Comandos mínimos:
- `npm run dev`
- `npm run build`

Verificaciones:
- Checkout funcional desde el carrito
- Orden creada correctamente en BD
- Voucher generado y visualmente atractivo
- Link de WhatsApp funcional
- Emails guardados en `email_queue`
- Confirmación mostrada al usuario
- Traducciones completas

---

## Definición de Hecho

- [ ] Criterios de aceptación cumplidos
- [ ] `npm run dev` OK
- [ ] `npm run build` OK
- [ ] Tablas creadas en Supabase
- [ ] Checkout funcional
- [ ] Voucher generado y atractivo
- [ ] Envío a WhatsApp funcional
- [ ] Emails guardados en `email_queue`
- [ ] Traducciones incluidas (ES/EN)
- [ ] Sin violaciones de capas
- [ ] Sin cambios fuera del alcance
- Commit sugerido:
  `feat: add purchase flow with voucher and notifications`
