# HU-059 — Sección "Mis Adopciones" para usuarios externos

**Como** usuario externo (adoptante)  
**Quiero** ver un listado de todas mis solicitudes de adopción  
**Para** poder seguir el estado de mis procesos de adopción y responder a solicitudes de información

---

## Dependencias

- HU-001 (Next.js App Router)
- HU-011 (Conexión a Supabase configurada)
- HU-016 (Sistema de traducciones configurado)
- HU-036 (Flujo de solicitud de adopción implementado)
- HU-037 (Gestión de solicitudes de adopción - para entender estructura de datos)
- HU-040 (Registro de usuario externo)

---

## Contexto / Notas

- Esta HU implementa la sección "Mis Adopciones" para usuarios externos (adoptantes).
- Los usuarios externos deben poder ver todas sus solicitudes de adopción en un solo lugar.
- Diseño disponible en:
  - `docs/design/manage_requests_screen.png`
  - `docs/design/manage_requests_code.html`
- La data proviene de Supabase según `docs/scripts/db.sql`.
- Cada solicitud muestra:
  - Foto del animal
  - Nombre del animal
  - Especie (perro/gato)
  - Nombre de la fundación
  - Fecha de solicitud
  - Estado actual (con badge de color)
  - Botón de acción según el estado:
    - Si `info_requested`: botón "Responder" que lleva a la página de respuesta (HU-060)
    - Otros estados: botón de ver detalle o chevron
- Los estados posibles son:
  - `pending` → "Pendiente" (badge amarillo)
  - `in_review` → "En Revisión" (badge amarillo)
  - `info_requested` → "Info Requerida" (badge ámbar) + botón "Responder"
  - `preapproved` → "Preaprobada" (badge azul)
  - `approved` → "Aprobada" (badge verde)
  - `rejected` → "Rechazada" (badge rojo)
  - `cancelled` → "Cancelada" (badge gris)
  - `completed` → "Completada" (badge verde oscuro)

---

## Diseño (OBLIGATORIO)

Referencias:
- Diseño: `docs/design/manage_requests_code.html`
- Imagen: `docs/design/manage_requests_screen.png`
- Design System: `docs/design/system.md`

Reglas:
- Respetar jerarquía visual y estilos del diseño.
- Layout con sidebar de navegación (similar al diseño HTML).
- Cards para cada solicitud con:
  - Imagen circular del animal (80x80px)
  - Nombre del animal con badge de especie
  - Nombre de la fundación con ícono de casa
  - Fecha de solicitud
  - Badge de estado con colores según el estado
  - Botón de acción (Responder o ver detalle)
- Sección informativa al final con botón de contacto de soporte.
- Los textos deben estar traducidos (ES/EN).

---

## Alcance

Incluye:
- Crear ruta: `/[locale]/account/adoptions` (o similar)
- Crear componente `MyAdoptionsPage` que muestre el listado
- Crear Use Case `GetUserAdoptionRequestsUseCase` que:
  - Obtenga el usuario autenticado
  - Valide que es usuario externo
  - Obtenga todas sus solicitudes de adopción desde `adoption_requests` donde `adopter_user_id = user.id`
  - Incluya datos del animal (nombre, foto, especie)
  - Incluya datos de la fundación (nombre)
  - Ordene por fecha de creación (más recientes primero)
- Mostrar estados con badges de colores según el diseño
- Botón "Responder" para solicitudes con estado `info_requested` que navegue a `/account/adoptions/[id]/respond`
- Botón de ver detalle para otras solicitudes (opcional, puede ser solo chevron)
- Estados de loading y error
- Traducciones completas (ES/EN)
- Sección informativa al final con botón de contacto

No incluye:
- Funcionalidad de respuesta a solicitudes (HU-060)
- Edición de solicitudes
- Cancelación de solicitudes
- Filtros o búsqueda (solo listado simple)
- Paginación (mostrar todas las solicitudes del usuario)

---

## Criterios de aceptación (Given / When / Then)

### 1) Listado de solicitudes del usuario

- **Dado** que un usuario externo está autenticado
- **Cuando** accede a `/account/adoptions`
- **Entonces** ve todas sus solicitudes de adopción
- **Y** cada solicitud muestra:
  - Foto del animal (o placeholder si no hay)
  - Nombre del animal
  - Badge de especie (perro/gato)
  - Nombre de la fundación
  - Fecha de solicitud formateada
  - Badge de estado con color correcto
  - Botón de acción según el estado

### 2) Estados y badges

- **Dado** que una solicitud tiene estado `info_requested`
- **Cuando** se muestra en el listado
- **Entonces** muestra badge ámbar con texto "Info Requerida"
- **Y** muestra botón "Responder" que navega a `/account/adoptions/[id]/respond`

### 3) Estados y badges (otros estados)

- **Dado** que una solicitud tiene estado `pending`, `in_review`, `approved`, `rejected`, etc.
- **Cuando** se muestra en el listado
- **Entonces** muestra el badge con el color y texto correcto según el estado
- **Y** muestra botón de ver detalle o chevron (no "Responder")

### 4) Ordenamiento

- **Dado** que el usuario tiene múltiples solicitudes
- **Cuando** se carga el listado
- **Entonces** las solicitudes se muestran ordenadas por fecha de creación (más recientes primero)

### 5) Estados de loading y error

- **Dado** que se está cargando el listado
- **Cuando** la consulta está en progreso
- **Entonces** se muestra un indicador de carga
- **Y** si hay error, se muestra un mensaje de error traducido

### 6) Validación de permisos

- **Dado** que un usuario no autenticado intenta acceder
- **Cuando** navega a `/account/adoptions`
- **Entonces** es redirigido al login

### 7) Validación de rol

- **Dado** que un usuario de fundación intenta acceder
- **Cuando** navega a `/account/adoptions`
- **Entonces** se muestra un error de autorización o se redirige

### 8) Solicitudes vacías

- **Dado** que un usuario no tiene solicitudes
- **Cuando** accede a `/account/adoptions`
- **Entonces** se muestra un mensaje indicando que no hay solicitudes
- **Y** se muestra un botón o enlace para explorar animales disponibles

### 9) Traducciones

- **Dado** que la UI está implementada
- **Cuando** se revisa el código
- **Entonces** no hay textos hardcodeados
- **Y** existen traducciones en `src/messages/es/my-adoptions.json` y `src/messages/en/my-adoptions.json`

---

## Reglas técnicas

### Arquitectura
- Presentation solo consume UseCases vía IoC (no importa repositorios concretos).
- Domain no importa React/Next/MUI/Tailwind/Inversify/Supabase.
- Infrastructure contiene implementaciones y wiring IoC.
- El Use Case debe validar que el usuario es externo antes de obtener solicitudes.

### Estructura del Use Case

```typescript
// domain/usecases/adopt/GetUserAdoptionRequestsUseCase.ts
import type { IAdoptionRequestRepository } from "@/domain/repositories/IAdoptionRequestRepository";
import type { IAuthRepository } from "@/domain/repositories/IAuthRepository";

export interface GetUserAdoptionRequestsResult {
  requests: UserAdoptionRequestSummary[];
}

export interface UserAdoptionRequestSummary {
  id: number;
  animal: {
    id: number;
    name: string;
    species: 'dog' | 'cat';
    coverImageUrl: string | null;
  };
  foundation: {
    id: string;
    name: string;
  };
  status: AdoptionRequestStatus;
  createdAt: string;
}

export class GetUserAdoptionRequestsUseCase {
  constructor(
    private readonly adoptionRequestRepository: IAdoptionRequestRepository,
    private readonly authRepository: IAuthRepository,
  ) {}

  async execute(): Promise<GetUserAdoptionRequestsResult> {
    // 1. Validar sesión
    const session = await this.authRepository.getSession();
    if (!session?.user?.id) {
      throw new Error("errors.unauthorized");
    }

    // 2. Validar que es usuario externo (opcional, pero recomendado)
    // (puedes obtener el perfil y verificar role === 'external')

    // 3. Obtener solicitudes del usuario
    return this.adoptionRequestRepository.getUserRequests({
      adopterUserId: session.user.id,
    });
  }
}
```

### Actualización del Repositorio

```typescript
// domain/repositories/IAdoptionRequestRepository.ts
// Agregar método:

export interface GetUserAdoptionRequestsParams {
  adopterUserId: string;
}

export interface UserAdoptionRequestSummary {
  id: number;
  animal: {
    id: number;
    name: string;
    species: 'dog' | 'cat';
    coverImageUrl: string | null;
  };
  foundation: {
    id: string;
    name: string;
  };
  status: AdoptionRequestStatus;
  createdAt: string;
}

export interface GetUserAdoptionRequestsResult {
  requests: UserAdoptionRequestSummary[];
}

export interface IAdoptionRequestRepository {
  // ... métodos existentes
  getUserRequests(params: GetUserAdoptionRequestsParams): Promise<GetUserAdoptionRequestsResult>;
}
```

### Implementación en el Repositorio

```typescript
// infrastructure/repositories/AdoptionRequestRepository.ts
async getUserRequests(params: GetUserAdoptionRequestsParams): Promise<GetUserAdoptionRequestsResult> {
  const { data, error } = await supabaseClient
    .from("adoption_requests")
    .select(
      `id,
      status,
      created_at,
      animals (id, name, species, cover_image_url),
      foundations (id, name)`
    )
    .eq("adopter_user_id", params.adopterUserId)
    .order("created_at", { ascending: false });

  if (error) {
    throw new Error(this.translateAdoptionError(error));
  }

  return {
    requests: (data ?? []).map((row) => ({
      id: row.id,
      animal: {
        id: row.animals.id,
        name: row.animals.name,
        species: row.animals.species as 'dog' | 'cat',
        coverImageUrl: row.animals.cover_image_url,
      },
      foundation: {
        id: row.foundations.id,
        name: row.foundations.name,
      },
      status: row.status as AdoptionRequestStatus,
      createdAt: row.created_at,
    })),
  };
}
```

### Estructura de archivos sugerida

```
src/app/[locale]/account/adoptions/page.tsx

src/presentation/components/my-adoptions/
├── MyAdoptionsPage.tsx
├── AdoptionRequestCard.tsx
└── EmptyState.tsx

src/domain/
├── models/
│   └── AdoptionRequest.ts (extender con UserAdoptionRequestSummary si es necesario)
├── repositories/
│   └── IAdoptionRequestRepository.ts (agregar getUserRequests)
└── usecases/
    └── adopt/
        └── GetUserAdoptionRequestsUseCase.ts

src/infrastructure/
├── repositories/
│   └── AdoptionRequestRepository.ts (implementar getUserRequests)
└── ioc/
    └── bindings actualizados

src/messages/
├── es/
│   └── my-adoptions.json
└── en/
    └── my-adoptions.json
```

### Traducciones (OBLIGATORIO)

```json
// src/messages/es/my-adoptions.json
{
  "title": "Mis Solicitudes de Adopción",
  "description": "Sigue el estado de tus procesos de adopción y responde a las solicitudes de información.",
  "empty": {
    "title": "No tienes solicitudes de adopción",
    "description": "Explora los animales disponibles y crea tu primera solicitud.",
    "button": "Explorar Animales"
  },
  "status": {
    "pending": "Pendiente",
    "in_review": "En Revisión",
    "info_requested": "Info Requerida",
    "preapproved": "Preaprobada",
    "approved": "Aprobada",
    "rejected": "Rechazada",
    "cancelled": "Cancelada",
    "completed": "Completada"
  },
  "species": {
    "dog": "Perro",
    "cat": "Gato"
  },
  "actions": {
    "respond": "Responder",
    "view": "Ver Detalle"
  },
  "requestedOn": "Solicitado el {{date}}",
  "infoSection": {
    "title": "¿Tienes dudas sobre tu proceso?",
    "description": "Nuestro equipo de soporte y las fundaciones están aquí para ayudarte en cada paso del camino.",
    "button": "Contactar Soporte"
  },
  "errors": {
    "unauthorized": "No autorizado",
    "generic": "Error al cargar tus solicitudes"
  }
}
```

```json
// src/messages/en/my-adoptions.json
{
  "title": "My Adoption Requests",
  "description": "Track the status of your adoption processes and respond to information requests.",
  "empty": {
    "title": "You don't have any adoption requests",
    "description": "Explore available animals and create your first request.",
    "button": "Explore Animals"
  },
  "status": {
    "pending": "Pending",
    "in_review": "In Review",
    "info_requested": "Info Requested",
    "preapproved": "Preapproved",
    "approved": "Approved",
    "rejected": "Rejected",
    "cancelled": "Cancelled",
    "completed": "Completed"
  },
  "species": {
    "dog": "Dog",
    "cat": "Cat"
  },
  "actions": {
    "respond": "Respond",
    "view": "View Detail"
  },
  "requestedOn": "Requested on {{date}}",
  "infoSection": {
    "title": "Do you have questions about your process?",
    "description": "Our support team and foundations are here to help you every step of the way.",
    "button": "Contact Support"
  },
  "errors": {
    "unauthorized": "Unauthorized",
    "generic": "Error loading your requests"
  }
}
```

---

## Implementación sugerida

### 1. Crear el Use Case
- Crear `GetUserAdoptionRequestsUseCase` en `src/domain/usecases/adopt/`
- Agregar método `getUserRequests` al repositorio
- Implementar en `AdoptionRequestRepository`

### 2. Crear la página
- Crear `/[locale]/account/adoptions/page.tsx`
- Crear componente `MyAdoptionsPage`
- Crear componente `AdoptionRequestCard` para cada solicitud
- Crear componente `EmptyState` para cuando no hay solicitudes

### 3. Registrar en IoC
- Agregar `GetUserAdoptionRequestsUseCase` a `usecases.types.ts`
- Registrar en `usecases.container.ts`

### 4. Agregar traducciones
- Crear `my-adoptions.json` en `src/messages/es/` y `src/messages/en/`

### 5. Navegación
- Agregar enlace a "Mis Adopciones" en el menú de cuenta del usuario externo

---

## Validación

Comandos mínimos:
- `npm run dev` (verificar que la página carga y muestra solicitudes)
- `npm run build` (verificar que no hay errores de compilación)

Pruebas manuales:
1. Iniciar sesión como usuario externo
2. Navegar a `/account/adoptions`
3. Verificar que se muestran todas las solicitudes del usuario
4. Verificar que los badges de estado tienen los colores correctos
5. Verificar que el botón "Responder" aparece solo para `info_requested`
6. Verificar que la navegación funciona correctamente
7. Verificar traducciones (cambiar idioma)

---

## Definición de Hecho

- [ ] Criterios de aceptación cumplidos
- [ ] `npm run dev` OK
- [ ] `npm run build` OK
- [ ] Sin violaciones de capas
- [ ] Sin cambios fuera del alcance
- [ ] **Traducciones incluidas**:
  - [ ] Textos agregados en `src/messages/es/my-adoptions.json`
  - [ ] Textos agregados en `src/messages/en/my-adoptions.json`
  - [ ] Componentes usan `useTranslations` (no textos hardcodeados)
- [ ] Pruebas manuales realizadas:
  - [ ] Listado muestra solicitudes correctamente
  - [ ] Badges de estado funcionan
  - [ ] Botón "Responder" aparece solo cuando corresponde
  - [ ] Navegación funciona
- [ ] Use Case registrado en IoC
- Commit sugerido:
  `feat: implementar sección mis adopciones para usuarios externos (HU-059)`
