# HU-060 — Respuesta a solicitudes de información adicional

**Como** usuario externo (adoptante)  
**Quiero** poder responder a solicitudes de información adicional de la fundación  
**Para** proporcionar los datos necesarios y continuar con mi proceso de adopción

---

## Dependencias

- HU-001 (Next.js App Router)
- HU-011 (Conexión a Supabase configurada)
- HU-016 (Sistema de traducciones configurado)
- HU-036 (Flujo de solicitud de adopción implementado)
- HU-037 (Gestión de solicitudes de adopción)
- HU-048 (Solicitar información adicional al adoptante vía correo)
- HU-059 (Sección "Mis Adopciones" para usuarios externos)

---

## Contexto / Notas

- Esta HU implementa la funcionalidad de respuesta a solicitudes de información adicional.
- Cuando una fundación solicita información adicional (HU-048), el adoptante debe poder responder.
- Diseño disponible en:
  - `docs/design/answer_request_screen.png`
  - `docs/design/answer_request_code.html`
- El flujo es:
  1. La fundación envía un correo solicitando información (HU-048)
  2. El status de la solicitud cambia a `info_requested`
  3. El adoptante ve la solicitud en "Mis Adopciones" (HU-059) con botón "Responder"
  4. El adoptante hace clic en "Responder" y accede a la página de respuesta
  5. El adoptante puede:
     - Ver el mensaje de la fundación (si está almacenado)
     - Escribir un mensaje de respuesta
     - Subir archivos (fotos, videos, documentos)
  6. Al enviar, se actualiza la solicitud y se notifica a la fundación
- **Almacenamiento de mensajes**: 
  - Opción 1: Crear tabla `adoption_request_messages` para historial de mensajes
  - Opción 2: Usar el campo `rejection_reason` o crear un campo `notes` en `adoption_requests`
  - Opción 3: Almacenar en `adoption_request_documents` con un tipo especial
  - **Recomendación**: Crear tabla `adoption_request_messages` para mantener historial completo
- **Archivos adjuntos**: Se almacenan en `adoption_request_documents` con `doc_type = 'response'` o similar
- **Notificación**: Al enviar la respuesta, se debe:
  - Actualizar el status de la solicitud (¿a qué estado? `in_review` o mantener `info_requested`?)
  - Crear notificación in-app para los miembros de la fundación
  - Opcional: Encolar correo a la fundación
- **Estado después de responder**: Se recomienda cambiar a `in_review` para indicar que la fundación debe revisar la nueva información

---

## Diseño (OBLIGATORIO)

Referencias:
- Diseño: `docs/design/answer_request_code.html`
- Imagen: `docs/design/answer_request_screen.png`
- Design System: `docs/design/system.md`

Reglas:
- Respetar jerarquía visual y estilos del diseño.
- Layout con:
  - Breadcrumbs en la parte superior
  - Título y descripción
  - Grid de 2 columnas (formulario a la izquierda, información del animal a la derecha)
  - Sección de mensaje de la fundación (si existe)
  - Formulario de respuesta con:
    - Campo de mensaje (textarea)
    - Zona de arrastrar y soltar archivos
    - Lista de archivos adjuntos
    - Botones de acción (Cancelar, Enviar Respuesta)
  - Card lateral con:
    - Foto del animal
    - Nombre y especie
    - Estado de la solicitud
    - Barra de progreso del proceso
    - Lista de pasos completados
- Los textos deben estar traducidos (ES/EN).

---

## Alcance

Incluye:
- Crear ruta: `/[locale]/account/adoptions/[id]/respond`
- Crear componente `AnswerRequestPage` que muestre el formulario de respuesta
- Crear Use Case `RespondToInfoRequestUseCase` que:
  - Valide que el usuario es el adoptante de la solicitud
  - Obtenga los detalles de la solicitud (incluyendo mensaje de la fundación si existe)
  - Permita enviar respuesta con mensaje y archivos
  - Almacene el mensaje en `adoption_request_messages` (o alternativa)
  - Almacene los archivos en `adoption_request_documents` con tipo `response`
  - Actualice el status de la solicitud a `in_review`
  - Cree notificaciones para los miembros de la fundación
- Mostrar mensaje de la fundación (si existe) en una sección destacada
- Subida de archivos con drag & drop
- Preview de archivos antes de enviar
- Validación de tipos de archivo y tamaño
- Estados de loading y error
- Traducciones completas (ES/EN)
- Card lateral con información del animal y progreso

No incluye:
- Sistema de mensajería bidireccional completo (solo respuesta a solicitud de info)
- Edición de respuestas ya enviadas
- Eliminación de archivos después de enviar
- Notificaciones por correo (solo in-app, aunque se puede encolar si ya existe la infraestructura)

---

## Criterios de aceptación (Given / When / Then)

### 1) Acceso a la página de respuesta

- **Dado** que un usuario externo tiene una solicitud con estado `info_requested`
- **Cuando** hace clic en "Responder" en "Mis Adopciones"
- **Entonces** navega a `/account/adoptions/[id]/respond`
- **Y** ve el formulario de respuesta con información del animal

### 2) Visualización del mensaje de la fundación

- **Dado** que la fundación envió un mensaje solicitando información
- **Cuando** el adoptante accede a la página de respuesta
- **Entonces** se muestra el mensaje de la fundación en una sección destacada
- **Y** el mensaje está formateado correctamente

### 3) Envío de respuesta con mensaje

- **Dado** que el formulario está abierto
- **Cuando** el adoptante escribe un mensaje y hace clic en "Enviar Respuesta"
- **Entonces** se valida que el mensaje no esté vacío
- **Y** se almacena el mensaje en la base de datos
- **Y** se actualiza el status de la solicitud a `in_review`
- **Y** se crean notificaciones para los miembros de la fundación
- **Y** se muestra un mensaje de éxito
- **Y** se redirige a "Mis Adopciones"

### 4) Envío de respuesta con archivos

- **Dado** que el formulario está abierto
- **Cuando** el adoptante sube archivos (fotos, videos, documentos) y envía
- **Entonces** se validan los tipos de archivo (MP4, JPG, PNG, PDF)
- **Y** se valida el tamaño máximo (50MB por archivo)
- **Y** se suben los archivos a Supabase Storage
- **Y** se almacenan referencias en `adoption_request_documents` con tipo `response`
- **Y** se envía la respuesta correctamente

### 5) Subida de archivos con drag & drop

- **Dado** que el formulario está abierto
- **Cuando** el adoptante arrastra archivos a la zona de drop
- **Entonces** se muestran los archivos en la lista de adjuntos
- **Y** se muestra un preview o nombre del archivo
- **Y** se puede eliminar un archivo antes de enviar

### 6) Validación de permisos

- **Dado** que un usuario intenta responder a una solicitud que no es suya
- **Cuando** accede a `/account/adoptions/[id]/respond`
- **Entonces** se muestra un error de autorización
- **Y** no se permite enviar la respuesta

### 7) Validación de estado

- **Dado** que una solicitud no está en estado `info_requested`
- **Cuando** el usuario intenta acceder a la página de respuesta
- **Entonces** se muestra un mensaje indicando que no puede responder
- **Y** se redirige a "Mis Adopciones"

### 8) Card lateral con información del animal

- **Dado** que la página de respuesta está abierta
- **Cuando** se carga la información
- **Entonces** se muestra en el card lateral:
  - Foto del animal
  - Nombre y especie
  - Estado actual de la solicitud
  - Barra de progreso del proceso
  - Lista de pasos completados

### 9) Estados de loading y error

- **Dado** que se está enviando la respuesta
- **Cuando** la operación está en progreso
- **Entonces** se muestra un indicador de carga
- **Y** los botones están deshabilitados
- **Y** si hay error, se muestra un mensaje de error traducido

### 10) Traducciones

- **Dado** que la UI está implementada
- **Cuando** se revisa el código
- **Entonces** no hay textos hardcodeados
- **Y** existen traducciones en `src/messages/es/answer-request.json` y `src/messages/en/answer-request.json`

---

## Reglas técnicas

### Arquitectura
- Presentation solo consume UseCases vía IoC (no importa repositorios concretos).
- Domain no importa React/Next/MUI/Tailwind/Inversify/Supabase.
- Infrastructure contiene implementaciones y wiring IoC.
- El Use Case debe validar que el usuario es el adoptante antes de permitir la respuesta.

### Estructura de base de datos

**Opción recomendada: Crear tabla `adoption_request_messages`**

```sql
create table adoption_request_messages (
  id bigint primary key generated always as identity,
  request_id bigint not null references adoption_requests(id) on delete cascade,
  
  -- Quién envió el mensaje
  sender_user_id uuid not null references profiles(id) on delete cascade,
  sender_role text not null check (sender_role in ('foundation', 'adopter')),
  
  -- Contenido
  message_text text not null,
  
  -- Auditoría
  created_at timestamptz not null default now()
);

create index adoption_request_messages_request_idx on adoption_request_messages(request_id);
create index adoption_request_messages_created_idx on adoption_request_messages(created_at desc);
```

**Para archivos de respuesta:**
- Usar `adoption_request_documents` con `doc_type = 'response'` o crear nuevo tipo
- O agregar campo `message_id` a `adoption_request_documents` para relacionar con el mensaje

### Estructura del Use Case

```typescript
// domain/usecases/adopt/RespondToInfoRequestUseCase.ts
import type { IAdoptionRequestRepository } from "@/domain/repositories/IAdoptionRequestRepository";
import type { IAuthRepository } from "@/domain/repositories/IAuthRepository";
import type { IPrivateFileStorage } from "@/domain/repositories/IPrivateFileStorage";

export interface RespondToInfoRequestInput {
  requestId: number;
  message: string;
  files?: File[];
}

export class RespondToInfoRequestUseCase {
  constructor(
    private readonly adoptionRequestRepository: IAdoptionRequestRepository,
    private readonly authRepository: IAuthRepository,
    private readonly fileStorage: IPrivateFileStorage,
  ) {}

  async execute(input: RespondToInfoRequestInput): Promise<void> {
    // 1. Validar sesión
    const session = await this.authRepository.getSession();
    if (!session?.user?.id) {
      throw new Error("errors.unauthorized");
    }

    // 2. Obtener información de acceso de la solicitud
    const accessInfo = await this.adoptionRequestRepository.getRequestAccessInfo({
      requestId: input.requestId,
    });

    // 3. Validar que el usuario es el adoptante
    if (accessInfo.adopterUserId !== session.user.id) {
      throw new Error("errors.unauthorized");
    }

    // 4. Validar que el estado es info_requested
    const detail = await this.adoptionRequestRepository.getRequestDetail({
      foundationId: accessInfo.foundationId,
      requestId: input.requestId,
    });

    if (detail.status !== "info_requested") {
      throw new Error("errors.invalidStatus");
    }

    // 5. Validar mensaje
    if (!input.message.trim()) {
      throw new Error("errors.messageRequired");
    }

    // 6. Subir archivos si existen
    const fileUrls: string[] = [];
    if (input.files && input.files.length > 0) {
      for (const file of input.files) {
        // Validar tipo y tamaño
        // Subir a Supabase Storage
        const url = await this.fileStorage.uploadFile({
          file,
          folder: `adoption-requests/${input.requestId}/responses`,
        });
        fileUrls.push(url);
      }
    }

    // 7. Almacenar mensaje
    await this.adoptionRequestRepository.saveResponseMessage({
      requestId: input.requestId,
      senderUserId: session.user.id,
      senderRole: "adopter",
      messageText: input.message,
      fileUrls,
    });

    // 8. Actualizar status a in_review
    await this.adoptionRequestRepository.updateStatus({
      foundationId: accessInfo.foundationId,
      requestId: input.requestId,
      status: "in_review",
    });

    // 9. Crear notificaciones para miembros de la fundación
    // (esto se puede hacer en un trigger o aquí)
  }
}
```

### Actualización del Repositorio

```typescript
// domain/repositories/IAdoptionRequestRepository.ts
// Agregar métodos:

export interface SaveResponseMessageParams {
  requestId: number;
  senderUserId: string;
  senderRole: 'foundation' | 'adopter';
  messageText: string;
  fileUrls: string[];
}

export interface GetRequestMessagesParams {
  requestId: number;
}

export interface RequestMessage {
  id: number;
  senderUserId: string;
  senderRole: 'foundation' | 'adopter';
  messageText: string;
  createdAt: string;
  files: Array<{
    id: number;
    fileUrl: string;
    docType: string;
  }>;
}

export interface IAdoptionRequestRepository {
  // ... métodos existentes
  saveResponseMessage(params: SaveResponseMessageParams): Promise<void>;
  getRequestMessages(params: GetRequestMessagesParams): Promise<RequestMessage[]>;
}
```

### Implementación en el Repositorio

```typescript
// infrastructure/repositories/AdoptionRequestRepository.ts
async saveResponseMessage(params: SaveResponseMessageParams): Promise<void> {
  // 1. Insertar mensaje
  const { data: message, error: messageError } = await supabaseClient
    .from("adoption_request_messages")
    .insert({
      request_id: params.requestId,
      sender_user_id: params.senderUserId,
      sender_role: params.senderRole,
      message_text: params.messageText,
    })
    .select()
    .single();

  if (messageError) {
    throw new Error(this.translateAdoptionError(messageError));
  }

  // 2. Insertar documentos si existen
  if (params.fileUrls.length > 0) {
    const documents = params.fileUrls.map((url) => ({
      request_id: params.requestId,
      doc_type: "response",
      file_url: url,
      notes: `Response message ID: ${message.id}`,
    }));

    const { error: docsError } = await supabaseClient
      .from("adoption_request_documents")
      .insert(documents);

    if (docsError) {
      throw new Error(this.translateAdoptionError(docsError));
    }
  }
}

async getRequestMessages(params: GetRequestMessagesParams): Promise<RequestMessage[]> {
  const { data, error } = await supabaseClient
    .from("adoption_request_messages")
    .select(
      `id,
      sender_user_id,
      sender_role,
      message_text,
      created_at,
      adoption_request_documents!inner (
        id,
        file_url,
        doc_type
      )`
    )
    .eq("request_id", params.requestId)
    .order("created_at", { ascending: true });

  if (error) {
    throw new Error(this.translateAdoptionError(error));
  }

  // Agrupar documentos por mensaje (si se relacionan)
  // Por simplicidad, retornar todos los mensajes con sus documentos
  return (data ?? []).map((row) => ({
    id: row.id,
    senderUserId: row.sender_user_id,
    senderRole: row.sender_role as 'foundation' | 'adopter',
    messageText: row.message_text,
    createdAt: row.created_at,
    files: row.adoption_request_documents?.map((doc: any) => ({
      id: doc.id,
      fileUrl: doc.file_url,
      docType: doc.doc_type,
    })) ?? [],
  }));
}
```

### Estructura de archivos sugerida

```
src/app/[locale]/account/adoptions/[id]/respond/page.tsx

src/presentation/components/answer-request/
├── AnswerRequestPage.tsx
├── FoundationMessageSection.tsx
├── ResponseForm.tsx
├── FileUploadZone.tsx
├── AnimalInfoCard.tsx
└── ProgressBar.tsx

src/domain/
├── models/
│   └── AdoptionRequest.ts (extender con RequestMessage si es necesario)
├── repositories/
│   └── IAdoptionRequestRepository.ts (agregar saveResponseMessage, getRequestMessages)
└── usecases/
    └── adopt/
        ├── GetRequestInfoForResponseUseCase.ts (obtener info de la solicitud y mensaje de fundación)
        └── RespondToInfoRequestUseCase.ts

src/infrastructure/
├── repositories/
│   └── AdoptionRequestRepository.ts (implementar nuevos métodos)
└── ioc/
    └── bindings actualizados

src/messages/
├── es/
│   └── answer-request.json
└── en/
    └── answer-request.json
```

### Traducciones (OBLIGATORIO)

```json
// src/messages/es/answer-request.json
{
  "title": "Responder Solicitud de Información",
  "description": "Por favor, completa los detalles solicitados por la fundación para continuar con tu proceso.",
  "breadcrumbs": {
    "home": "Inicio",
    "myAdoptions": "Mis Solicitudes"
  },
  "foundationMessage": {
    "title": "Mensaje de la Fundación",
    "label": "Mensaje de {{foundationName}}"
  },
  "form": {
    "message": {
      "label": "Tu Mensaje o Explicación",
      "placeholder": "Escribe aquí tu respuesta para la fundación..."
    },
    "files": {
      "label": "Archivos Adjuntos (Video o Fotos)",
      "dropzone": {
        "title": "Haz clic o arrastra los archivos aquí",
        "description": "Soporta MP4, JPG, PNG o PDF (Máx. 50MB)"
      }
    },
    "cancel": "Cancelar",
    "submit": "Enviar Respuesta"
  },
  "animalCard": {
    "title": "Respondiendo por:",
    "viewProfile": "Ver Perfil del Animal"
  },
  "progress": {
    "title": "Progreso de Adopción",
    "step": "Paso {{current}} de {{total}}",
    "percentage": "{{percentage}}%",
    "steps": {
      "initial": "Solicitud Inicial",
      "interview": "Entrevista Telefónica",
      "additionalInfo": "Información Adicional",
      "homeVisit": "Visita Domiciliaria",
      "approval": "Aprobación Final"
    }
  },
  "errors": {
    "unauthorized": "No autorizado",
    "invalidStatus": "Esta solicitud no requiere respuesta en este momento",
    "messageRequired": "El mensaje es requerido",
    "fileTooLarge": "El archivo es demasiado grande (máx. 50MB)",
    "invalidFileType": "Tipo de archivo no permitido",
    "uploadFailed": "Error al subir archivos",
    "submitFailed": "Error al enviar la respuesta"
  },
  "success": {
    "title": "Respuesta enviada",
    "message": "Tu respuesta ha sido enviada exitosamente. La fundación será notificada."
  }
}
```

```json
// src/messages/en/answer-request.json
{
  "title": "Respond to Information Request",
  "description": "Please complete the details requested by the foundation to continue with your process.",
  "breadcrumbs": {
    "home": "Home",
    "myAdoptions": "My Requests"
  },
  "foundationMessage": {
    "title": "Foundation Message",
    "label": "Message from {{foundationName}}"
  },
  "form": {
    "message": {
      "label": "Your Message or Explanation",
      "placeholder": "Write your response to the foundation here..."
    },
    "files": {
      "label": "Attached Files (Video or Photos)",
      "dropzone": {
        "title": "Click or drag files here",
        "description": "Supports MP4, JPG, PNG or PDF (Max. 50MB)"
      }
    },
    "cancel": "Cancel",
    "submit": "Send Response"
  },
  "animalCard": {
    "title": "Responding for:",
    "viewProfile": "View Animal Profile"
  },
  "progress": {
    "title": "Adoption Progress",
    "step": "Step {{current}} of {{total}}",
    "percentage": "{{percentage}}%",
    "steps": {
      "initial": "Initial Request",
      "interview": "Phone Interview",
      "additionalInfo": "Additional Information",
      "homeVisit": "Home Visit",
      "approval": "Final Approval"
    }
  },
  "errors": {
    "unauthorized": "Unauthorized",
    "invalidStatus": "This request does not require a response at this time",
    "messageRequired": "Message is required",
    "fileTooLarge": "File is too large (max. 50MB)",
    "invalidFileType": "File type not allowed",
    "uploadFailed": "Error uploading files",
    "submitFailed": "Error sending response"
  },
  "success": {
    "title": "Response sent",
    "message": "Your response has been sent successfully. The foundation will be notified."
  }
}
```

---

## Implementación sugerida

### 1. Crear tabla de mensajes (migración SQL)
- Agregar `adoption_request_messages` a `db.sql` o crear migración separada
- Agregar índices necesarios

### 2. Crear los Use Cases
- Crear `GetRequestInfoForResponseUseCase` para obtener info de la solicitud y mensaje de fundación
- Crear `RespondToInfoRequestUseCase` para enviar la respuesta
- Agregar métodos al repositorio: `saveResponseMessage`, `getRequestMessages`

### 3. Crear la página y componentes
- Crear `/[locale]/account/adoptions/[id]/respond/page.tsx`
- Crear componentes: `AnswerRequestPage`, `FoundationMessageSection`, `ResponseForm`, `FileUploadZone`, `AnimalInfoCard`, `ProgressBar`

### 4. Registrar en IoC
- Agregar Use Cases a `usecases.types.ts`
- Registrar en `usecases.container.ts`

### 5. Agregar traducciones
- Crear `answer-request.json` en `src/messages/es/` y `src/messages/en/`

### 6. Notificaciones
- Crear notificaciones para miembros de fundación cuando se envía respuesta
- Esto se puede hacer en un trigger de PostgreSQL o en el Use Case

---

## Validación

Comandos mínimos:
- `npm run dev` (verificar que la página carga y funciona)
- `npm run build` (verificar que no hay errores de compilación)

Pruebas manuales:
1. Tener una solicitud con estado `info_requested`
2. Navegar a la página de respuesta desde "Mis Adopciones"
3. Verificar que se muestra el mensaje de la fundación (si existe)
4. Escribir un mensaje y subir archivos
5. Enviar la respuesta
6. Verificar que el status cambia a `in_review`
7. Verificar que se crean notificaciones para la fundación
8. Verificar que los archivos se suben correctamente
9. Verificar traducciones (cambiar idioma)

---

## Definición de Hecho

- [ ] Criterios de aceptación cumplidos
- [ ] `npm run dev` OK
- [ ] `npm run build` OK
- [ ] Sin violaciones de capas
- [ ] Sin cambios fuera del alcance
- [ ] **Tabla de mensajes creada**:
  - [ ] Tabla `adoption_request_messages` en base de datos
  - [ ] Índices creados
- [ ] **Traducciones incluidas**:
  - [ ] Textos agregados en `src/messages/es/answer-request.json`
  - [ ] Textos agregados en `src/messages/en/answer-request.json`
  - [ ] Componentes usan `useTranslations` (no textos hardcodeados)
- [ ] Pruebas manuales realizadas:
  - [ ] Formulario funciona correctamente
  - [ ] Subida de archivos funciona
  - [ ] Status se actualiza correctamente
  - [ ] Notificaciones se crean
  - [ ] Validaciones funcionan
- [ ] Use Cases registrados en IoC
- Commit sugerido:
  `feat: implementar respuesta a solicitudes de información (HU-060)`
