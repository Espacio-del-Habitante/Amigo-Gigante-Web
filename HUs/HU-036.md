# HU-036 — Modal de Adopción + Formulario Multi‑paso + Contacto (UI + Supabase)

**Como** usuario externo  
**Quiero** iniciar el proceso de adopción desde un modal  
**Para** contactar la fundación o diligenciar la solicitud de adopción

---

## Dependencias

- HU-001 (Next.js App Router)
- HU-007 (Tailwind configurado)
- HU-010 (Atomic Design - componentes reutilizables)
- HU-011 (Conexión a Supabase configurada)
- HU-016 (Sistema de traducciones configurado)
- HU-026 (Catálogo de adopción implementado)
- HU-027 (Detalle de animal implementado)

---

## Contexto / Notas

- Esta HU agrega un **modal de adopción** desde el detalle del animal.
- El modal ofrece dos flujos:
  1) **Contactar fundación** (pantalla de contacto)
  2) **Diligenciar formulario** (formulario multi‑paso)
- Diseños:
  - Modal: `docs/design/modal_adopt_code.html` + `docs/design/modal_adopt_screen.png`
  - Formulario: `docs/design/form_adopt_code1.html`, `form_adopt_code2.html`,
    `form_adopt_code3.html`, `form_adopt_code4.html` + screens
  - Contacto: `docs/design/contact_us_code.html` + `docs/design/contact_us_screen.png`
- La funcionalidad debe usar el modelo relacional de `docs/scripts/db.sql`.

Modelo de datos disponible:
- `adoption_requests`
- `adoption_request_details`
- `adoption_request_documents`
- `foundation_contacts`
- `animals`

---

## Diseño (OBLIGATORIO)

Referencias:
- Modal: `docs/design/modal_adopt_code.html`
- Contacto: `docs/design/contact_us_code.html`
- Formulario pasos 1–4:
  - `docs/design/form_adopt_code1.html`
  - `docs/design/form_adopt_code2.html`
  - `docs/design/form_adopt_code3.html`
  - `docs/design/form_adopt_code4.html`
- Imágenes: `docs/design/modal_adopt_screen.png`, `form_adopt_screen1.png`,
  `form_adopt_screen2.png`, `form_adopt_screen3.png`, `form_adopt_screen4.png`,
  `contact_us_screen.png`
- Design System: `docs/design/system.md`
- Esquema BD: `docs/scripts/db.sql`

Reglas:
- Respetar jerarquía visual y estilos del diseño.
- Layout responsive.
- No inventar datos que no existan en BD.

---

## Alcance

Incluye:
- Modal de adopción desde el detalle del animal (HU-027)
- Dos flujos desde el modal:
  - Contactar fundación (info desde `foundation_contacts`)
  - Diligenciar formulario multi‑paso
- Formulario multi‑paso con guardado en BD:
  - Paso 1: datos básicos (detalle)
  - Paso 2: hogar
  - Paso 3: estilo/experiencia
  - Paso 4: documentos + consentimientos
- Crear solicitud en `adoption_requests`
- Guardar detalle en `adoption_request_details`
- Subir documentos y guardar en `adoption_request_documents`
- Estados de loading y error
- Traducciones completas (ES/EN)

No incluye:
- Flujo de aprobación/revisión por fundación
- Tests automatizados

---

## Criterios de aceptación (Given / When / Then)

### 1) Modal desde el detalle
- **Dado** el detalle de un animal
- **Cuando** hago clic en “Adoptar”
- **Entonces** se abre el modal con opciones de flujo

### 2) Flujo de contacto
- **Dado** que selecciono “Contactar fundación”
- **Cuando** se abre el panel de contacto
- **Entonces** se muestran los datos de `foundation_contacts`

### 3) Flujo de formulario
- **Dado** que selecciono “Diligenciar formulario”
- **Cuando** se muestra el formulario
- **Entonces** veo los 4 pasos según diseño

### 4) Guardado de solicitud
- **Dado** un usuario autenticado y un animal válido
- **Cuando** finalizo el formulario
- **Entonces** se crea un registro en `adoption_requests`
- **Y** se crea `adoption_request_details` asociado
- **Y** el estado inicial es `pending`

### 5) Documentos
- **Dado** que subo documento de identidad y fotos del hogar
- **Cuando** envío la solicitud
- **Entonces** se suben archivos y se guardan en `adoption_request_documents`

### 6) Validaciones mínimas
- **Dado** campos obligatorios
- **Cuando** faltan datos requeridos
- **Entonces** el usuario no puede avanzar de paso

### 7) Manejo de errores
- **Dado** un error de Supabase
- **Cuando** ocurre al guardar
- **Entonces** se muestra un mensaje traducido
- **Y** la UI no se rompe

### 8) Traducciones
- **Dado** la implementación
- **Cuando** se revisa la UI
- **Entonces** no hay textos hardcodeados
- **Y** existen traducciones en `src/messages/es/adopt-request.json` y `src/messages/en/adopt-request.json`

---

## Reglas técnicas

### Arquitectura
- Presentation solo consume UseCases vía IoC.
- Domain no importa React/Next/MUI/Tailwind/Inversify/Supabase.
- Infrastructure contiene implementaciones y wiring IoC.
- Supabase solo vive en Infrastructure.

### Supabase / Queries
- Crear solicitud:
  - Insert en `adoption_requests` con:
    - `animal_id`, `foundation_id`, `adopter_user_id`
  - Estado por defecto: `pending`
- Detalle:
  - Insert en `adoption_request_details` con campos del formulario.
- Contacto:
  - `SELECT * FROM foundation_contacts WHERE foundation_id = :foundation_id`
- Documentos:
  - Subir archivos a Storage y guardar `file_url` en
    `adoption_request_documents` con `doc_type`:
    - `id_document`
    - `home_photos`

### Mapeo de campos (formulario → BD)
- Paso 1 (Básico):
  - `adopter_display_name`, `adopter_email`, `adopter_phone`, `city`, `neighborhood`
- Paso 2 (Hogar):
  - `housing_type`, `is_rent`, `allows_pets`, `household_people_count`,
    `has_children`, `children_ages`
- Paso 3 (Estilo):
  - `has_other_pets`, `other_pets_description`, `hours_alone_per_day`,
    `travel_plan`, `experience_text`, `motivation_text`
- Paso 4 (Docs):
  - `accepts_vet_costs`, `accepts_lifetime_commitment`

### Autenticación
- La solicitud requiere `adopter_user_id` desde sesión actual.
- Si el usuario no está autenticado, mostrar mensaje y bloquear envío.

### Traducciones
- Usar `useTranslations('adoptRequest')`.
- No hardcodear textos.

### Dependencias / Paquetes
- No agregar dependencias nuevas.

---

## Implementación sugerida

### Estructura de archivos sugerida:
```
src/presentation/components/adopt-modal/
├── AdoptStartModal.tsx
├── AdoptContactPanel.tsx
├── AdoptFormWizard.tsx
├── AdoptStepBasic.tsx
├── AdoptStepHome.tsx
├── AdoptStepStyle.tsx
└── AdoptStepDocs.tsx

src/domain/
├── models/
│   └── AdoptionRequest.ts
├── repositories/
│   ├── IAdoptionRequestRepository.ts
│   └── IFoundationRepository.ts (extender con getFoundationContacts)
└── usecases/
    └── adopt/
        └── CreateAdoptionRequestUseCase.ts

src/infrastructure/
├── repositories/
│   ├── AdoptionRequestRepository.ts
│   └── FoundationRepository.ts
└── ioc/
    └── bindings actualizados

src/messages/
├── es/
│   └── adopt-request.json
└── en/
    └── adopt-request.json
```

---

## Validación

Comandos mínimos:
- `npm run dev`
- `npm run build`

Verificaciones:
- Modal coincide con diseño
- Flujo de contacto muestra datos reales
- Formulario guarda solicitud en BD
- Documentos guardados y relacionados
- Traducciones completas

---

## Definición de Hecho

- [ ] Criterios de aceptación cumplidos
- [ ] `npm run dev` OK
- [ ] `npm run build` OK
- [ ] Modal y formularios funcionales
- [ ] Datos reales desde Supabase
- [ ] Traducciones incluidas (ES/EN)
- [ ] Sin violaciones de capas
- [ ] Sin cambios fuera del alcance
- Commit sugerido:
  `feat: add adopt modal and request flow`

